<!DOCTYPE html>
<html lang="az">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Domino Oyunu</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/canvas-confetti/1.6.0/confetti.browser.min.js"></script>
    <link rel="stylesheet" href="./Domino.css" />
</head>

<body>
    <!-- ====== LOBBY VIEW ====== -->
    <div id="lobbyView" class="lobby-container">
        <div class="header">
            <div class="header-title">ğŸ¯ Domino Lobbies</div>
            <div class="balance">ğŸ’° <span id="userBalance">0</span> coin</div>
        </div>
        <div id="categoriesContainer"></div>
    </div>

    <!-- ====== GAME VIEW ====== -->
    <div id="gameView" class="game-container">
        <div class="game-header">
            <div style="display: flex; align-items: center; gap: 16px;">
                <div style="font-size: 18px; font-weight: 700; color: #10b981;">
                    ğŸ¯ <span id="roomName">Domino</span>
                </div>
                <span class="badge">Raund: <span id="roundNumber">1</span></span>
                <span class="badge" id="scoreDisplay">0/101</span>
                <div class="balance">ğŸ’° <span id="balance">0</span> coin</div>
            </div>
            <button id="leaveBtn" class="btn btn-danger" style="width: auto;">Ã‡Ä±x</button>
        </div>

        <div class="game-layout">
            <div class="sidebar">
                <div class="sidebar-title">ğŸ‘¥ OyunÃ§ular</div>
                <div id="playersList"></div>
            </div>

            <div>
                <div id="statusBar" class="status-bar">OyunÃ§ular gÃ¶zlÉ™nilir...</div>

                <div class="table" id="dropZone">
                    <div id="chain" class="chain">
                        <div style="color: #64748b; text-align: center;">ğŸ¯ Ä°lk daÅŸÄ± qoyun</div>
                    </div>
                </div>

                <div class="my-hand">
                    <div class="sidebar-title">âœ‹ Sizin DaÅŸlar</div>
                    <div id="myHand" class="hand-tiles">
                        <div style="color: #64748b; text-align: center; width: 100%;">
                            Oyun baÅŸlayanda daÅŸlar gÃ¶rÃ¼nÉ™cÉ™k
                        </div>
                    </div>
                </div>

                <div class="actions">
                    <button id="drawBtn" class="action-btn" disabled>ğŸ² Bazardan GÃ¶tÃ¼r</button>
                </div>
            </div>

            <div class="sidebar">
                <div class="sidebar-title">ğŸ“Š MÉ™lumat</div>
                <ul class="info-list">
                    <li class="info-item">
                        <span style="color: #94a3b8;">Masa:</span>
                        <span style="font-weight: 600;" id="chainCount">0</span>
                    </li>
                    <li class="info-item">
                        <span style="color: #94a3b8;">Bazar:</span>
                        <span style="font-weight: 600;" id="stockCount">0</span>
                    </li>
                    <li class="info-item">
                        <span style="color: #94a3b8;">Sol:</span>
                        <span style="font-weight: 600;" id="leftEnd">-</span>
                    </li>
                    <li class="info-item">
                        <span style="color: #94a3b8;">SaÄŸ:</span>
                        <span style="font-weight: 600;" id="rightEnd">-</span>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <script>


        let currentUserToken = null;
        let currentUserData = null;

        console.log('ğŸ¯ [DOMINO] Script yÃ¼klÉ™ndi');

        window.addEventListener('message', (event) => {
            console.log('ğŸ“¨ [DOMINO] Message alÄ±ndÄ±:', event.data);

            if (event.data && event.data.type === 'INIT_USER') {
                console.log('âœ… [DOMINO] INIT_USER qÉ™bul edildi');

                currentUserData = event.data.payload;
                currentUserToken = currentUserData.token;

                console.log('ğŸ‘¤ [DOMINO] User:', currentUserData.username);
                console.log('ğŸ« [DOMINO] Token:', currentUserToken ? 'VAR' : 'YOX');

                // UI-Ä± yenilÉ™
                document.getElementById('userBalance').textContent = currentUserData.balance.toFixed(2);
                document.getElementById('balance').textContent = currentUserData.balance.toFixed(2);

                console.log('ğŸš€ [DOMINO] init() Ã§aÄŸÄ±rÄ±lÄ±r...');
                // SignalR baÅŸlat
                init();
            }
        });

        // ============================================
        // getToken funksiyasÄ±nÄ± dÉ™yiÅŸdir
        // ============================================
        function getToken() {
            return currentUserToken || "";
        }

        // ============================================
        // Qalan kod eyni qalÄ±r
        // ============================================

        const urlParams = new URLSearchParams(window.location.search);
        const roomIdFromUrl = urlParams.get('roomId');

        let connection = null;
        let myHand = [];
        let chainTiles = [];
        let isMyTurn = false;
        let leftEnd = null;
        let rightEnd = null;
        let stockCount = 0;
        let currentRound = 1;
        let gameType = "";
        let scoreToWin = 101;
        let currentRoomId = null;
        let isInGame = false;
        let myUserId = null;
        let activeEmojiPopup = null;
        let draggedTile = null;

        // ... qalan bÃ¼tÃ¼n funksiyalar eyni qalÄ±r ...

        

        // ... qalan funksiyalar eyni (renderHand, renderChain vÉ™ s.) ...

        // âœ… init() funksiyasÄ±nÄ± dÉ™yiÅŸdir
        async function init() {
            console.log('ğŸš€ [DOMINO] init() baÅŸladÄ±');

            if (!currentUserToken) {
                console.error('âŒ [DOMINO] Token yoxdur!');
                return;
            }

            try {
                connection = createConnection();
                await connection.start();
                console.log("âœ… [DOMINO] SignalR connected");

                // Drop zone setup
                setupDropZone();

                if (roomIdFromUrl) {
                    await connection.invoke("ReconnectToRoom", roomIdFromUrl);
                } else {
                    showLobby();
                    await loadLobbies();
                }

                setInterval(() => {
                    if (!isInGame) {
                        loadLobbies();
                    }
                }, 3000);

            } catch (err) {
                console.error("âŒ [DOMINO] Connection error:", err);
                showToast("ServerÉ™ qoÅŸulmaq alÄ±nmadÄ±");
            }
        }

        console.log('âœ… [DOMINO] Script tam yÃ¼klÉ™ndi, postMessage gÃ¶zlÉ™nilir...');

        // const urlParams = new URLSearchParams(window.location.search);
        // const roomIdFromUrl = urlParams.get('roomId');

        // let connection = null;
        // let myHand = [];
        // let chainTiles = [];
        // let isMyTurn = false;
        // let leftEnd = null;
        // let rightEnd = null;
        // let stockCount = 0;
        // let currentRound = 1;
        // let gameType = "";
        // let scoreToWin = 101;
        // let currentRoomId = null;
        // let isInGame = false;
        // let myUserId = null;
        // let activeEmojiPopup = null;

        // // ğŸ”¥ DRAG & DROP dÉ™yiÅŸÉ™nlÉ™ri
        // let draggedTile = null;

        // function getToken() {
        //     const raw = document.cookie.split("; ").find(row => row.startsWith("AuthToken="))?.split("=")[1];
        //     if (!raw) return "";
        //     let token = decodeURIComponent(raw).trim();
        //     if (token.endsWith(".")) token = token.slice(0, -1);
        //     return token;
        // }

        function showToast(msg, success = false) {
            const toast = document.createElement('div');
            toast.className = success ? 'toast success' : 'toast';
            toast.textContent = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3500);
        }

        function showLobby() {
            document.getElementById('lobbyView').style.display = 'block';
            document.getElementById('gameView').style.display = 'none';
            isInGame = false;
        }

        function showGame() {
            document.getElementById('lobbyView').style.display = 'none';
            document.getElementById('gameView').style.display = 'block';
            isInGame = true;
        }

        function createConnection() {
            connection = new signalR.HubConnectionBuilder()
                .withUrl("https://nehemiah-paginal-alan.ngrok-free.dev/dominoHub", { accessTokenFactory: () => getToken() })
                .withAutomaticReconnect()
                .build();

            connection.on("UserData", (data) => {
                myUserId = data.userId;
                // âœ… ArtÄ±q React-dÉ™n aldÄ±q, yenidÉ™n yazmÄ±rÄ±q
                // document.getElementById('userBalance').textContent = data.balance;
                // document.getElementById('balance').textContent = data.balance;
                console.log("âœ… [DOMINO] UserData event:", data);
            });

            connection.on("UserData", (data) => {
                myUserId = data.userId;
                document.getElementById('userBalance').textContent = data.balance;
                document.getElementById('balance').textContent = data.balance;
            });

            connection.on("RedirectToLobby", (data) => {
                console.log("ğŸ“¤ RedirectToLobby:", data);
                showToast(data.message, true);

                setTimeout(() => {
                    currentRoomId = null;
                    showLobby();
                    loadLobbies();
                }, data.waitTime || 3000);
            });

            connection.on("UpdateBalance", (newBalance) => {
                console.log("ğŸ’° Balance updated:", newBalance);
                document.getElementById('userBalance').textContent = newBalance;
                document.getElementById('balance').textContent = newBalance;
            });


            connection.on("JoinedRoom", (data) => {
                console.log("âœ… JoinedRoom:", data);
                currentRoomId = data.roomId;
                document.getElementById('roomName').textContent = data.roomName;
                gameType = data.gameType;
                scoreToWin = data.scoreToWin;
                updateScoreDisplay();
                showGame();

                if (data.isGameStarted) {
                    document.getElementById('statusBar').textContent = "ğŸ® Oyun davam edir...";
                } else {
                    showToast("Room-a qoÅŸuldunuz!", true);
                }
            });

            connection.on("PlayerJoined", (data) => {
                console.log("âœ… PlayerJoined:", data);
                showToast(`${data.playerName} qoÅŸuldu (${data.currentCount}/${data.maxCount})`, true);
            });

            connection.on("PlayerLeft", (data) => {
                showToast(`${data.playerName} ayrÄ±ldÄ±`);
            });

            connection.on("PlayersList", (players) => {
                console.log("ğŸ“¥ PlayersList alÄ±ndÄ±:");
                players.forEach((p, i) => {
                    console.log(`  ${i + 1}. ${p.name}: ${p.score} xal, ${p.tileCount} daÅŸ, nÃ¶vbÉ™: ${p.isCurrentTurn}`);
                });
                renderPlayers(players);
            });

            connection.on("QuickEmoji", (data) => {
                console.log("ğŸ“© Quick emoji:", data);
                displayPlayerEmoji(data.senderName, data.emoji);
            });

            connection.on("QuickMessage", (data) => {
                console.log("ğŸ“© Quick message:", data);
                displayPlayerQuickMessage(data.senderName, data.message);
            });

            connection.on("GameStarted", (data) => {
                console.log("âœ… GameStarted:", data);
                currentRound = data.round || 1;
                document.getElementById('roundNumber').textContent = currentRound;
                document.getElementById('statusBar').textContent = data.message;
                showToast(data.message, true);
            });

            connection.on("GameState", (state) => {
                console.log("âœ… GameState:", state);
                console.log("ğŸ“Š Scores array:", state.scores); // â† BURA BAXIN!

                myHand = state.myHand;
                chainTiles = state.chainTiles;
                isMyTurn = state.isMyTurn;
                leftEnd = state.leftEnd;
                rightEnd = state.rightEnd;
                stockCount = state.stockCount;
                currentRound = state.currentRound || 1;
                gameType = state.gameType;
                scoreToWin = state.scoreToWin;

                document.getElementById('roundNumber').textContent = currentRound;

                // ğŸ”¥ ÆSAS DÃœZÆLIÅ: scores array-dÉ™n xallarÄ± yenilÉ™
                if (state.scores && state.scores.length > 0) {
                    console.log("ğŸ”„ XallarÄ± yenilÉ™yirÉ™m...");

                    const playerCards = document.querySelectorAll('.player-card');
                    playerCards.forEach((card, index) => {
                        const scoreElement = card.querySelector('.player-score');
                        if (scoreElement && state.scores[index] !== undefined) {
                            const newScore = state.scores[index];
                            console.log(`  Player ${index}: ${scoreElement.textContent} â†’ ${newScore}`);
                            scoreElement.textContent = newScore;
                        }
                    });
                }

                updateScoreDisplay();
                renderHand();
                renderChain();
                updateInfo();

                const statusBar = document.getElementById('statusBar');
                if (isMyTurn) {
                    statusBar.textContent = "ğŸ¯ Sizin nÃ¶vbÉ™nizdir!";
                    statusBar.className = "status-bar your-turn";
                } else {
                    statusBar.textContent = `â³ ${state.currentPlayerName} oynayÄ±r...`;
                    statusBar.className = "status-bar";
                }

                document.getElementById('drawBtn').disabled = !isMyTurn;
            });

            connection.on("TilePlaced", (data) => {
                if (data.earnedPoints > 0) {
                    showToast(`ğŸ”¥ ${data.playerName}: +${data.earnedPoints} xal`, true);
                }
                setTimeout(renderChain, 100);
            });

            connection.on("TileDrawn", (data) => {
                console.log("ğŸ² TileDrawn:", data);

                if (data.passed) {
                    showToast(`â­ï¸ ${data.playerName} pas keÃ§di`);
                } else if (data.foundPlayable) {
                    showToast(`ğŸ² ${data.playerName} ${data.drawnCount} daÅŸ gÃ¶tÃ¼rdÃ¼ vÉ™ oynaya bilÉ™r!`, true);
                } else {
                    showToast(`ğŸ² ${data.playerName} ${data.drawnCount} daÅŸ gÃ¶tÃ¼rdÃ¼ amma oynaya bilmÉ™di`);
                }
            });

            connection.on("RoundFinished", (data) => {
                const statusBar = document.getElementById('statusBar');
                statusBar.className = "status-bar";
                statusBar.textContent = `ğŸ† ${data.winnerName} raund ${data.round}-u qazandÄ±! (+${data.pointsEarned} xal)`;

                confetti({ particleCount: 100, spread: 60, origin: { y: 0.6 } });

                let msg = `ğŸ† Raund ${data.round} bitdi!\n\n${data.winnerName}: +${data.pointsEarned} xal\nCÉ™mi xal: ${data.currentScore}/${scoreToWin}\n\n`;
                msg += "ğŸ“Š NÉ™ticÉ™lÉ™r:\n\n";
                data.allPlayerHands.forEach(ph => {
                    const icon = ph.isWinner ? 'ğŸ†' : 'âŒ';
                    msg += `${icon} ${ph.name}: ${ph.handValue} xal\n   ${ph.tiles.join(' ')}\n\n`;
                });

                setTimeout(() => alert(msg), 1000);
            });

            connection.on("NewRoundStarted", (data) => {
                currentRound = data.round;
                document.getElementById('roundNumber').textContent = currentRound;
                showToast(data.message, true);
            });

            connection.on("GameFinished", (data) => {
                const statusBar = document.getElementById('statusBar');
                statusBar.textContent = data.message;
                statusBar.className = "status-bar";

                confetti({ particleCount: 300, spread: 100, origin: { y: 0.6 } });
                setTimeout(() => confetti({ particleCount: 200, spread: 80 }), 300);

                let finalMsg = `${data.message}\n\nMÃ¼kafat: ${data.reward} coin\n`;
                if (data.platformFee) {
                    finalMsg += `Platform haqqÄ±: ${data.platformFee} coin\n`;
                }
                finalMsg += `\nFinal:\n`;
                data.allScores.forEach(s => {
                    finalMsg += `${s.name || s.team}: ${s.score} xal\n`;
                });

                setTimeout(() => {
                    alert(finalMsg);
                    currentRoomId = null;
                    showLobby();
                    loadLobbies();
                }, 1500);
            });

            connection.on("RoomClosed", (msg) => {
                showToast(msg);
                setTimeout(() => {
                    currentRoomId = null;
                    showLobby();
                    loadLobbies();
                }, 2000);
            });

            connection.on("MoveError", (msg) => showToast(msg));

            return connection;
        }

        async function loadLobbies() {
            if (!connection || !isInGame) {
                try {
                    const lobbies = await connection.invoke("GetAvailableLobbies");
                    displayLobbies(lobbies);
                } catch (err) {
                    console.error("Load lobbies error:", err);
                }
            }
        }

        function displayLobbies(lobbies) {
            const container = document.getElementById('categoriesContainer');

            if (!lobbies || lobbies.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #64748b; padding: 40px;">HeÃ§ bir lobby yoxdur</div>';
                return;
            }

            const classic101 = lobbies.filter(l => l.gameType === "Classic101");
            const quick5 = lobbies.filter(l => l.gameType === "Quick5");
            const allFives = lobbies.filter(l => l.gameType === "AllFives");

            container.innerHTML = '';

            if (classic101.length > 0) {
                container.innerHTML += `
            <div style="margin-bottom: 40px;">
                <div style="font-size: 24px; font-weight: 700; margin-bottom: 20px; color: #10b981;">
                    ğŸ¯ Klassik 101
                </div>
                <div class="lobby-grid">${renderLobbies(classic101)}</div>
            </div>
        `;
            }

            if (quick5.length > 0) {
                container.innerHTML += `
            <div style="margin-bottom: 40px;">
                <div style="font-size: 24px; font-weight: 700; margin-bottom: 20px; color: #10b981;">
                    âš¡ SÃ¼rÉ™tli 5 DaÅŸ
                </div>
                <div class="lobby-grid">${renderLobbies(quick5)}</div>
            </div>
        `;
            }

            if (allFives.length > 0) {
                container.innerHTML += `
            <div style="margin-bottom: 40px;">
                <div style="font-size: 24px; font-weight: 700; margin-bottom: 20px; color: #10b981;">
                    ğŸ”¥ All Fives
                </div>
                <div class="lobby-grid">${renderLobbies(allFives)}</div>
            </div>
        `;
            }
        }

        function renderLobbies(lobbies) {
            return lobbies.map(lobby => {
                const icon = lobby.gameType === "Classic101" ? "ğŸ¯"
                    : lobby.gameType === "Quick5" ? "âš¡" : "ğŸ”¥";

                return `
            <div class="lobby-card" onclick='joinLobby(${JSON.stringify(lobby)})'>
                <div class="lobby-header">${icon} ${lobby.playerCount} NÉ™fÉ™rlik</div>
                ${lobby.waitingPlayers > 0
                        ? `<div style="background: rgba(251, 191, 36, 0.2); color: #fbbf24; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; display: inline-block; margin-bottom: 10px;">
                        â³ ${lobby.waitingPlayers} nÉ™fÉ™r gÃ¶zlÉ™yir
                       </div>`
                        : ''}
                <div style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px;">
                    <div class="info-row">
                        <span style="font-weight: 600;">HÉ™dÉ™f:</span>
                        <span style="font-weight: 700;">${lobby.scoreToWin} xal</span>
                    </div>
                    <div class="info-row">
                        <span style="font-weight: 600;">GiriÅŸ:</span>
                        <span style="font-weight: 700;">${lobby.entryFee} coin</span>
                    </div>
                </div>
                <button class="btn">QoÅŸul</button>
            </div>
        `;
            }).join('');
        }

        async function joinLobby(lobby) {
            const balance = parseInt(document.getElementById('userBalance').textContent);
            if (balance < lobby.entryFee) {
                showToast(`KifayÉ™t qÉ™dÉ™r balans yoxdur! LazÄ±m: ${lobby.entryFee} coin`);
                return;
            }

            console.log("ğŸ”„ Joining lobby:", lobby);

            try {
                const result = await connection.invoke("JoinLobby",
                    lobby.gameType,
                    lobby.playerCount,
                    lobby.scoreToWin,
                    lobby.entryFee
                );

                console.log("âœ… JoinLobby result:", result);

                if (result.success) {
                    showToast("Lobby-yÉ™ qoÅŸuldunuz!", true);
                } else {
                    showToast(result.message);
                }
            } catch (err) {
                console.error("âŒ Join lobby error:", err);
                showToast("Lobby-yÉ™ qoÅŸulmaq alÄ±nmadÄ±");
            }
        }

        function updateScoreDisplay() {
            const playersList = document.getElementById('playersList');
            if (playersList && playersList.children.length > 0) {
                const scores = Array.from(playersList.querySelectorAll('.player-score'))
                    .map(el => parseInt(el.textContent) || 0);
                const maxScore = Math.max(...scores);
                document.getElementById('scoreDisplay').textContent = `${maxScore}/${scoreToWin}`;
            } else {
                document.getElementById('scoreDisplay').textContent = `0/${scoreToWin}`;
            }
        }

        function renderPlayers(players) {
            const list = document.getElementById('playersList');
            console.log("ğŸ” renderPlayers DEBUG:");
            console.log("  Players array:", players);
            players.forEach((p, i) => {
                console.log(`  [${i}] ${p.name}: score=${p.score}, tileCount=${p.tileCount}`);
            });

            list.innerHTML = players.map((p) => {
                // ğŸ”¥ KOMANDA RÆNGLÆRINI SILMÆK
                return `
            <div class="player-card ${p.isCurrentTurn ? 'active' : ''}">
                <div class="player-name">
                    <span>${p.name}</span>
                    <span class="player-score">${p.score}</span>
                </div>
                <div style="font-size: 11px; color: #94a3b8;">ğŸ¯ ${p.tileCount} daÅŸ</div>
                <div style="margin-top: 5px; position: relative;">
                    <button onclick="togglePlayerEmojiPopup('${p.name}')"
                            style="background: rgba(16, 185, 129, 0.2); border: none; padding: 5px 10px; border-radius: 6px; cursor: pointer; font-size: 16px;">
                        ğŸ’¬
                    </button>
                </div>
            </div>
        `;
            }).join('');

            updateScoreDisplay();
        }
        function togglePlayerEmojiPopup(playerName) {
            if (activeEmojiPopup) {
                activeEmojiPopup.remove();
            }

            const popup = document.createElement('div');
            popup.className = 'emoji-popup-overlay';
            popup.innerHTML = `
        <div class="emoji-popup-content" onclick="event.stopPropagation()">
            <div class="emoji-popup-header">
                <button class="emoji-tab active" onclick="switchEmojiTab('emoji')">ğŸ˜Š Emoji</button>
                <button class="emoji-tab" onclick="switchEmojiTab('message')">ğŸ’¬ Mesaj</button>
            </div>
            <div class="emoji-popup-body" id="emojiPopupBody">
                ${renderEmojiGrid()}
            </div>
        </div>
    `;

            popup.onclick = () => {
                popup.remove();
                activeEmojiPopup = null;
            };

            document.body.appendChild(popup);
            activeEmojiPopup = popup;
        }

        function switchEmojiTab(tab) {
            const tabs = activeEmojiPopup.querySelectorAll('.emoji-tab');
            tabs.forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            const body = document.getElementById('emojiPopupBody');
            if (tab === 'emoji') {
                body.innerHTML = renderEmojiGrid();
            } else {
                body.innerHTML = renderQuickMessages();
            }
        }

        function renderEmojiGrid() {
            const emojis = ['ğŸ‘‹', 'ğŸ˜Š', 'ğŸ˜‚', 'â¤ï¸', 'ğŸ‘', 'ğŸ‘', 'ğŸ™', 'ğŸ”¥', 'âœ¨', 'ğŸ‰', 'ğŸ’¯', 'ğŸ¤”', 'ğŸ˜', 'ğŸ˜', 'ğŸ˜¢', 'ğŸ˜¡', 'ğŸ¤©', 'ğŸ¥³'];
            return `
        <div class="emoji-grid">
            ${emojis.map(emoji => `
                <button class="emoji-btn" onclick="sendQuickEmoji('${emoji}')">
                    ${emoji}
                </button>
            `).join('')}
        </div>
    `;
        }

        function renderQuickMessages() {
            const messages = [
                'Salam! ğŸ‘‹',
                'UÄŸurlar! ğŸ€',
                'YaxÅŸÄ± oyun! ğŸ¯',
                'TÉ™ÅŸÉ™kkÃ¼rlÉ™r ğŸ™',
                'GÃ¶zÉ™l hÉ™rÉ™kÉ™t! ğŸ‘',
                'Ups... ğŸ˜…',
                'DiqqÉ™tli ol! ğŸ¤”',
                'GG! ğŸŠ'
            ];
            return `
        <div class="quick-msg-list">
            ${messages.map(msg => `
                <button class="quick-msg-item" onclick="sendQuickMessage('${msg}')">
                    ${msg}
                </button>
            `).join('')}
        </div>
    `;
        }

        async function sendQuickEmoji(emoji) {
            if (!currentRoomId) {
                showToast('Oyunda deyilsiniz!');
                return;
            }

            try {
                await connection.invoke("SendQuickEmoji", currentRoomId, emoji);

                if (activeEmojiPopup) {
                    activeEmojiPopup.remove();
                    activeEmojiPopup = null;
                }
            } catch (err) {
                console.error("âŒ SendQuickEmoji error:", err);
                showToast('GÃ¶ndÉ™rilÉ™ bilmÉ™di!');
            }
        }

        async function sendQuickMessage(message) {
            if (!currentRoomId) {
                showToast('Oyunda deyilsiniz!');
                return;
            }

            try {
                await connection.invoke("SendQuickMessage", currentRoomId, message);

                if (activeEmojiPopup) {
                    activeEmojiPopup.remove();
                    activeEmojiPopup = null;
                }
            } catch (err) {
                console.error("âŒ SendQuickMessage error:", err);
                showToast('Mesaj gÃ¶ndÉ™rilÉ™ bilmÉ™di!');
            }
        }

        function displayPlayerEmoji(senderName, emoji) {
            const playerCards = document.querySelectorAll('.player-card');
            let targetCard = null;

            playerCards.forEach(card => {
                const nameSpan = card.querySelector('.player-name span');
                if (nameSpan && nameSpan.textContent === senderName) {
                    targetCard = card;
                }
            });

            if (!targetCard) return;

            const emojiDisplay = document.createElement('div');
            emojiDisplay.style.cssText = `
        position: absolute;
        top: -30px;
        left: 50%;
        transform: translateX(-50%);
        background: white;
        padding: 8px 12px;
        border-radius: 20px;
        font-size: 32px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        animation: emojiPop 2s forwards;
        z-index: 100;
    `;
            emojiDisplay.textContent = emoji;

            targetCard.style.position = 'relative';
            targetCard.appendChild(emojiDisplay);

            setTimeout(() => {
                emojiDisplay.remove();
            }, 2000);
        }

        function displayPlayerQuickMessage(senderName, message) {
            const playerCards = document.querySelectorAll('.player-card');
            let targetCard = null;

            playerCards.forEach(card => {
                const nameSpan = card.querySelector('.player-name span');
                if (nameSpan && nameSpan.textContent === senderName) {
                    targetCard = card;
                }
            });

            if (!targetCard) return;

            const messageDisplay = document.createElement('div');
            messageDisplay.style.cssText = `
        position: absolute;
        top: -40px;
        left: 50%;
        transform: translateX(-50%);
        background: white;
        padding: 10px 15px;
        border-radius: 15px;
        font-size: 13px;
        font-weight: 600;
        color: #333;
        max-width: 200px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        animation: emojiPop 3s forwards;
        z-index: 100;
    `;
            messageDisplay.textContent = message;

            targetCard.style.position = 'relative';
            targetCard.appendChild(messageDisplay);

            setTimeout(() => {
                messageDisplay.remove();
            }, 3000);
        }

        function renderDots(value) {
            if (value === 0) return '<div class="dots dots-0"></div>';
            const dots = '<div class="dot"></div>'.repeat(value);
            return `<div class="dots dots-${value}">${dots}</div>`;
        }

        function createTile(tile, isHorizontal = false) {
            const div = document.createElement('div');

            const isDouble = tile.left === tile.right;
            const shouldBeVertical = isDouble && !isHorizontal;

            div.className = `tile ${shouldBeVertical ? '' : 'horizontal'}`;
            div.innerHTML = `
        <div class="tile-half">${renderDots(tile.left)}</div>
        <div class="tile-half">${renderDots(tile.right)}</div>
    `;

            // ğŸ”¥ DRAG & DROP funksionallÄ±ÄŸÄ±
            div.setAttribute('draggable', 'true');
            div.dataset.tileId = tile.id;

            div.addEventListener('dragstart', (e) => {
                if (!isMyTurn) return;
                draggedTile = tile;
                div.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            });

            div.addEventListener('dragend', () => {
                div.classList.remove('dragging');
                draggedTile = null;
            });

            return div;
        }

        // ğŸ”¥ DROP ZONE setup
        function setupDropZone() {
            const dropZone = document.getElementById('dropZone');

            dropZone.addEventListener('dragover', (e) => {
                if (!isMyTurn || !draggedTile) return;
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                dropZone.style.borderColor = '#10b981';
            });

            dropZone.addEventListener('dragleave', () => {
                dropZone.style.borderColor = 'rgba(16, 185, 129, 0.2)';
            });

            dropZone.addEventListener('drop', async (e) => {
                e.preventDefault();
                dropZone.style.borderColor = 'rgba(16, 185, 129, 0.2)';

                if (!draggedTile || !isMyTurn) return;

                // DaÅŸÄ± masaya qoy
                await handleTilePlacement(draggedTile);
            });
        }

        async function handleTilePlacement(tile) {
            if (!canPlaceTile(tile)) {
                showToast("Bu daÅŸ qoyula bilmÉ™z!");
                return;
            }

            try {
                let side = 'right';

                if (chainTiles.length > 0) {
                    const canLeft = tile.left === leftEnd || tile.right === leftEnd;
                    const canRight = tile.left === rightEnd || tile.right === rightEnd;

                    if (canLeft && !canRight) {
                        side = 'left';
                    } else if (!canLeft && canRight) {
                        side = 'right';
                    } else if (canLeft && canRight) {
                        const userChoice = confirm(`Bu daÅŸÄ± SOLA qoymaq istÉ™yirsiniz?\n\nâœ… BÉ™li = Sola\nâŒ Xeyr = SaÄŸa`);
                        side = userChoice ? 'left' : 'right';
                    }
                }

                await connection.invoke("PlaceTile", tile.id, side);
            } catch (err) {
                console.error("âŒ PlaceTile error:", err);
                showToast("DaÅŸ qoymaq alÄ±nmadÄ±");
            }
        }

        function canPlaceTile(tile) {
            if (chainTiles.length === 0) return true;
            return tile.left === leftEnd || tile.right === leftEnd ||
                tile.left === rightEnd || tile.right === rightEnd;
        }

        function renderHand() {
            const container = document.getElementById('myHand');
            container.innerHTML = '';

            if (myHand.length === 0) {
                container.innerHTML = '<div style="color: #64748b;">DaÅŸlarÄ±nÄ±z yoxdur</div>';
                return;
            }

            myHand.forEach(tile => {
                const tileEl = createTile(tile, false);
                const playable = canPlaceTile(tile);

                if (isMyTurn) {
                    if (playable) {
                        tileEl.classList.add('playable');
                        // Klik vÉ™ ya drag - hÉ™r ikisi iÅŸlÉ™yir
                        tileEl.addEventListener('click', () => handleTilePlacement(tile));
                    } else {
                        tileEl.classList.add('not-playable');
                        tileEl.setAttribute('draggable', 'false');
                    }
                } else {
                    tileEl.setAttribute('draggable', 'false');
                }

                container.appendChild(tileEl);
            });
        }

        function renderChain() {
            const container = document.getElementById('chain');
            container.innerHTML = '';

            if (chainTiles.length === 0) {
                container.innerHTML = '<div style="color: #64748b;">ğŸ¯ Ä°lk daÅŸÄ± qoyun</div>';
                return;
            }

            chainTiles.forEach((tile, i) => {
                const isDouble = tile.left === tile.right;
                const tileEl = createTile(tile, !isDouble);
                tileEl.setAttribute('draggable', 'false');
                tileEl.style.animation = `slideDown 0.3s ease ${i * 0.05}s both`;
                container.appendChild(tileEl);
            });
        }

        function updateInfo() {
            document.getElementById('chainCount').textContent = chainTiles.length;
            document.getElementById('stockCount').textContent = stockCount;
            document.getElementById('leftEnd').textContent = leftEnd !== null ? leftEnd : '-';
            document.getElementById('rightEnd').textContent = rightEnd !== null ? rightEnd : '-';
        }

        document.getElementById('drawBtn').addEventListener('click', async () => {
            try {
                await connection.invoke("TakeFromStock");
            } catch (err) {
                showToast("Bazardan gÃ¶tÃ¼rmÉ™k alÄ±nmadÄ±");
            }
        });

        document.getElementById('leaveBtn').addEventListener('click', async () => {
            if (confirm("Oyunu tÉ™rk etmÉ™k istÉ™diyinizdÉ™n É™minsiniz?")) {
                if (connection && currentRoomId) {
                    await connection.invoke("LeaveRoom").catch(() => { });
                }
                currentRoomId = null;
                showLobby();
                loadLobbies();
            }
        });

        // async function init() {
        //     try {
        //         connection = createConnection();
        //         await connection.start();
        //         console.log("âœ… SignalR connected");

        //         // Drop zone setup
        //         setupDropZone();

        //         if (roomIdFromUrl) {
        //             await connection.invoke("ReconnectToRoom", roomIdFromUrl);
        //         } else {
        //             showLobby();
        //             await loadLobbies();
        //         }

        //         setInterval(() => {
        //             if (!isInGame) {
        //                 loadLobbies();
        //             }
        //         }, 3000);

        //     } catch (err) {
        //         console.error("âŒ Connection error:", err);
        //         showToast("ServerÉ™ qoÅŸulmaq alÄ±nmadÄ±");
        //     }
        // }

        // init();
    </script>
</body>

</html>