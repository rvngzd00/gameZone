<!DOCTYPE html>
<html lang="az">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>10 Line Loto - Otaqlar</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
    <link rel="stylesheet" href="LotoLobby.css" />
</head>

<body>
    <div class="header">
        <h1>ğŸ² 10 LINE LOTO</h1>
        <div class="balance-display">
            ğŸ’° <span id="userBalance">0</span> â‚¼
        </div>
    </div>

    <div id="roomsContainer" class="rooms-container">
        <div class="loading pulse">Otaqlar yÃ¼klÉ™nir...</div>
    </div>

    <!-- <script>
    // ============================================
    // React-dÉ™n user data
    // ============================================
    let currentUserToken = null;
    let currentUserData = null;
    let connection = null;
    let userBalance = 0;
    let updateInterval = null;

    console.log('ğŸ° [LOBBY] Script yÃ¼klÉ™ndi');

    window.addEventListener('message', (event) => {
        console.log('ğŸ“¨ [LOBBY] Message alÄ±ndÄ±:', event.data);

        if (event.data && event.data.type === 'INIT_USER') {
            console.log('âœ… [LOBBY] INIT_USER qÉ™bul edildi');
            console.log('ğŸ‘¤ [LOBBY] User data:', event.data.payload);
            
            currentUserData = event.data.payload;
            currentUserToken = currentUserData.token;

            console.log('ğŸ« [LOBBY] Token:', currentUserToken ? 'VAR (ilk 20 simvol): ' + currentUserToken.substring(0, 20) : 'YOX');
            console.log('ğŸ’° [LOBBY] Balance:', currentUserData.balance);

            // Balance gÃ¶stÉ™r
            document.getElementById("userBalance").textContent =
                currentUserData.balance.toFixed(2);

            console.log('ğŸš€ [LOBBY] init() Ã§aÄŸÄ±rÄ±lÄ±r...');
            // SignalR baÅŸlat
            init();
        } else {
            console.log('âš ï¸ [LOBBY] Message type INIT_USER deyil:', event.data?.type);
        }
    });

    function getToken() {
        const token = currentUserToken || "";
        console.log('ğŸ”‘ [LOBBY] getToken Ã§aÄŸÄ±rÄ±ldÄ±, token:', token ? 'VAR' : 'YOX');
        return token;
    }

    function createConnection() {
        console.log('ğŸ“¡ [LOBBY] createConnection baÅŸladÄ±');
        
        connection = new signalR.HubConnectionBuilder()
            .withUrl("https://nehemiah-paginal-alan.ngrok-free.dev/lotoHub", {
                accessTokenFactory: () => {
                    const token = getToken();
                    console.log('ğŸ” [LOBBY] SignalR token factory, token:', token ? 'VAR' : 'YOX');
                    return token;
                }
            })
            .withAutomaticReconnect()
            .configureLogging(signalR.LogLevel.Information)
            .build();

        console.log('âœ… [LOBBY] Connection yaradÄ±ldÄ±');
        setupHandlers();
        return connection;
    }

    function setupHandlers() {
        console.log('ğŸ§ [LOBBY] Event handlers qurulur...');
        
        connection.on("UserData", (data) => {
            console.log('ğŸ‘¤ [LOBBY] UserData event:', data);
            userBalance = data.balance;
            document.getElementById("userBalance").textContent = data.balance.toFixed(2);
        });

        connection.on("RoomListUpdated", () => {
            console.log('ğŸ”„ [LOBBY] RoomListUpdated event');
            loadRooms();
        });

        console.log('âœ… [LOBBY] Event handlers quruldu');
    }

    async function loadRooms() {
        console.log('ğŸ“‹ [LOBBY] loadRooms baÅŸladÄ±');
        console.log('ğŸ“¡ [LOBBY] Connection state:', connection?.state);
        
        try {
            console.log('ğŸ”„ [LOBBY] GetRoomList invoke edilir...');
            const rooms = await connection.invoke("GetRoomList");
            
            console.log('ğŸ“¦ [LOBBY] Rooms alÄ±ndÄ±:', rooms);
            console.log('ğŸ“Š [LOBBY] Room sayÄ±:', rooms ? rooms.length : 0);
            
            if (rooms && rooms.length > 0) {
                console.log('ğŸ¯ [LOBBY] Ä°lk room:', rooms[0]);
            }
            
            renderRooms(rooms);
        } catch (err) {
            console.error("âŒ [LOBBY] Load rooms xÉ™tasÄ±:", err);
            console.error("âŒ [LOBBY] Error stack:", err.stack);
        }
    }

    function renderRooms(rooms) {
        console.log('ğŸ¨ [LOBBY] renderRooms baÅŸladÄ±');
        console.log('ğŸ“¦ [LOBBY] Rooms parametri:', rooms);
        
        const container = document.getElementById("roomsContainer");
        
        if (!container) {
            console.error('âŒ [LOBBY] roomsContainer tapÄ±lmadÄ±!');
            return;
        }

        if (!rooms || rooms.length === 0) {
            console.log('âš ï¸ [LOBBY] Room yoxdur');
            container.innerHTML = '<div class="loading">Aktiv otaq yoxdur</div>';
            return;
        }

        container.innerHTML = "";
        console.log(`âœ… [LOBBY] ${rooms.length} otaq render edilir`);

        rooms.forEach((room, index) => {
            console.log(`ğŸ¯ [LOBBY] Room ${index + 1}/${rooms.length}:`, room);
            
            const card = document.createElement("div");
            card.className = `room-card ${room.isGameStarted ? 'playing' : ''}`;

            const statusBadge = room.isGameStarted
                ? '<span class="status-badge badge-playing">â–¶ OynayÄ±r</span>'
                : '<span class="status-badge badge-waiting">GÃ¶zlÉ™yir</span>';

            const timePercent = room.isGameStarted ? 0 : (room.timeRemaining / room.timerSeconds) * 100;

            card.innerHTML = `
                <div class="room-header">
                    <div class="entry-fee">${room.entryFee.toFixed(2)} â‚¼</div>
                    ${statusBadge}
                </div>
                <div class="jackpot-display">
                    <div class="jackpot-label">JACKPOT</div>
                    <div class="jackpot-amount">${room.jackpotPool.toFixed(2)} â‚¼</div>
                </div>
                <div class="room-info">
                    <div class="info-item">
                        <div class="info-label">OYUNÃ‡ULAR</div>
                        <div class="info-value">${room.playerCount}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">VAXT</div>
                        <div class="info-value">${room.isGameStarted ? 'BAÅLAYIB' : room.timeRemaining + 's'}</div>
                    </div>
                </div>
                ${!room.isGameStarted ? `
                    <div class="timer-bar">
                        <div class="timer-fill" style="width: ${timePercent}%"></div>
                    </div>
                ` : ''}
            `;

            card.addEventListener("click", () => {
                console.log('ğŸ® [LOBBY] Room clicked:', room.roomId);
                window.parent.postMessage({
                    type: 'JOIN_ROOM',
                    roomId: room.roomId
                }, '*');
            });

            container.appendChild(card);
        });
        
        console.log('âœ… [LOBBY] BÃ¼tÃ¼n otaqlar render edildi');
    }

    async function init() {
        console.log('ğŸš€ [LOBBY] init() baÅŸladÄ±');
        console.log('ğŸ« [LOBBY] Token mÃ¶vcuddur:', currentUserToken ? 'BÆLÄ°' : 'XEYR');
        
        if (!currentUserToken) {
            console.error('âŒ [LOBBY] Token yoxdur! Init dayandÄ±rÄ±lÄ±r.');
            return;
        }
        
        try {
            console.log('ğŸ“¡ [LOBBY] createConnection Ã§aÄŸÄ±rÄ±lÄ±r...');
            connection = createConnection();
            
            console.log('ğŸ”Œ [LOBBY] connection.start() Ã§aÄŸÄ±rÄ±lÄ±r...');
            await connection.start();
            console.log("âœ… [LOBBY] SignalR baÄŸlantÄ±sÄ± uÄŸurlu!");
            console.log("ğŸ“¡ [LOBBY] Connection ID:", connection.connectionId);

            console.log('ğŸ“‹ [LOBBY] Ä°lk loadRooms() Ã§aÄŸÄ±rÄ±lÄ±r...');
            await loadRooms();

            console.log('â° [LOBBY] setInterval baÅŸladÄ±lÄ±r (1000ms)...');
            // Her 1 saniyÉ™dÉ™ yenilÉ™
            updateInterval = setInterval(() => {
                console.log('â° [LOBBY] Interval tick - loadRooms Ã§aÄŸÄ±rÄ±lÄ±r');
                loadRooms();
            }, 1000);

            // Auto-start yoxla
            setInterval(async () => {
                if (connection.state === signalR.HubConnectionState.Connected) {
                    try {
                        await connection.invoke("CheckAutoStart");
                    } catch (err) {
                        console.error("âŒ [LOBBY] CheckAutoStart xÉ™tasÄ±:", err);
                    }
                }
            }, 1000);

            console.log('âœ… [LOBBY] init() tamamlandÄ±');

        } catch (err) {
            console.error("âŒ [LOBBY] init() xÉ™tasÄ±:", err);
            console.error("âŒ [LOBBY] Error stack:", err.stack);
            console.error("âŒ [LOBBY] Error message:", err.message);
            
            document.getElementById("roomsContainer").innerHTML =
                '<div class="loading">âŒ BaÄŸlantÄ± xÉ™tasÄ±: ' + err.message + '</div>';
        }
    }

    console.log('âœ… [LOBBY] Script tam yÃ¼klÉ™ndi, postMessage gÃ¶zlÉ™nilir...');
</script> -->

    <script>
        let currentUserToken = null;
        let currentUserData = null;
        let connection = null;
        let userBalance = 0;

        console.log('ğŸ° [LOBBY] Script yÃ¼klÉ™ndi');

        window.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'INIT_USER') {
                console.log('âœ… [LOBBY] INIT_USER qÉ™bul edildi');

                currentUserData = event.data.payload;
                currentUserToken = currentUserData.token;

                document.getElementById("userBalance").textContent =
                    currentUserData.balance.toFixed(2);

                console.log('ğŸš€ [LOBBY] init() Ã§aÄŸÄ±rÄ±lÄ±r...');
                init();
            }
        });

        function getToken() {
            return currentUserToken || "";
        }

        function createConnection() {
            console.log('ğŸ“¡ [LOBBY] createConnection baÅŸladÄ±');

            connection = new signalR.HubConnectionBuilder()
                .withUrl("https://nehemiah-paginal-alan.ngrok-free.dev/lotoHub", {
                    accessTokenFactory: () => getToken()
                })
                .withAutomaticReconnect()
                .configureLogging(signalR.LogLevel.Information)
                .build();

            setupHandlers();
            return connection;
        }

        function setupHandlers() {
            console.log('ğŸ§ [LOBBY] Event handlers qurulur...');

            // UserData event
            connection.on("UserData", (data) => {
                console.log('ğŸ‘¤ [LOBBY] UserData event:', data);
                userBalance = data.balance;
                document.getElementById("userBalance").textContent = data.balance.toFixed(2);
            });

            // âœ… RoomListUpdated - Backend dÉ™yiÅŸiklik olanda gÃ¶ndÉ™rir
            connection.on("RoomListUpdated", () => {
                console.log('ğŸ”„ [LOBBY] RoomListUpdated event - otaqlar yÃ¼klÉ™nir');
                loadRooms();
            });

            console.log('âœ… [LOBBY] Event handlers quruldu');
        }

        async function loadRooms() {
            console.log('ğŸ“‹ [LOBBY] loadRooms baÅŸladÄ±');

            try {
                const rooms = await connection.invoke("GetRoomList");
                console.log('ğŸ“¦ [LOBBY] Rooms alÄ±ndÄ±:', rooms?.length || 0, 'É™dÉ™d');
                renderRooms(rooms);
            } catch (err) {
                console.error("âŒ [LOBBY] Load rooms xÉ™tasÄ±:", err);
            }
        }

        function renderRooms(rooms) {
            const container = document.getElementById("roomsContainer");

            if (!container) {
                console.error('âŒ [LOBBY] roomsContainer tapÄ±lmadÄ±!');
                return;
            }

            if (!rooms || rooms.length === 0) {
                container.innerHTML = '<div class="loading">Aktiv otaq yoxdur</div>';
                return;
            }

            container.innerHTML = "";
            console.log(`âœ… [LOBBY] ${rooms.length} otaq render edilir`);

            rooms.forEach((room) => {
                const card = document.createElement("div");
                card.className = `room-card ${room.isGameStarted ? 'playing' : ''}`;

                const statusBadge = room.isGameStarted
                    ? '<span class="status-badge badge-playing">â–¶ OynayÄ±r</span>'
                    : '<span class="status-badge badge-waiting">GÃ¶zlÉ™yir</span>';

                const timePercent = room.isGameStarted ? 0 : (room.timeRemaining / room.timerSeconds) * 100;

                card.innerHTML = `
                <div class="room-header">
                    <div class="entry-fee">${room.entryFee.toFixed(2)} â‚¼</div>
                    ${statusBadge}
                </div>
                <div class="jackpot-display">
                    <div class="jackpot-label">JACKPOT</div>
                    <div class="jackpot-amount">${room.jackpotPool.toFixed(2)} â‚¼</div>
                </div>
                <div class="room-info">
                    <div class="info-item">
                        <div class="info-label">OYUNÃ‡ULAR</div>
                        <div class="info-value">${room.playerCount}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">VAXT</div>
                        <div class="info-value">${room.isGameStarted ? 'BAÅLAYIB' : room.timeRemaining + 's'}</div>
                    </div>
                </div>
                ${!room.isGameStarted ? `
                    <div class="timer-bar">
                        <div class="timer-fill" style="width: ${timePercent}%"></div>
                    </div>
                ` : ''}
            `;

                // OtaÄŸa daxil ol
                card.addEventListener("click", () => {
                    console.log('ğŸ® [LOBBY] Room clicked:', room.roomId);
                    window.parent.postMessage({
                        type: 'JOIN_ROOM',
                        roomId: room.roomId
                    }, '*');
                });

                container.appendChild(card);
            });
        }

        async function init() {
            console.log('ğŸš€ [LOBBY] init() baÅŸladÄ±');

            if (!currentUserToken) {
                console.error('âŒ [LOBBY] Token yoxdur!');
                return;
            }

            try {
                connection = createConnection();
                await connection.start();
                console.log("âœ… [LOBBY] SignalR baÄŸlantÄ±sÄ± uÄŸurlu!");

                // Ä°lk yÃ¼klÉ™mÉ™
                await loadRooms();

                // âœ… Backend "RoomListUpdated" gÃ¶ndÉ™rÉ™cÉ™k
                // setInterval LAZIM DEYÄ°L!
                console.log('âœ… [LOBBY] Backend event-lÉ™rÉ™ dinlÉ™yici quruldu');

            } catch (err) {
                console.error("âŒ [LOBBY] init() xÉ™tasÄ±:", err);
                document.getElementById("roomsContainer").innerHTML =
                    '<div class="loading">âŒ BaÄŸlantÄ± xÉ™tasÄ±: ' + err.message + '</div>';
            }
        }

        console.log('âœ… [LOBBY] Script tam yÃ¼klÉ™ndi, postMessage gÃ¶zlÉ™nilir...');
    </script>

</body>

</html>