<!DOCTYPE html>
<html lang="az">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1, viewport-fit=cover" />
    <title>10 Line Loto - Otaqlar</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
    <link rel="stylesheet" href="./LotoLobby.css" />

</head>

<body>
    <div class="container-game">
        <div class="header">
            <div class="balance-display">
                üí∞ <span id="userBalance">0</span>
            </div>
            <div class="header-right">
                <h1>LOTO</h1>
            </div>
            <button class="back-btn" onclick="goToLobby()">
                ‚Üê
            </button>
        </div>
    </div>

    <div id="loadingContainer" class="loading-container">
        <div>
            <!-- Floating elements -->
            <div class="floating-cards">
                <div class="card"></div>
                <div class="card"></div>
                <div class="card"></div>
                <div class="card"></div>
                <div class="coin"></div>
                <div class="coin"></div>
                <div class="coin"></div>
                <div class="coin"></div>
                <div class="sparkle"></div>
                <div class="sparkle"></div>
                <div class="sparkle"></div>
                <div class="sparkle"></div>
                <div class="sparkle"></div>
                <div class="sparkle"></div>
            </div>

            <!-- Dice -->
            <div class="dice-container">
                <div class="dice">‚öÖ</div>
            </div>
            <div class="dice-container-right">
                <div class="dice">‚öÑ</div>
            </div>

            <!-- Main roulette wheel -->
            <div class="roulette-wheel">
                <div class="wheel-outer">
                    <div class="wheel-inner">
                        <div class="wheel-segment"></div>
                        <div class="wheel-segment"></div>
                        <div class="wheel-segment"></div>
                        <div class="wheel-segment"></div>
                        <div class="wheel-segment"></div>
                        <div class="wheel-segment"></div>
                        <div class="wheel-segment"></div>
                        <div class="wheel-segment"></div>
                        <div class="wheel-center"></div>
                    </div>
                </div>
            </div>

            <!-- Text -->
            <div class="loading-text">LOADING ROOMS</div>
            <div class="loading-subtext">PREPARING YOUR GAME</div>

            <!-- Progress dots -->
            <div class="dots">
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
            </div>
        </div>
    </div>
    <div id="roomsContainer" class="rooms-container">
    </div>

    <script>

        let currentUserToken = null;
        let currentUserData = null;

        console.log('üé∞ [LOTO LOBBY] Script y√ºkl…ôndi');

        window.addEventListener('message', (event) => {
            console.log('üì® [LOTO LOBBY] Message alƒ±ndƒ±:', event.data);

            if (event.data && event.data.type === 'INIT_USER') {
                console.log('‚úÖ [LOTO LOBBY] INIT_USER q…ôbul edildi');

                currentUserData = event.data.payload;
                currentUserToken = currentUserData.token;

                console.log('üë§ [LOTO LOBBY] User:', currentUserData.username);
                console.log('üé´ [LOTO LOBBY] Token:', currentUserToken ? 'VAR' : 'YOX');

                // Balance g√∂st…ôr
                document.getElementById("userBalance").textContent =
                    currentUserData.balance.toFixed(2);

                console.log('üöÄ [LOTO LOBBY] init() √ßaƒüƒ±rƒ±lƒ±r...');
                // SignalR ba≈ülat
                init();
            }
        });

        // ============================================
        // getToken funksiyasƒ±nƒ± d…ôyi≈üdir
        // ============================================
        function getToken() {
            return currentUserToken || "";
        }
        // ------------------------------
        let connection = null;
        let userBalance = 0;
        let updateInterval = null;

        // function getToken() {
        //     const raw = document.cookie
        //         .split("; ")
        //         .find(row => row.startsWith("AuthToken="))
        //         ?.split("=")[1];
        //     if (!raw) return "";
        //     let token = decodeURIComponent(raw).trim();
        //     if (token.endsWith(".")) token = token.slice(0, -1);
        //     return token;
        // }

        function createConnection() {
            connection = new signalR.HubConnectionBuilder()
                .withUrl("https://nehemiah-paginal-alan.ngrok-free.dev/lotoHub", {
                    accessTokenFactory: () => getToken()
                })
                .withAutomaticReconnect()
                .configureLogging(signalR.LogLevel.Information)
                .build();

            setupHandlers();
            return connection;
        }
        function removeLoading() {
            const loadingContainer = document.getElementById("loadingContainer");
            if (loadingContainer) {
                loadingContainer.remove();
            }
        }
        function setupHandlers() {
            connection.on("UserData", (data) => {
                userBalance = data.balance;
                // Artƒ±q React-d…ôn aldƒ±q, yenid…ôn yazmƒ±rƒ±q
                console.log("‚úÖ [LOTO LOBBY] UserData event:", data);
            });

            connection.on("RoomListUpdated", () => {
                loadRooms();
            });
        }

        async function loadRooms() {
            // ‚Üê BU YOXLANI≈ûI ∆èLAVE ET:
            if (!connection || connection.state !== signalR.HubConnectionState.Connected) {
                console.log('‚è≥ Connection h…ôl…ô hazƒ±r deyil');
                return;
            }
            try {
                const rooms = await connection.invoke("GetRoomList");
                renderRooms(rooms);
                removeLoading();
            } catch (err) {
                console.error("Load rooms error:", err);
            }
        }

        function renderRooms(rooms) {
            const container = document.getElementById("roomsContainer");
            container.innerHTML = "";

            if (!rooms || rooms.length === 0) {
                container.innerHTML = '<div class="loading">Rooms Are loading...</div>';
                return;
            }

            rooms.forEach(room => {
                const card = document.createElement("div");
                card.className = `room-card ${room.isGameStarted ? 'playing' : ''}`;

                const statusBadge = room.isGameStarted
                    ? '<span class="status-badge badge-playing">‚ñ∂ Playing</span>'
                    : '<span class="status-badge badge-waiting">Waiting</span>';

                const timePercent = room.isGameStarted ? 0 : (room.timeRemaining / room.timerSeconds) * 100;

                card.innerHTML = `
                        <div class="room-header">
                            <div class="entry-fee">${room.entryFee.toFixed(2)}</div>
                            ${statusBadge}
                        </div>

                        <div class="jackpot-display">
                            <div class="jackpot-label">JACKPOT</div>
                            <div class="jackpot-amount">${room.jackpotPool.toFixed(2)}</div>
                        </div>

                        <div class="room-info">
                            <div class="info-item">
                                <div class="info-label">CARDS</div>
                                <div class="info-value">${room.playerCount}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">TIME</div>
                                <div class="info-value">${room.isGameStarted ? 'STARTED' : room.timeRemaining + 's'}</div>
                            </div>
                        </div>

                        ${!room.isGameStarted ? `
                            <div class="timer-bar">
                                <div class="timer-fill" style="width: ${timePercent}%"></div>
                            </div>
                        ` : ''}
                    `;

                card.addEventListener("click", () => {
                    console.log('üéÆ [LOTO LOBBY] Room clicked:', room.roomId);
                    window.parent.postMessage({
                        type: 'JOIN_ROOM',
                        roomId: room.roomId
                    }, '*');
                });

                container.appendChild(card);
            });
        }
        function goToLobby() {
            window.parent.postMessage({ type: 'BACK_TO_GAMES', payload: {} }, '*');
        }

        async function init() {
            console.log('üöÄ [LOTO LOBBY] init() ba≈üladƒ±');

            if (!currentUserToken) {
                console.error('‚ùå [LOTO LOBBY] Token yoxdur!');
                return;
            }

            try {
                connection = createConnection();
                await connection.start();
                console.log("‚úÖ [LOTO LOBBY] SignalR connected");

                // ‚Üê Connection ready olandan SONRA loadRooms √ßaƒüƒ±r:
                await loadRooms();

                // Sonra interval ba≈ülat:
                updateInterval = setInterval(loadRooms, 2000);

            } catch (err) {
                console.error("‚ùå [LOTO LOBBY] Connection error:", err);
                document.getElementById("roomsContainer").innerHTML =
                    '<div class="loading">‚ùå Baƒülantƒ± x…ôtasƒ±</div>';
            }
        }

        console.log('‚úÖ [LOTO LOBBY] Script tam y√ºkl…ôndi, postMessage g√∂zl…ônilir...');

    </script>
</body>

</html>