<!DOCTYPE html>
<html lang="az">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1, viewport-fit=cover" />
    <title>10 Line Loto - Rooms</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
    <link rel="stylesheet" href="./LotoLobby.css" />



</head>

<body>
    <div class="container-game">
        <div class="header">
            <button class="back-btn" onclick="goToLobby()">
                ‚Üê
            </button>
            <div class="header-right">
                <span class="loto-number">1</span>
                <h1 class="header-title">LOTO</h1>
                <span class="loto-number">7</span>
            </div>
            <div class="balance-display">
                üí∞ <span id="userBalance">0</span>
            </div>
        </div>
    </div>

    <div id="loadingContainer" class="loading-container">
        <div class="loading-stage">
            <div class="loto-aurora"></div>

            <div class="ticket-stack">
                <div class="ticket ticket-shadow"></div>
                <div class="ticket ticket-front">
                    <div class="ticket-heading">LOTO</div>
                    <div class="ticket-grid">
                        <span>7</span><span>17</span><span>27</span><span>37</span><span>77</span>
                        <span>8</span><span>57</span><span>47</span><span>67</span><span>88</span>
                    </div>
                </div>
            </div>

            <div class="ball-orbit">
                <div class="orbit">
                    <div class="loto-ball">7</div>
                    <div class="loto-ball">17</div>
                    <div class="loto-ball">27</div>
                    <div class="loto-ball">37</div>
                    <div class="loto-ball">47</div>
                    <div class="loto-ball">87</div>
                </div>
            </div>

            <!-- Main roulette wheel -->
            <div class="roulette-wheel">
                <div class="wheel-outer">
                    <div class="wheel-inner">
                        <div class="wheel-segment"></div>
                        <div class="wheel-segment"></div>
                        <div class="wheel-segment"></div>
                        <div class="wheel-segment"></div>
                        <div class="wheel-segment"></div>
                        <div class="wheel-segment"></div>
                        <div class="wheel-segment"></div>
                        <div class="wheel-segment"></div>
                        <div class="wheel-center"></div>
                    </div>
                </div>
            </div>

            <!-- Text -->
            <div class="loading-text" id="loadingText" data-i18n="loading">LOADING</div>
            <div class="loading-subtext" id="loadingSubtext" data-i18n="preparing">PREPARING YOUR GAME</div>

            <!-- Progress dots -->
            <div class="dots">
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
            </div>
        </div>
    </div>
    <div id="roomsContainer" class="rooms-container">
    </div>

    <script>

        let currentUserToken = null;
        let currentUserData = null;
        let currentLanguage = "en";

        const translations = {
            en: {
                title: "Loto",
                loading: "LOADING ROOMS",
                preparing: "PREPARING YOUR GAME",
                roomsLoading: "Rooms are loading...",
                playing: "‚ñ∂ Playing",
                waiting: "Waiting",
                jackpot: "JACKPOT",
                cards: "CARDS",
                time: "TIME",
                started: "STARTED",
                secondsSuffix: "s",
                connectionError: "‚ùå Connection error"
            },
            tr: {
                title: "Loto",
                loading: "ODALAR Y√úKLENƒ∞YOR",
                preparing: "OYUNUNUZ HAZIRLANIYOR",
                roomsLoading: "Odalar y√ºkleniyor...",
                playing: "‚ñ∂ Oynanƒ±yor",
                waiting: "Bekleniyor",
                jackpot: "JACKPOT",
                cards: "KARTLAR",
                time: "S√úRE",
                started: "BA≈ûLADI",
                secondsSuffix: "s",
                connectionError: "‚ùå Baƒülantƒ± hatasƒ±"
            },
            hi: {
                title: "Loto",
                loading: "‡§ï‡§Æ‡§∞‡•á ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡•á ‡§π‡•à‡§Ç",
                preparing: "‡§Ü‡§™‡§ï‡§æ ‡§ó‡•á‡§Æ ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à",
                roomsLoading: "‡§ï‡§Æ‡§∞‡•á ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡•á ‡§π‡•à‡§Ç...",
                playing: "‚ñ∂ ‡§ö‡§≤ ‡§∞‡§π‡§æ ‡§π‡•à",
                waiting: "‡§™‡•ç‡§∞‡§§‡•Ä‡§ï‡•ç‡§∑‡§æ",
                jackpot: "‡§ú‡•à‡§ï‡§™‡•â‡§ü",
                cards: "‡§ï‡§æ‡§∞‡•ç‡§°",
                time: "‡§∏‡§Æ‡§Ø",
                started: "‡§∂‡•Å‡§∞‡•Ç",
                secondsSuffix: "‡§∏‡•á‡§ï",
                connectionError: "‚ùå ‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø"
            },
            ru: {
                title: "Loto",
                loading: "–ö–û–ú–ù–ê–¢–´ –ó–ê–ì–†–£–ñ–ê–Æ–¢–°–Ø",
                preparing: "–ü–û–î–ì–û–¢–û–í–ö–ê –ò–ì–†–´",
                roomsLoading: "–ö–æ–º–Ω–∞—Ç—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è...",
                playing: "‚ñ∂ –ò–≥—Ä–∞ –∏–¥–µ—Ç",
                waiting: "–û–∂–∏–¥–∞–Ω–∏–µ",
                jackpot: "–î–ñ–ï–ö–ü–û–¢",
                cards: "–ö–ê–†–¢–´",
                time: "–í–†–ï–ú–Ø",
                started: "–ù–ê–ß–ê–õ–û–°–¨",
                secondsSuffix: "—Å",
                connectionError: "‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è"
            },
            ar: {
                title: "Loto",
                loading: "ÿ¨ÿßÿ±Ÿç ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ∫ÿ±ŸÅ",
                preparing: "Ÿäÿ™ŸÖ ÿ™ÿ¨ŸáŸäÿ≤ ŸÑÿπÿ®ÿ™ŸÉ",
                roomsLoading: "ÿ¨ÿßÿ±Ÿç ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ∫ÿ±ŸÅ...",
                playing: "‚ñ∂ ÿ¨ÿßÿ±Ÿç ÿßŸÑŸÑÿπÿ®",
                waiting: "ŸÅŸä ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±",
                jackpot: "ÿßŸÑÿ¨ÿßÿ¶ÿ≤ÿ© ÿßŸÑŸÉÿ®ÿ±Ÿâ",
                cards: "ÿßŸÑÿ®ÿ∑ÿßŸÇÿßÿ™",
                time: "ÿßŸÑŸàŸÇÿ™",
                started: "ÿ®ÿØÿ£ÿ™",
                secondsSuffix: "ÿ´",
                connectionError: "‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ"
            },
            uz: {
                title: "Loto",
                loading: "XONALAR YUKLANMOQDA",
                preparing: "O'YININGIZ TAYYORLANMOQDA",
                roomsLoading: "Xonalar yuklanmoqda...",
                playing: "‚ñ∂ O‚Äòynalmoqda",
                waiting: "Kutilmoqda",
                jackpot: "JACKPOT",
                cards: "KARTALAR",
                time: "VAQT",
                started: "BOSHLANDI",
                secondsSuffix: "s",
                connectionError: "‚ùå Ulanish xatosi"
            }
        };

        function normalizeLanguage(lang) {
            if (!lang) return "en";
            const value = String(lang).trim().toLowerCase();
            if (["en", "english"].includes(value)) return "en";
            if (["tr", "turkish", "t√ºrk√ße"].includes(value)) return "tr";
            if (["hi", "hindi", "in", "indian"].includes(value)) return "hi";
            if (["ru", "russian"].includes(value)) return "ru";
            if (["ar", "arabic"].includes(value)) return "ar";
            if (["uz", "uzbek", "o'zbek", "uzbekistan"].includes(value)) return "uz";
            return "en";
        }

        function applyLanguage(lang) {
            currentLanguage = normalizeLanguage(lang);
            const dict = translations[currentLanguage] || translations.en;
            document.title = dict.title;
            const loadingText = document.getElementById("loadingText");
            if (loadingText) loadingText.textContent = dict.loading;
            const loadingSubtext = document.getElementById("loadingSubtext");
            if (loadingSubtext) loadingSubtext.textContent = dict.preparing;
            document.documentElement.lang = currentLanguage;
            document.documentElement.dir = currentLanguage === "ar" ? "rtl" : "ltr";
        }

        console.log('üé∞ [LOTO LOBBY] Script y√ºkl…ôndi');

        window.addEventListener('message', (event) => {
            console.log('üì® [LOTO LOBBY] Message alƒ±ndƒ±:', event.data);

            if (event.data && event.data.payload.language) {
                applyLanguage(event.data.payload.language);
            }

            if (event.data && event.data.type === 'INIT_USER') {
                console.log('‚úÖ [LOTO LOBBY] INIT_USER q…ôbul edildi');

                currentUserData = event.data.payload;
                currentUserToken = currentUserData.token;

                console.log('üë§ [LOTO LOBBY] User:', currentUserData.username);
                console.log('üé´ [LOTO LOBBY] Token:', currentUserToken ? 'VAR' : 'YOX');

                // Balance g√∂st…ôr
                document.getElementById("userBalance").textContent =
                    currentUserData.balance.toFixed(2);

                console.log('üöÄ [LOTO LOBBY] init() √ßaƒüƒ±rƒ±lƒ±r...');
                // SignalR ba≈ülat
                init();
            }
        });

        // ============================================
        // getToken funksiyasƒ±nƒ± d…ôyi≈üdir
        // ============================================
        function getToken() {
            return currentUserToken || "";
        }
        // ------------------------------
        let connection = null;
        let userBalance = 0;
        let updateInterval = null;

        // function getToken() {
        //     const raw = document.cookie
        //         .split("; ")
        //         .find(row => row.startsWith("AuthToken="))
        //         ?.split("=")[1];
        //     if (!raw) return "";
        //     let token = decodeURIComponent(raw).trim();
        //     if (token.endsWith(".")) token = token.slice(0, -1);
        //     return token;
        // }

        function createConnection() {
            connection = new signalR.HubConnectionBuilder()
                .withUrl("https://nehemiah-paginal-alan.ngrok-free.dev/lotoHub", {
                    accessTokenFactory: () => getToken()
                })
                .withAutomaticReconnect()
                .configureLogging(signalR.LogLevel.Information)
                .build();

            setupHandlers();
            return connection;
        }
        function removeLoading() {
            const loadingContainer = document.getElementById("loadingContainer");
            if (loadingContainer) {
                loadingContainer.remove();
            }
        }
        function setupHandlers() {
            connection.on("UserData", (data) => {
                userBalance = data.balance;
                // Artƒ±q React-d…ôn aldƒ±q, yenid…ôn yazmƒ±rƒ±q
                console.log("‚úÖ [LOTO LOBBY] UserData event:", data);
            });

            connection.on("RoomListUpdated", () => {
                loadRooms();
            });
        }

        async function loadRooms() {
            // ‚Üê BU YOXLANI≈ûI ∆èLAVE ET:
            if (!connection || connection.state !== signalR.HubConnectionState.Connected) {
                console.log('‚è≥ Connection h…ôl…ô hazƒ±r deyil');
                return;
            }
            try {
                const rooms = await connection.invoke("GetRoomList");
                renderRooms(rooms);
                removeLoading();
            } catch (err) {
                console.error("Load rooms error:", err);
            }
        }

        function renderRooms(rooms) {
            console.log('üé≤ [LOTO LOBBY] Otaqlar renderl…ônir:', rooms);
            const container = document.getElementById("roomsContainer");
            container.innerHTML = "";
            const dict = translations[currentLanguage] || translations.en;

            if (!rooms || rooms.length === 0) {
                container.innerHTML = `<div class="loading">${dict.roomsLoading}</div>`;
                return;
            }

            rooms.forEach(room => {
                const card = document.createElement("div");
                card.className = `room-card ${room.isGameStarted ? 'playing' : ''}`;

                const statusBadge = room.isGameStarted
                    ? `<span class="status-badge badge-playing">${dict.playing}</span>`
                    : `<span class="status-badge badge-waiting">${dict.waiting}</span>`;

                const timePercent = room.isGameStarted ? 0 : (room.timeRemaining / room.timerSeconds) * 100;

                card.innerHTML = `
                        <div class="room-header">
                            <div class="entry-fee">${room.entryFee.toFixed(2)}</div>
                            ${room.entryFee==0.5 ? '<span class="status-badge badge-waiting">Entire Card</span>' : '<span class="status-badge badge-waiting">Single Line</span>'}
                            ${statusBadge}
                        </div>

                        <div class="jackpot-display">
                            <div class="jackpot-label">${dict.jackpot}</div>
                            <div class="jackpot-amount">${room.jackpotPool.toFixed(2)}</div>
                        </div>

                        <div class="room-info">
                            <div class="info-item">
                                <div class="info-label">${dict.cards}</div>
                                <div class="info-value">${room.playerCount}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">${dict.time}</div>
                                <div class="info-value">${room.isGameStarted ? dict.started : room.timeRemaining + dict.secondsSuffix}</div>
                            </div>
                        </div>

                        ${!room.isGameStarted ? `
                            <div class="timer-bar">
                                <div class="timer-fill" style="width: ${timePercent}%"></div>
                            </div>
                        ` : ''}
                    `;

                card.addEventListener("click", () => {
                    console.log('üéÆ [LOTO LOBBY] Room clicked:', room.roomId);
                    window.parent.postMessage({
                        type: 'JOIN_ROOM',
                        roomId: room.roomId
                    }, '*');
                });

                container.appendChild(card);
            });
        }
        function goToLobby() {
            window.parent.postMessage({ type: 'BACK_TO_GAMES', payload: {} }, '*');
        }

        async function init() {
            console.log('üöÄ [LOTO LOBBY] init() ba≈üladƒ±');

            if (!currentUserToken) {
                console.error('‚ùå [LOTO LOBBY] Token yoxdur!');
                return;
            }

            try {
                connection = createConnection();
                await connection.start();
                console.log("‚úÖ [LOTO LOBBY] SignalR connected");

                // ‚Üê Connection ready olandan SONRA loadRooms √ßaƒüƒ±r:
                await loadRooms();

                // Sonra interval ba≈ülat:
                updateInterval = setInterval(loadRooms, 2000);

            } catch (err) {
                console.error("‚ùå [LOTO LOBBY] Connection error:", err);
                document.getElementById("roomsContainer").innerHTML =
                    `<div class="loading">${(translations[currentLanguage] || translations.en).connectionError}</div>`;
            }
        }

        applyLanguage(currentLanguage);
        console.log('‚úÖ [LOTO LOBBY] Script tam y√ºkl…ôndi, postMessage g√∂zl…ônilir...');

    </script>
</body>

</html>
