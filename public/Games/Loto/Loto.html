<!DOCTYPE html>
<html lang="az">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>10 Line Loto - Oyun</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/canvas-confetti/1.6.0/confetti.browser.min.js"></script>
    <link rel="stylesheet" href="./Loto.css">
</head>

<body>
    <div class="top-bar">
        <div>
            <div class="jackpot-display">
                ğŸ† <span id="jackpotAmount">0.00</span> â‚¼
            </div>
        </div>
        <div style="display: flex; gap: 15px; align-items: center;">
            <div class="balance-display">ğŸ’° <span id="userBalance">0.00</span> â‚¼</div>
            <button id="buyTicketBtn" class="btn">+ Bilet Al</button>
            <button id="backBtn" class="btn btn-danger">â† Ã‡Ä±x</button>
        </div>
    </div>

    <div class="drawn-number">
        <div class="big-ball" id="bigBall">--</div>
        <div class="history" id="history"></div>
    </div>

    <div class="tickets-container" id="ticketsContainer"></div>

    <div id="gameOverModal" class="modal">
        <div class="modal-content">
            <h2>ğŸ†</h2>
            <div id="gameOverText" style="font-size: 24px; margin-bottom: 20px;"></div>

        </div>
    </div>

    <script>
        // ============================================
        // React-dÉ™n user data vÉ™ roomId
        // ============================================
        let currentUserToken = null;
        let currentUserData = null;
        let roomId = null; // React-dÉ™n gÉ™lÉ™cÉ™k

        let connection = null;
        let myTickets = [];
        let drawnNumbers = [];
        let isGameStarted = false;

        console.log('ğŸ® Loto Game loaded, waiting for user data...');

        window.addEventListener('message', (event) => {
            console.log('ğŸ“¨ Game message:', event.data);

            if (event.data && event.data.type === 'INIT_USER') {
                console.log('âœ… User data received in game');
                currentUserData = event.data.payload;
                currentUserToken = currentUserData.token;
                roomId = currentUserData.roomId; // React-dÉ™n

                // Balance gÃ¶stÉ™r
                document.getElementById("userBalance").textContent =
                    currentUserData.balance.toFixed(2);

                // Oyunu baÅŸlat
                init();
            }
        });

        // ============================================
        // Token funksiyasÄ±
        // ============================================
        function getToken() {
            return currentUserToken || "";
        }

        // ============================================
        // DigÉ™r funksiyalar (dÉ™yiÅŸiklik YOX)
        // ============================================
        function showNotification(message) {
            const notif = document.createElement('div');
            notif.className = 'notification';
            notif.textContent = message;
            document.body.appendChild(notif);
            setTimeout(() => notif.remove(), 3000);
        }

        function createConnection() {
            connection = new signalR.HubConnectionBuilder()
                .withUrl("https://nehemiah-paginal-alan.ngrok-free.dev/lotoHub", {
                    accessTokenFactory: () => getToken()
                })
                .withAutomaticReconnect()
                .configureLogging(signalR.LogLevel.Information)
                .build();

            setupHandlers();
            return connection;
        }

        function setupHandlers() {
            connection.on("UserData", (data) => {
                document.getElementById("userBalance").textContent = data.balance.toFixed(2);
            });

            connection.on("RoomJoined", (data) => {
                myTickets = data.myTickets;
                isGameStarted = data.isGameStarted;
                drawnNumbers = data.drawnNumbers || [];
                document.getElementById("jackpotAmount").textContent = data.jackpot.toFixed(2);
                renderTickets();
                updateHistory();
            });

            connection.on("TicketPurchased", (data) => {
                myTickets.push({ ticketId: data.ticketId, card: data.card });
                document.getElementById("userBalance").textContent = data.balance.toFixed(2);
                showNotification(`âœ… Bilet ${data.ticketNumber}/${data.maxTickets} alÄ±ndÄ±`);
                renderTickets();
            });

            connection.on("TicketRefreshed", (data) => {
                const ticketIndex = myTickets.findIndex(t => t.ticketId === data.ticketId);
                if (ticketIndex !== -1) {
                    myTickets[ticketIndex].card = data.card;
                    renderTickets();
                    showMessage("Bilet uÄŸurla yenilÉ™ndi!", "success");
                }
            });

            connection.on("TicketDeleted", (ticketId) => {
                myTickets = myTickets.filter(t => t.ticketId !== ticketId);
                renderTickets();
                showMessage("Bilet silindi vÉ™ balans geri qaytarÄ±ldÄ±!", "success");
            });

            connection.on("ShowMessage", (message, type) => {
                showMessage(message, type || "info");
            });

            connection.on("RoomUpdated", (data) => {
                document.getElementById("jackpotAmount").textContent = data.jackpot.toFixed(2);
            });

            connection.on("GameStarted", (data) => {
                isGameStarted = true;
                document.getElementById("buyTicketBtn").disabled = true;
                showNotification("ğŸ® Oyun baÅŸladÄ±!");
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });

                document.querySelectorAll('.btn-refresh, .btn-delete').forEach(btn => {
                    btn.disabled = true;
                });
            });

            connection.on("NumberDrawn", (num) => {
                drawnNumbers.push(num);
                document.getElementById("bigBall").textContent = num;
                updateHistory();
                markNumber(num);
            });

            connection.on("BalanceUpdated", (balance) => {
                document.getElementById("userBalance").textContent = balance.toFixed(2);
            });

            connection.on("CinkoCompleted", (data) => {
                showNotification(`ğŸ“Š ${data.playerName} - XÉ™tt ${data.line} tamamlandÄ±! (+${data.reward}â‚¼)`);
            });

            connection.on("AutoBingoChecking", (data) => {
                console.log("ğŸ” Auto-Bingo yoxlanÄ±r...", data);
            });

            connection.on("GameOver", (data) => {
                if (data.message && data.message.includes("AUTO-BINGO")) {
                    showNotification("ğŸ‰ " + data.message);
                    confetti({
                        particleCount: 300,
                        spread: 100,
                        origin: { y: 0.5 },
                        colors: ['#ffd166', '#ff9a3c', '#2dd4bf']
                    });
                }

                document.getElementById("gameOverText").textContent = data.message;
                document.getElementById("gameOverModal").classList.add("show");

                // âœ… React-É™ bildir
                window.parent.postMessage({
                    type: 'GAME_ENDED'
                }, '*');
            });

            connection.on("RoomReset", () => {
                // âœ… React-É™ bildir
                window.parent.postMessage({
                    type: 'BACK_TO_LOBBY'
                }, '*');
            });
        }

        async function refreshTicket(ticketId) {
            try {
                await connection.invoke("RefreshTicket", ticketId);
                showMessage("Bilet yenilÉ™nir...", "info");
            } catch (err) {
                console.error(err);
                showMessage("XÉ™ta: " + err.message, "error");
            }
        }

        async function deleteTicket(ticketId) {
            try {
                await connection.invoke("DeleteTicket", ticketId);
                showMessage("Bilet silinir...", "info");
            } catch (err) {
                console.error(err);
                showMessage("XÉ™ta: " + err.message, "error");
            }
        }

        function showMessage(message, type = 'info') {
            const messageDiv = document.createElement('div');
            messageDiv.textContent = message;
            messageDiv.style.cssText = `
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 25px;
            border-radius: 8px;
            font-weight: 500;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideDown 0.3s ease;
        `;

            if (type === 'success') {
                messageDiv.style.background = '#10b981';
                messageDiv.style.color = 'white';
            } else if (type === 'error') {
                messageDiv.style.background = '#ef4444';
                messageDiv.style.color = 'white';
            } else {
                messageDiv.style.background = '#3b82f6';
                messageDiv.style.color = 'white';
            }

            document.body.appendChild(messageDiv);

            setTimeout(() => {
                messageDiv.style.animation = 'slideUp 0.3s ease';
                setTimeout(() => {
                    document.body.removeChild(messageDiv);
                }, 300);
            }, 3000);
        }

        const style = document.createElement('style');
        style.textContent = `
        @keyframes slideDown {
            from { opacity: 0; transform: translateX(-50%) translateY(-20px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }
        @keyframes slideUp {
            from { opacity: 1; transform: translateX(-50%) translateY(0); }
            to { opacity: 0; transform: translateX(-50%) translateY(-20px); }
        }
    `;
        document.head.appendChild(style);

        function renderTickets() {
            const container = document.getElementById("ticketsContainer");
            container.innerHTML = "";

            myTickets.forEach((ticket, index) => {
                const ticketDiv = document.createElement("div");
                ticketDiv.className = "ticket";
                ticketDiv.id = `ticket-${ticket.ticketId}`;

                const completedLines = [];
                let gridHTML = '';

                for (let r = 0; r < 3; r++) {
                    for (let c = 0; c < 9; c++) {
                        const val = ticket.card[r][c];
                        const isMarked = val !== null && drawnNumbers.includes(val);
                        const cellClass = val === null ? 'cell blank' : `cell ${isMarked ? 'marked' : ''}`;
                        gridHTML += `<div class="${cellClass}">${val ?? ''}</div>`;
                    }
                }

                for (let r = 0; r < 3; r++) {
                    let allMarked = true;
                    for (let c = 0; c < 9; c++) {
                        const val = ticket.card[r][c];
                        if (val !== null && !drawnNumbers.includes(val)) {
                            allMarked = false;
                            break;
                        }
                    }
                    if (allMarked && ticket.card[r].some(v => v !== null)) {
                        completedLines.push(r);
                    }
                }

                let lineBtnsHTML = '';
                for (let r = 0; r < 3; r++) {
                    const isCompleted = completedLines.includes(r);
                    const disabled = !isCompleted || !isGameStarted;
                    lineBtnsHTML += `
                    <button class="line-btn ${isCompleted ? 'completed' : ''}"
                            ${disabled ? 'disabled' : ''}
                            onclick="callCinko('${ticket.ticketId}', ${r})">
                        XÉ™tt ${r + 1} ${isCompleted ? 'âœ“' : ''}
                    </button>
                `;
                }

                ticketDiv.innerHTML = `
                <div class="ticket-header">
                    <div class="ticket-number">ğŸ« Bilet #${index + 1}</div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn-refresh" onclick="refreshTicket('${ticket.ticketId}')"
                                ${isGameStarted ? 'disabled' : ''}>
                            ğŸ”„ YenilÉ™
                        </button>
                        <button class="btn-delete" onclick="deleteTicket('${ticket.ticketId}')"
                                ${isGameStarted ? 'disabled' : ''}>
                            ğŸ—‘ï¸ Sil
                        </button>
                        <button class="btn" onclick="callBingo('${ticket.ticketId}')"
                                ${!isGameStarted ? 'disabled' : ''}>
                            ğŸ¯ BINGO
                        </button>
                    </div>
                </div>
                <div class="card-grid">${gridHTML}</div>
                <div class="line-btns">${lineBtnsHTML}</div>
            `;

                container.appendChild(ticketDiv);
            });
        }

        function updateHistory() {
            const history = document.getElementById("history");
            history.innerHTML = "";

            const last20 = drawnNumbers.slice(-20).reverse();
            last20.forEach(num => {
                const ball = document.createElement("div");
                ball.className = "history-ball";
                ball.textContent = num;
                history.appendChild(ball);
            });
        }

        function markNumber(num) {
            console.log(`âœ… NÃ¶mrÉ™ Ã§É™kildi: ${num}`);
            renderTickets();
            checkMyTicketsStatus();
        }

        function checkMyTicketsStatus() {
            myTickets.forEach((ticket, index) => {
                let totalNumbers = 0;
                let markedCount = 0;

                for (let r = 0; r < 3; r++) {
                    for (let c = 0; c < 9; c++) {
                        const val = ticket.card[r][c];
                        if (val !== null) {
                            totalNumbers++;
                            if (drawnNumbers.includes(val)) {
                                markedCount++;
                            }
                        }
                    }
                }

                if (totalNumbers === 15 && markedCount === 15) {
                    console.log(`ğŸ† Bilet #${index + 1} TAM DOLDU!`);
                }
            });
        }

        async function callBingo(ticketId) {
            try {
                await connection.invoke("Bingo", ticketId);
            } catch (err) {
                console.error("Bingo error:", err);
            }
        }

        async function callCinko(ticketId, lineIndex) {
            try {
                await connection.invoke("Cinko", ticketId, lineIndex);
            } catch (err) {
                console.error("Cinko error:", err);
            }
        }

        document.getElementById("buyTicketBtn").addEventListener("click", async () => {
            try {
                const result = await connection.invoke("BuyTicket", roomId);
                if (!result.success) {
                    showNotification("âŒ " + result.message);
                }
            } catch (err) {
                console.error("Buy ticket error:", err);
                showNotification("âŒ Bilet almaq alÄ±nmadÄ±");
            }
        });

        // âœ… Back button - React-É™ mesaj gÃ¶ndÉ™r
        document.getElementById("backBtn").addEventListener("click", () => {
            window.parent.postMessage({
                type: 'BACK_TO_LOBBY'
            }, '*');
        });

        // âœ… init funksiyasÄ± - yalnÄ±z React-dÉ™n data gÉ™lÉ™ndÉ™ Ã§aÄŸrÄ±lÄ±r
        async function init() {
            if (!roomId) {
                console.error('âŒ No roomId!');
                window.parent.postMessage({ type: 'BACK_TO_LOBBY' }, '*');
                return;
            }

            let retries = 3;

            while (retries > 0) {
                try {
                    console.log(`ğŸš€ [GAME] init cÉ™hdi (${4 - retries}/3)`);

                    connection = createConnection();
                    await connection.start();

                    // 500ms gÃ¶zlÉ™ (É™min olmaq Ã¼Ã§Ã¼n)
                    await new Promise(resolve => setTimeout(resolve, 500));

                    console.log('ğŸ® [GAME] JoinRoomView...');
                    await connection.invoke("JoinRoomView", roomId);
                    console.log('âœ… [GAME] UÄŸurlu!');

                    return; // UÄŸurlu oldu, Ã§Ä±x

                } catch (err) {
                    console.error(`âŒ [GAME] CÉ™hd ${4 - retries} uÄŸursuz:`, err);
                    retries--;

                    if (retries === 0) {
                        showNotification("âŒ BaÄŸlantÄ± xÉ™tasÄ±");
                        setTimeout(() => {
                            window.parent.postMessage({ type: 'BACK_TO_LOBBY' }, '*');
                        }, 2000);
                    } else {
                        console.log(`â³ [GAME] 1 saniyÉ™ sonra yenidÉ™n...`);
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                }
            }
        }

    </script>
</body>

</html>