<!DOCTYPE html>
<html lang="az">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>10 Line Loto - Oyun</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/canvas-confetti/1.6.0/confetti.browser.min.js"></script>
    <link rel="stylesheet" href="./Loto.css" />
</head>

<body>
    <div id="loadingContainer" class="loading-container">
        <div>
            <!-- Floating elements -->
            <div class="floating-cards">
                <div class="card"></div>
                <div class="card"></div>
                <div class="card"></div>
                <div class="card"></div>
                <div class="coin"></div>
                <div class="coin"></div>
                <div class="coin"></div>
                <div class="coin"></div>
                <div class="sparkle"></div>
                <div class="sparkle"></div>
                <div class="sparkle"></div>
                <div class="sparkle"></div>
                <div class="sparkle"></div>
                <div class="sparkle"></div>
            </div>

            <!-- Dice -->
            <div class="dice-container">
                <div class="dice">‚öÖ</div>
            </div>
            <div class="dice-container-right">
                <div class="dice">‚öÑ</div>
            </div>

            <!-- Main roulette wheel -->
            <div class="roulette-wheel">
                <div class="wheel-outer">
                    <div class="wheel-inner">
                        <div class="wheel-segment"></div>
                        <div class="wheel-segment"></div>
                        <div class="wheel-segment"></div>
                        <div class="wheel-segment"></div>
                        <div class="wheel-segment"></div>
                        <div class="wheel-segment"></div>
                        <div class="wheel-segment"></div>
                        <div class="wheel-segment"></div>
                        <div class="wheel-center"></div>
                    </div>
                </div>
            </div>

            <!-- Text -->
            <div class="loading-text">LOADING</div>
            <div class="loading-subtext">PREPARING YOUR GAME</div>

            <!-- Progress dots -->
            <div class="dots">
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
            </div>
        </div>
    </div>
    <div style="display: none;" class="loto-game-container">
        <div class="top-bar-game">
            <div class="top-bar-side">
                <div class="top-bar-section">
                    <div class="side-display">
                        <div class="win-rule-badge" id="winRuleBadge">Entire Card</div>
                        <button id="backBtn" class="exit-button">‚Üê Exit</button>
                    </div>
                    <div class="middle-display">
                        <div class="jackpot-display">
                            üèÜ <span id="jackpotAmount">0.00</span> Coin
                        </div>
                        <div id="balanceDisplay" class="balance-display">üí∞ <span id="userBalance">0.00</span> Coin
                        </div>
                    </div>
                    <div class="side-display">
                        <div class="side-side">
                            <div class="win-rule-badge" id="timerBadge">0:00</div>
                            <button class="mute-toggle active" onclick="toggleMute(this)" aria-label="Toggle sound">
                                <span class="icon">üîä</span>
                            </button>
                        </div>
                        <button id="buyTicketBtn" onclick="checkTicketAvailability()" class="buy-ticket-button">+ Buy
                            ticket</button>
                    </div>
                </div>
            </div>

        </div>

        <div class="drawn-number">
            <div class="big-ball" id="bigBall">--</div>
            <div class="history" id="history"></div>
        </div>

        <div class="tickets-container" id="ticketsContainer"></div>

        <div id="gameOverModal" class="modal">
            <div class="modal-content">
                <div class="countdown-timer" id="countdownTimer">10</div>
                <h2>üèÜ WINNER üèÜ</h2>
                <!-- <div class="winner-name" id="winnerName"></div> -->
                <div class="win-type-badge" id="winTypeBadge"></div>
                <div class="prize-amount" id="prizeAmount"></div>
                <div class="winner-card-display">
                    <h3>üé´ Winner Ticket</h3>
                    <div class="winner-card-grid" id="winnerCardGrid"></div>
                </div>
                <button class="btn" onclick="goToLobby()"
                    style="margin-top: 20px; font-size: 18px; padding: 15px 40px;">
                    Return to Lobby
                </button>
            </div>
        </div>
    </div>


    <script>
        //Audios
        let isMuted = false;

        const sounds = {
            ticketPurchased: new Audio('./lotoSounds/ticketPurchased.mp3'),
            win: new Audio('./lotoSounds/winSound.mp3'),
            numberDrawn: new Audio('./lotoSounds/numberDrawn.mp3'),
        }
        // iOS / Chrome √º√ß√ºn preload
        Object.values(sounds).forEach(sound => {
            sound.preload = 'auto';
            sound.volume = 0.8;
        });
        function playSound(name) {
            if (isMuted) return;

            const sound = sounds[name];
            if (!sound) {
                console.warn('Sound not found:', name);
                return;
            }

            sound.currentTime = 0; // t…ôkrar √ßalmaq √º√ß√ºn
            sound.play().catch(() => {
                // autoplay policy fallback
            });
        }
        function unlockAudio() {
            Object.values(sounds).forEach(sound => {
                sound.play()
                    .then(() => {
                        sound.pause();
                        sound.currentTime = 0;
                    })
                    .catch(() => { });
            });

            console.log("üîì Audio unlocked");
        }
        document.addEventListener('touchstart', unlockAudio, { once: true });
        document.addEventListener('click', unlockAudio, { once: true });

        //mute Toggle
        function toggleMute(button) {
            isMuted = !isMuted;
            const isActive = button.classList.contains('active');
            const icon = button.querySelector('.icon');

            if (isActive) {
                // Mute
                button.classList.remove('active');
                icon.textContent = 'üîá';
            } else {
                // Unmute
                button.classList.add('active');
                icon.textContent = 'üîä';
            }
        }


        // ============================================
        // React-d…ôn user data
        // ============================================
        let currentUserToken = null;
        let currentUserData = null;
        let currentRoomId = null;

        let isInitialized = false;

        console.log('üéÆ [LOTO GAME] Script y√ºkl…ôndi');

        window.addEventListener('message', (event) => {
            console.log('üì® [LOTO GAME] Message alƒ±ndƒ±:', event.data);

            if (event.data && event.data.type === 'INIT_USER') {
                console.log('‚úÖ [LOTO GAME] INIT_USER q…ôbul edildi');

                currentUserData = event.data.payload;
                currentUserToken = currentUserData.token;
                currentRoomId = currentUserData.roomId;

                console.log('üë§ [LOTO GAME] User:', currentUserData.username);
                console.log('üé´ [LOTO GAME] Token:', currentUserToken ? 'VAR' : 'YOX');
                console.log('üéØ [LOTO GAME] RoomId:', currentRoomId);

                const balanceEl = document.getElementById("userBalance");
                if (balanceEl) {
                    balanceEl.textContent = currentUserData.balance.toFixed(2);
                }

                console.log('üöÄ [LOTO GAME] init() √ßaƒüƒ±rƒ±lƒ±r...');
                // Yalnƒ±z bir d…ôf…ô init et
                if (!isInitialized) {
                    isInitialized = true;
                    console.log('üöÄ [LOTO GAME] init() √ßaƒüƒ±rƒ±lƒ±r...');
                    init();
                } else {
                    console.log('‚ö†Ô∏è [LOTO GAME] Artƒ±q initialize olunub');
                }
            }
        });

        function sendToReact(type, payload) {
            console.log('üì§ [LOTO GAME] React-a mesaj:', { type, payload });
            window.parent.postMessage({ type, payload }, '*');
        }

        function getToken() {
            const token = currentUserToken || "";
            console.log('üîë [LOTO GAME] getToken √ßaƒürƒ±ldƒ±:', token ? 'VAR (' + token.substring(0, 20) + '...)' : 'YOX');
            return token;
        }

        // ============================================
        // Oyun d…ôyi≈ü…ônl…ôri
        // ============================================
        let connection = null;
        let myTickets = [];
        let drawnNumbers = [];
        let isGameStarted = false;
        let winRule = "TAM KART";
        let timerInterval = null;
        let lastTimerValue = -1;
        let countdownInterval = null;

        function showNotification(message) {
            const notif = document.createElement('div');
            notif.className = 'notification';
            notif.textContent = message;
            document.body.appendChild(notif);
            setTimeout(() => notif.remove(), 3000);
        }

        // function createConnection() {
        //     connection = new signalR.HubConnectionBuilder()
        //         .withUrl("https://nehemiah-paginal-alan.ngrok-free.dev/lotoHub", {
        //             accessTokenFactory: () => getToken()
        //         })
        //         .withAutomaticReconnect()
        //         .configureLogging(signalR.LogLevel.Information)
        //         .build();

        //     setupHandlers();
        //     return connection;
        // }


        function createConnection() {
            const token = getToken();
            console.log('üîë [LOTO] Creating connection with token:', token ? '‚úÖ VAR (' + token.substring(0, 30) + '...)' : '‚ùå YOX');

            if (!token) {
                console.error('‚ùå [LOTO] Token yoxdur! SignalR yaradƒ±lmƒ±r');
                throw new Error('Token tapƒ±lmadƒ±');
            }

            connection = new signalR.HubConnectionBuilder()
                .withUrl("https://nehemiah-paginal-alan.ngrok-free.dev/lotoHub", {
                    accessTokenFactory: () => {
                        const t = getToken();
                        console.log('üé´ [LOTO] accessTokenFactory √ßaƒüƒ±rƒ±ldƒ±:', t ? 'Token g√∂nd…ôrilir' : 'Token YOX!');
                        if (!t) {
                            console.error('‚ùå [LOTO] CRITICAL: Token null/empty!');
                        }
                        return t;
                    },
                    skipNegotiation: false,
                    transport: signalR.HttpTransportType.WebSockets | signalR.HttpTransportType.LongPolling,
                    withCredentials: false
                })
                .withAutomaticReconnect({
                    nextRetryDelayInMilliseconds: (retryContext) => {
                        if (retryContext.elapsedMilliseconds < 60000) {
                            return Math.random() * 10000;
                        } else {
                            return null;
                        }
                    }
                })
                .configureLogging(signalR.LogLevel.Debug)
                .build();

            connection.onclose((error) => {
                console.error('‚ùå [LOTO] Connection closed:', error);
                if (!getToken()) {
                    showNotification('Token problemi! S…ôhif…ôni yenil…ôyin.');
                }
            });

            connection.onreconnecting((error) => {
                console.log('üîÑ [LOTO] Reconnecting...', error);
                showNotification('Baƒülantƒ± k…ôsildi, yenid…ôn c…ôhd edilir...');
            });

            connection.onreconnected((connectionId) => {
                console.log('‚úÖ [LOTO] Reconnected:', connectionId);
                showNotification('Baƒülantƒ± b…ôrpa olundu!');
            });

            setupHandlers();
            return connection;
        }

        function setupHandlers() {
            console.log("üì° Setting up SignalR handlers...");

            connection.on("UserData", (data) => {
                const balanceEl = document.getElementById("userBalance");
                if (balanceEl) {
                    balanceEl.textContent = data.balance.toFixed(2);
                }
                // sendToReact('BALANCE_UPDATED', { balance: data.balance });
            });

            connection.on("RoomJoined", (data) => {
                myTickets = data.myTickets;
                isGameStarted = data.isGameStarted;
                drawnNumbers = data.drawnNumbers || [];
                winRule = data.winRule || "TAM KART";

                const jackpotEl = document.getElementById("jackpotAmount");
                if (jackpotEl) {
                    jackpotEl.textContent = data.jackpot.toFixed(2);
                }

                const winRuleEl = document.getElementById("winRuleBadge");
                if (winRuleEl) {
                    winRuleEl.textContent = winRule;
                }

                renderTickets();
                updateHistory();

                if (!isGameStarted && data.timeRemaining > 0) {
                    lastTimerValue = data.timeRemaining;
                    startTimer(data.timeRemaining);
                }

                // sendToReact('ROOM_JOINED', {
                //     roomId: currentRoomId,
                //     ticketCount: myTickets.length,
                //     jackpot: data.jackpot
                // });
            });

            connection.on("TicketPurchased", (data) => {
                myTickets.push({ ticketId: data.ticketId, card: data.card });

                const balanceEl = document.getElementById("userBalance");
                if (balanceEl) {
                    balanceEl.textContent = data.balance.toFixed(2);
                }

                showNotification(`‚úÖ Bilet ${data.ticketNumber}/${data.maxTickets} alƒ±ndƒ±`);
                playSound('ticketPurchased');
                renderTickets();
                checkTicketAvailability();

                // sendToReact('BALANCE_UPDATED', { balance: data.balance });
            });

            connection.on("TicketRefreshed", (data) => {
                const ticketIndex = myTickets.findIndex(t => t.ticketId === data.ticketId);
                if (ticketIndex !== -1) {
                    myTickets[ticketIndex].card = data.card;
                    renderTickets();
                    showNotification("‚úÖ Bilet yenil…ôndi!");
                }
            });

            connection.on("TicketDeleted", (ticketId) => {
                myTickets = myTickets.filter(t => t.ticketId !== ticketId);
                console.log("üéüÔ∏è Bilet silindi:", myTickets.length);
                // sendToReact('BALANCE_UPDATED', { balance: data.balance });
                renderTickets();
                checkTicketAvailability();
                showNotification("‚úÖ Bilet silindi v…ô balans qaytarƒ±ldƒ±!");
            });

            connection.on("RoomUpdated", (data) => {
                const jackpotEl = document.getElementById("jackpotAmount");
                if (jackpotEl) {
                    jackpotEl.textContent = data.jackpot.toFixed(2);
                }

                if (!isGameStarted && data.timeRemaining > 0) {
                    if (Math.abs(data.timeRemaining - lastTimerValue) > 5 || lastTimerValue === -1) {
                        lastTimerValue = data.timeRemaining;
                        startTimer(data.timeRemaining);
                    }
                } else if (data.timeRemaining === 0 && !isGameStarted) {
                    stopTimer();
                }
            });

            connection.on("GameStarted", (data) => {
                isGameStarted = true;

                const buyBtn = document.getElementById("buyTicketBtn");
                const timerBadge = document.getElementById("timerBadge");
                const balanceDisplay = document.getElementById("balanceDisplay");

                // const topBarSection = document.querySelector('.top-bar-section');

                if (buyBtn) {
                    buyBtn.remove();
                    timerBadge.remove();
                    balanceDisplay.remove();

                    //     topBarSection.innerHTML =
                    //         `                
                    // <div class="top-bar-section">
                    //     <button id="backBtn" class="exit-button">‚Üê Exit</button>
                    //     <div class="middle-display">
                    //         <div class="jackpot-display">
                    //             üèÜ <span id="jackpotAmount">0.00</span> Coin
                    //         </div>
                    //     </div>
                    //     <div class="side-display" style="width: auto;">
                    //         <div class="win-rule-badge" id="winRuleBadge">Entire Card</div>
                    //     </div>
                    // </div>
                    // `;
                }

                showNotification("üéÆ Oyun ba≈üladƒ±!");

                if (typeof confetti !== 'undefined') {
                    confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                }

                document.querySelectorAll('.btn-refresh, .btn-delete').forEach(btn => {
                    btn.remove();
                });

                stopTimer();
                // sendToReact('GAME_STARTED', { roomId: currentRoomId });
            });

            connection.on("NumberDrawn", (num) => {
                drawnNumbers.push(num);

                const bigBall = document.getElementById("bigBall");
                if (bigBall) {
                    bigBall.textContent = num;
                }

                updateHistory();
                playSound('numberDrawn');
                markNumber(num);
                // sendToReact('NUMBER_DRAWN', { number: num, total: drawnNumbers.length });
            });

            connection.on("BalanceUpdated", (balance) => {
                const balanceEl = document.getElementById("userBalance");
                if (balanceEl) {
                    balanceEl.textContent = balance.toFixed(2);
                }
                // sendToReact('BALANCE_UPDATED', { balance: balance });
            });

            connection.on("GameOver", (data) => {
                console.log("üèÜ ========== GAME OVER EVENT ALINDI ==========");
                console.log("üì¶ Full Data:", JSON.stringify(data, null, 2));

                let winnerText = data.winner || "Nam…ôlum";
                if (data.isBot) {
                    winnerText += ' ü§ñ';
                }

                // const winnerNameEl = document.getElementById("winnerName");
                // if (winnerNameEl) {
                //     winnerNameEl.textContent = winnerText;
                // }

                const winTypeBadge = document.getElementById("winTypeBadge");
                if (winTypeBadge) {
                    winTypeBadge.textContent = data.winType || "Bƒ∞R X∆èTT";
                }

                const prize = data.netPrize || data.prize || 0;
                const prizeEl = document.getElementById("prizeAmount");
                if (prizeEl) {
                    prizeEl.textContent = `${prize.toFixed(2)} ‚Çº`;
                }

                if (data.winningCard) {
                    displayWinningCard(data.winningCard);
                    playSound('win');
                } else {
                    console.error("‚ùå winningCard m…ôlumatƒ± yoxdur!");
                }

                const modal = document.getElementById("gameOverModal");
                if (modal) {
                    modal.classList.add("show");
                    console.log("‚úÖ Modal a√ßƒ±ldƒ±!");
                }

                if (typeof confetti !== 'undefined') {
                    confetti({
                        particleCount: 200,
                        spread: 120,
                        origin: { y: 0.5 },
                        colors: ['#ffd166', '#ff9a3c', '#2dd4bf', '#fff']
                    });

                    setTimeout(() => {
                        confetti({
                            particleCount: 150,
                            angle: 60,
                            spread: 80,
                            origin: { x: 0 }
                        });
                        confetti({
                            particleCount: 150,
                            angle: 120,
                            spread: 80,
                            origin: { x: 1 }
                        });
                    }, 300);
                }

                startCountdown();
                // sendToReact('GAME_ENDED', {
                //     winner: winnerText,
                //     prize: prize,
                //     winType: data.winType
                // });
            });

            connection.on("RoomListUpdated", () => {
                console.log("üìã Otaq siyahƒ±sƒ± yenil…ôndi");
            });

            connection.on("BotTicketAdded", (data) => {
                console.log("ü§ñ Bot bileti …ôlav…ô olundu:", data.playerName);
            });

            connection.on("RoomReset", () => {
                console.log("üîÑ OTAQ RESET EDƒ∞LDƒ∞");
            });
        }

        function startCountdown() {
            let remaining = 10000;
            const countdownEl = document.getElementById("countdownTimer");

            if (countdownEl) {
                countdownEl.textContent = remaining;
            }

            countdownInterval = setInterval(() => {
                remaining--;

                if (countdownEl) {
                    countdownEl.textContent = remaining;
                }

                if (remaining <= 0) {
                    clearInterval(countdownInterval);
                    console.log("‚è∞ 10 saniy…ô bitdi, lobbiy…ô y√∂nl…ôndirilir...");
                    sendToReact('BACK_TO_LOBBY', {});
                }
            }, 1000);
        }

        function displayWinningCard(card) {
            const grid = document.getElementById("winnerCardGrid");
            if (!grid) {
                console.error("‚ùå winnerCardGrid elementi tapƒ±lmadƒ±!");
                return;
            }

            grid.innerHTML = "";

            console.log("üé¥ Rendering winner card:", card);

            if (!card || !Array.isArray(card) || card.length !== 3) {
                console.error("‚ùå Invalid card format:", card);
                grid.innerHTML = "<p style='color: red; grid-column: 1/-1;'>Kart m…ôlumatƒ± y√ºkl…ônm…ôdi</p>";
                return;
            }

            const drawnSet = new Set(drawnNumbers);

            for (let r = 0; r < 3; r++) {
                if (!Array.isArray(card[r]) || card[r].length !== 9) {
                    console.error(`‚ùå Invalid row ${r}:`, card[r]);
                    continue;
                }

                for (let c = 0; c < 9; c++) {
                    const cell = document.createElement("div");
                    const val = card[r][c];

                    if (val === null || val === undefined) {
                        cell.className = "winner-cell blank";
                    } else {
                        const isDrawn = drawnSet.has(val);
                        cell.className = `winner-cell ${isDrawn ? 'winning' : 'not-drawn'}`;
                        cell.textContent = val;
                    }

                    grid.appendChild(cell);
                }
            }

            console.log("‚úÖ Winner card rendered successfully");
        }

        function startTimer(seconds) {
            stopTimer();
            let remaining = seconds;
            const timerBadge = document.getElementById("timerBadge");

            if (!timerBadge) return;

            timerInterval = setInterval(() => {
                remaining--;

                if (remaining <= 0) {
                    stopTimer();
                    // timerBadge.textContent = winRule;
                    return;
                }

                const mins = Math.floor(remaining / 60);
                const secs = remaining % 60;
                timerBadge.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        function renderTickets() {
            const container = document.getElementById("ticketsContainer");
            if (!container) return;

            container.innerHTML = "";

            myTickets.forEach((ticket, index) => {
                const ticketDiv = document.createElement("div");
                ticketDiv.className = "ticket";

                let gridHTML = '';
                for (let r = 0; r < 3; r++) {
                    for (let c = 0; c < 9; c++) {
                        const val = ticket.card[r][c];
                        const isMarked = val !== null && drawnNumbers.includes(val);
                        const cellClass = val === null ? 'cell blank' : `cell ${isMarked ? 'marked' : ''}`;
                        gridHTML += `<div class="${cellClass}">${val ?? ''}</div>`;
                    }
                }

                ticketDiv.innerHTML = `
                <div class="ticket-header">
                    <div class="ticket-number">üé´ Ticket #${index + 1}</div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn-refresh" onclick="refreshTicket('${ticket.ticketId}')"
                                ${isGameStarted ? 'disabled' : ''}>
                            üîÑ Refresh
                        </button>
                        <button class="btn-delete" onclick="deleteTicket('${ticket.ticketId}')"
                                ${isGameStarted ? 'disabled' : ''}>
                            üóëÔ∏è Delete
                        </button>
                        <button class="btn" style="display: none;" onclick="callBingo('${ticket.ticketId}')"
                                ${!isGameStarted ? 'disabled' : ''}>
                            üéØ BINGO
                        </button>
                    </div>
                </div>
                <div class="card-grid">${gridHTML}</div>
            `;

                removeButtons();

                container.appendChild(ticketDiv);
            });
        }

        function removeButtons() {
            if (isGameStarted) {
                document.querySelectorAll('.btn-refresh, .btn-delete').forEach(btn => {
                    btn.remove();
                });
            }
        }

        function checkTicketAvailability() {
            console.log("üéüÔ∏è Bilet almaq ist…ônir, m√∂vcud biletl…ôr sayƒ±:", myTickets.length);

            const buyTicketBtn = document.getElementById("buyTicketBtn");
            if (!buyTicketBtn) return;

            buyTicketBtn.disabled = myTickets.length >= 6;
        }
        function updateHistory() {
            const history = document.getElementById("history");
            if (!history) return;

            history.innerHTML = "";

            const last20 = drawnNumbers.slice(-20).reverse();
            last20.forEach(num => {
                const ball = document.createElement("div");
                ball.className = "history-ball";
                ball.textContent = num;
                history.appendChild(ball);
            });
        }

        function markNumber(num) {
            renderTickets();
        }

        function goToLobby() {
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            sendToReact('BACK_TO_LOBBY', {});
        }

        async function refreshTicket(ticketId) {
            if (!connection || connection.state !== signalR.HubConnectionState.Connected) {
                console.log("‚ùå Baƒülantƒ± yoxdur");
                return;
            }
            try {
                await connection.invoke("RefreshTicket", ticketId);
            } catch (err) {
                console.error("Refresh error:", err);
                console.log("‚ùå Yenil…ôm…ô x…ôtasƒ±");
            }
        }

        async function deleteTicket(ticketId) {
            if (!connection || connection.state !== signalR.HubConnectionState.Connected) {
                console.log("‚ùå Baƒülantƒ± yoxdur");
                return;
            }
            try {
                await connection.invoke("DeleteTicket", ticketId);

            } catch (err) {
                console.error("Delete error:", err);
                console.log("‚ùå Silm…ô x…ôtasƒ±");
            }
        }

        async function callBingo(ticketId) {
            if (!connection || connection.state !== signalR.HubConnectionState.Connected) {
                console.log("‚ùå Baƒülantƒ± yoxdur");
                return;
            }
            try {
                await connection.invoke("Bingo", ticketId);
            } catch (err) {
                console.error("Bingo error:", err);
                console.log("‚ùå Bingo uƒüursuz oldu");
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const buyBtn = document.getElementById("buyTicketBtn");
            const backBtn = document.getElementById("backBtn");

            if (buyBtn) {
                buyBtn.addEventListener("click", async () => {
                    if (!connection || connection.state !== signalR.HubConnectionState.Connected) {
                        console.log("‚ùå Baƒülantƒ± yoxdur");
                        return;
                    }

                    try {
                        const result = await connection.invoke("BuyTicket", currentRoomId);
                        if (!result.success) {
                            console.log("‚ùå " + result.message);
                        }
                    } catch (err) {
                        console.error("Buy ticket error:", err);
                        console.log("‚ùå Bilet almaq alƒ±nmadƒ±");
                    }
                });
            }

            if (backBtn) {
                backBtn.addEventListener("click", async () => {
                    if (myTickets.length > 0 && !isGameStarted) {
                        if (confirm("Biletl…ôriniz silin…ôc…ôk v…ô balans qaytarƒ±lacaq. Davam ed…ôk?")) {
                            if (connection && connection.state === signalR.HubConnectionState.Connected) {
                                try {
                                    for (const ticket of myTickets) {
                                        await connection.invoke("DeleteTicket", ticket.ticketId);
                                    }
                                } catch (err) {
                                    console.error("Exit error:", err);
                                }
                            }
                        }
                    }

                    sendToReact('BACK_TO_LOBBY', {});
                });
            }
        });
        function manageLoading() {
            const loadingContainer = document.getElementById('loadingContainer');
            const gameContainer = document.querySelector('.loto-game-container');

            if (loadingContainer && gameContainer) {
                loadingContainer.style.display = 'none';
                gameContainer.style.display = 'block';
            }
        }


        // async function init() {
        //     console.log('üöÄ [LOTO GAME] init() ba≈üladƒ±');

        //     if (!currentUserToken) {
        //         console.error('‚ùå [LOTO GAME] Token yoxdur!');
        //         return;
        //     }

        //     if (!currentRoomId) {
        //         console.error('‚ùå [LOTO GAME] RoomId yoxdur!');
        //         sendToReact('BACK_TO_LOBBY', {});
        //         return;
        //     }

        //     try {
        //         if (connection) {
        //             console.log("üîÑ [LOTO GAME] K√∂hn…ô connection baƒülanƒ±r...");
        //             try {
        //                 await connection.stop();
        //             } catch (e) {
        //                 console.log('Stop error (ignored):', e);
        //             }
        //             connection = null;
        //         }

        //         await new Promise(resolve => setTimeout(resolve, 100));

        //         connection = createConnection();

        //         console.log("üì° [LOTO GAME] SignalR connection ba≈ülayƒ±r...");
        //         await connection.start(); // ‚Üê AWAIT var, amma yet…ôrli deyil

        //         // ‚Üê BU Hƒ∞SS∆èNƒ∞ ∆èLAV∆è ET - state yoxla:
        //         if (connection.state !== signalR.HubConnectionState.Connected) {
        //             throw new Error('Connection Connected state-d…ô deyil: ' + connection.state);
        //         }

        //         console.log("‚úÖ [LOTO GAME] SignalR connected! State:", connection.state);

        //         console.log("üö™ [LOTO GAME] Joining room:", currentRoomId);
        //         await connection.invoke("JoinRoomView", currentRoomId);
        //         console.log("‚úÖ [LOTO GAME] Room joined!");

        //         sendToReact('CONNECTION_SUCCESS', { roomId: currentRoomId });
        //         manageLoading();

        //     } catch (err) {
        //         console.error("‚ùå [LOTO GAME] Connection error:", err);
        //         console.error("‚ùå Error details:", err.message, err.stack);
        //         console.log("‚ùå Baƒülantƒ± x…ôtasƒ±: " + err.message);
        //         sendToReact('CONNECTION_ERROR', { error: err.message });

        //         // ‚Üê RETRY mexanizmi …ôlav…ô et (optional):
        //         setTimeout(() => {
        //             console.log('üîÑ Retry edilir...');
        //             init();
        //         }, 2000);
        //     }
        // }

        async function init() {
            console.log('üöÄ [LOTO GAME] init() ba≈üladƒ±');

            // Token yoxlamasƒ±
            const token = getToken();
            if (!token) {
                console.error('‚ùå [LOTO GAME] Token yoxdur!');
                showNotification('Giri≈ü m…ôlumatlarƒ± tapƒ±lmadƒ±. S…ôhif…ôni yenil…ôyin.');
                return;
            }

            if (!currentRoomId) {
                console.error('‚ùå [LOTO GAME] RoomId yoxdur!');
                sendToReact('BACK_TO_LOBBY', {});
                return;
            }

            try {
                // K√∂hn…ô connection-u baƒüla
                if (connection) {
                    console.log("üîÑ [LOTO GAME] K√∂hn…ô connection baƒülanƒ±r...");
                    try {
                        await connection.stop();
                    } catch (e) {
                        console.log('Stop error (ignored):', e);
                    }
                    connection = null;
                }

                // Ki√ßik pause
                await new Promise(resolve => setTimeout(resolve, 200));

                console.log('‚úÖ [LOTO] Token m√∂vcuddur, connection yaradƒ±lƒ±r...');
                connection = createConnection();

                console.log("üîÑ [LOTO GAME] SignalR.start() √ßaƒüƒ±rƒ±lƒ±r...");
                await connection.start();

                // State yoxlama
                if (connection.state !== signalR.HubConnectionState.Connected) {
                    throw new Error('Connection Connected state-d…ô deyil: ' + connection.state);
                }

                console.log("‚úÖ [LOTO GAME] SignalR connected! State:", connection.state);

                console.log("üö™ [LOTO GAME] Joining room:", currentRoomId);
                await connection.invoke("JoinRoomView", currentRoomId);
                console.log("‚úÖ [LOTO GAME] Room joined!");

                sendToReact('CONNECTION_SUCCESS', { roomId: currentRoomId });
                manageLoading();

            } catch (err) {
                console.error("‚ùå [LOTO GAME] Connection error:", err);
                console.error("‚ùå Error details:", err.message);
                console.error("‚ùå Stack:", err.stack);
                showNotification("‚ùå Baƒülantƒ± x…ôtasƒ±: " + err.message);
                sendToReact('CONNECTION_ERROR', { error: err.message });

                // Retry (optional - ≈ü…ôrtli)
                if (!err.message.includes('Token')) {
                    setTimeout(() => {
                        console.log('üîÑ Retry edilir...');
                        init();
                    }, 3000);
                }
            }
        }

        console.log('‚úÖ [LOTO GAME] Script tam y√ºkl…ôndi, postMessage g√∂zl…ônilir...');
    </script>
</body>

</html>