<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>10 Line Loto - Oyun</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/canvas-confetti/1.6.0/confetti.browser.min.js"></script>
    <link rel="stylesheet" href="./Loto.css" />
</head>

<body>
    <div id="loadingContainer" class="loading-container">
        <div class="loading-stage">
            <div class="loto-aurora"></div>

            <div class="ticket-stack">
                <div class="ticket ticket-shadow"></div>
                <div class="ticket ticket-front">
                    <div class="ticket-heading">LOTO</div>
                    <div class="ticket-grid">
                        <span>7</span><span>17</span><span>27</span><span>37</span><span>77</span>
                        <span>8</span><span>57</span><span>47</span><span>67</span><span>88</span>
                    </div>
                </div>
            </div>

            <div class="ball-orbit">
                <div class="orbit">
                    <div class="loto-ball">7</div>
                    <div class="loto-ball">14</div>
                    <div class="loto-ball">22</div>
                    <div class="loto-ball">36</div>
                    <div class="loto-ball">45</div>
                    <div class="loto-ball">60</div>
                </div>
            </div>

            <!-- Main roulette wheel -->
            <div class="roulette-wheel">
                <div class="wheel-outer">
                    <div class="wheel-inner">
                        <div class="wheel-segment"></div>
                        <div class="wheel-segment"></div>
                        <div class="wheel-segment"></div>
                        <div class="wheel-segment"></div>
                        <div class="wheel-segment"></div>
                        <div class="wheel-segment"></div>
                        <div class="wheel-segment"></div>
                        <div class="wheel-segment"></div>
                        <div class="wheel-center"></div>
                    </div>
                </div>
            </div>

            <!-- Text -->
            <div class="loading-text" data-i18n="loading">LOADING</div>
            <div class="loading-subtext" data-i18n="preparing">PREPARING YOUR GAME</div>

            <!-- Progress dots -->
            <div class="dots">
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
            </div>
        </div>
    </div>
    <div style="display: none;" class="loto-game-container">
        <div class="top-bar-game">
            <div class="top-bar-side">
                <div class="top-bar-section">
                    <div class="side-display">
                        <div class="win-rule-badge" id="winRuleBadge" data-i18n="win_rule_entire_card">Entire Card
                        </div>
                        <button id="backBtn" class="exit-button" data-i18n="exit">‚Üê Exit</button>
                    </div>
                    <div class="middle-display">
                        <div class="jackpot-display">
                            üèÜ <span id="jackpotAmount">0.00</span> <span data-i18n="coin">Coin</span>
                        </div>
                        <div id="balanceDisplay" class="balance-display">üí∞ <span id="userBalance">0.00</span> <span
                                data-i18n="coin">Coin</span>
                        </div>
                    </div>
                    <div class="side-display">
                        <div class="side-side">
                            <div class="win-rule-badge" id="timerBadge">0:00</div>
                            <button class="mute-toggle active" onclick="toggleMute(this)" aria-label="Toggle sound">
                                <span class="icon">üîä</span>
                            </button>
                        </div>
                        <button id="buyTicketBtn" onclick="checkTicketAvailability()" class="buy-ticket-button"
                            data-i18n="buy_ticket">+ Buy ticket</button>
                    </div>
                </div>
            </div>

        </div>

        <div class="drawn-number">
            <div class="big-ball" id="bigBall">--</div>
            <div class="history" id="history"></div>
        </div>

        <div class="tickets-container" id="ticketsContainer"></div>

        <div id="gameOverModal" class="modal">
            <div class="modal-content">
                <div class="countdown-timer" id="countdownTimer">10</div>
                <h2 data-i18n="winner_title">üèÜ WINNER üèÜ</h2>
                <!-- <div class="winner-name" id="winnerName"></div> -->
                <div class="win-type-badge" id="winTypeBadge"></div>
                <div class="prize-amount" id="prizeAmount"></div>
                <div class="winner-card-display">
                    <h3 data-i18n="winner_ticket">üé´ Winner Ticket</h3>
                    <div class="winner-card-grid" id="winnerCardGrid"></div>
                </div>
                <button class="btn" onclick="goToLobby()"
                    style="margin-top: 20px; font-size: 18px; padding: 15px 40px;">
                    <span data-i18n="return_to_lobby">Return to Lobby</span>
                </button>
            </div>
        </div>
    </div>


    <script>
        //Audios
        let isMuted = false;

        const sounds = {
            ticketPurchased: new Audio('./lotoSounds/ticketPurchased.mp3'),
            win: new Audio('./lotoSounds/winSound.mp3'),
            numberDrawn: new Audio('./lotoSounds/numberDrawn.mp3'),
        }
        // iOS / Chrome √º√ß√ºn preload
        Object.values(sounds).forEach(sound => {
            sound.preload = 'auto';
            sound.volume = 0.8;
        });
        function playSound(name) {
            if (isMuted) return;

            const sound = sounds[name];
            if (!sound) {
                console.warn('Sound not found:', name);
                return;
            }

            sound.currentTime = 0; // t…ôkrar √ßalmaq √º√ß√ºn
            sound.play().catch(() => {
                // autoplay policy fallback
            });
        }
        function unlockAudio() {
            Object.values(sounds).forEach(sound => {
                sound.play()
                    .then(() => {
                        sound.pause();
                        sound.currentTime = 0;
                    })
                    .catch(() => { });
            });

            console.log("üîì Audio unlocked");
        }
        document.addEventListener('touchstart', unlockAudio, { once: true });
        document.addEventListener('click', unlockAudio, { once: true });

        //mute Toggle
        function toggleMute(button) {
            isMuted = !isMuted;
            const isActive = button.classList.contains('active');
            const icon = button.querySelector('.icon');

            if (isActive) {
                // Mute
                button.classList.remove('active');
                icon.textContent = 'üîá';
            } else {
                // Unmute
                button.classList.add('active');
                icon.textContent = 'üîä';
            }
        }


        // ============================================
        // React-d…ôn user data
        // ============================================
        let currentUserToken = null;
        let currentUserData = null;
        let currentRoomId = null;

        let isInitialized = false;
        let currentLanguage = 'en';

        const translations = {
            en: {
                loading: 'LOADING',
                preparing: 'PREPARING YOUR GAME',
                exit: '‚Üê Exit',
                coin: 'Coin',
                buy_ticket: '+ Buy ticket',
                winner_title: 'üèÜ WINNER üèÜ',
                winner_ticket: 'üé´ Winner Ticket',
                return_to_lobby: 'Return to Lobby',
                win_rule_entire_card: 'Entire Card',
                win_rule_full_card: 'Full Card',
                win_rule_single_line: 'Single Line',
                notification_ticket_purchased: '‚úÖ Ticket {current}/{max} purchased',
                notification_ticket_refreshed: '‚úÖ Ticket refreshed!',
                notification_ticket_deleted: '‚úÖ Ticket deleted and balance refunded!',
                notification_game_started: 'üéÆ Game started!',
                notification_connection_lost: 'Connection lost, retrying...',
                notification_connection_restored: 'Connection restored!',
                notification_token_problem: 'Token problem! Refresh the page.',
                notification_missing_login: 'Login data not found. Refresh the page.',
                notification_connection_error: '‚ùå Connection error: {message}',
                ticket_number: 'üé´ Ticket #{number}',
                refresh: 'üîÑ Refresh',
                delete: 'üóëÔ∏è Delete',
                bingo: 'üéØ BINGO',
                confirm_exit: 'Your tickets will be deleted and balance refunded. Continue?',
                invalid_card: 'Card data failed to load'
            },
            tr: {
                loading: 'Y√úKLENƒ∞YOR',
                preparing: 'OYUN HAZIRLANIYOR',
                exit: '‚Üê √áƒ±kƒ±≈ü',
                coin: 'Jeton',
                buy_ticket: '+ Bilet al',
                winner_title: 'üèÜ KAZANAN üèÜ',
                winner_ticket: 'üé´ Kazanan Bilet',
                return_to_lobby: 'Lobiye d√∂n',
                win_rule_entire_card: 'T√ºm Kart',
                win_rule_full_card: 'Tam Kart',
                win_rule_single_line: 'Tek √áizgi',
                notification_ticket_purchased: '‚úÖ Bilet {current}/{max} alƒ±ndƒ±',
                notification_ticket_refreshed: '‚úÖ Bilet yenilendi!',
                notification_ticket_deleted: '‚úÖ Bilet silindi ve bakiye iade edildi!',
                notification_game_started: 'üéÆ Oyun ba≈üladƒ±!',
                notification_connection_lost: 'Baƒülantƒ± kesildi, tekrar deneniyor...',
                notification_connection_restored: 'Baƒülantƒ± geri geldi!',
                notification_token_problem: 'Token problemi! Sayfayƒ± yenileyin.',
                notification_missing_login: 'Giri≈ü bilgileri bulunamadƒ±. Sayfayƒ± yenileyin.',
                notification_connection_error: '‚ùå Baƒülantƒ± hatasƒ±: {message}',
                ticket_number: 'üé´ Bilet #{number}',
                refresh: 'üîÑ Yenile',
                delete: 'üóëÔ∏è Sil',
                bingo: 'üéØ BINGO',
                confirm_exit: 'Biletleriniz silinecek ve bakiye iade edilecek. Devam edilsin mi?',
                invalid_card: 'Kart verisi y√ºklenemedi'
            },
            hi: {
                loading: '‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à',
                preparing: '‡§Ü‡§™‡§ï‡§æ ‡§ó‡•á‡§Æ ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à',
                exit: '‚Üê ‡§¨‡§æ‡§π‡§∞ ‡§ú‡§æ‡§è‡§Ç',
                coin: '‡§∏‡§ø‡§ï‡•ç‡§ï‡§æ',
                buy_ticket: '+ ‡§ü‡§ø‡§ï‡§ü ‡§ñ‡§∞‡•Ä‡§¶‡•á‡§Ç',
                winner_title: 'üèÜ ‡§µ‡§ø‡§ú‡•á‡§§‡§æ üèÜ',
                winner_ticket: 'üé´ ‡§µ‡§ø‡§ú‡•á‡§§‡§æ ‡§ü‡§ø‡§ï‡§ü',
                return_to_lobby: '‡§≤‡•â‡§¨‡•Ä ‡§Æ‡•á‡§Ç ‡§µ‡§æ‡§™‡§∏ ‡§ú‡§æ‡§è‡§Ç',
                win_rule_entire_card: '‡§™‡•Ç‡§∞‡§æ ‡§ï‡§æ‡§∞‡•ç‡§°',
                win_rule_full_card: '‡§™‡•Ç‡§∞‡§æ ‡§ï‡§æ‡§∞‡•ç‡§°',
                win_rule_single_line: '‡§è‡§ï ‡§™‡§Ç‡§ï‡•ç‡§§‡§ø',
                notification_ticket_purchased: '‚úÖ ‡§ü‡§ø‡§ï‡§ü {current}/{max} ‡§ñ‡§∞‡•Ä‡§¶‡§æ ‡§ó‡§Ø‡§æ',
                notification_ticket_refreshed: '‚úÖ ‡§ü‡§ø‡§ï‡§ü ‡§∞‡•Ä‡§´‡•ç‡§∞‡•á‡§∂ ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ!',
                notification_ticket_deleted: '‚úÖ ‡§ü‡§ø‡§ï‡§ü ‡§π‡§ü‡§æ‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§î‡§∞ ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ ‡§µ‡§æ‡§™‡§∏ ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ!',
                notification_game_started: 'üéÆ ‡§ó‡•á‡§Æ ‡§∂‡•Å‡§∞‡•Ç ‡§π‡•ã ‡§ó‡§Ø‡§æ!',
                notification_connection_lost: '‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® ‡§ü‡•Ç‡§ü ‡§ó‡§Ø‡§æ, ‡§´‡§ø‡§∞ ‡§∏‡•á ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à...',
                notification_connection_restored: '‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® ‡§¨‡§π‡§æ‡§≤ ‡§π‡•ã ‡§ó‡§Ø‡§æ!',
                notification_token_problem: '‡§ü‡•ã‡§ï‡§® ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ! ‡§™‡•á‡§ú ‡§∞‡§ø‡§´‡•ç‡§∞‡•á‡§∂ ‡§ï‡§∞‡•á‡§Ç‡•§',
                notification_missing_login: '‡§≤‡•â‡§ó‡§ø‡§® ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä‡•§ ‡§™‡•á‡§ú ‡§∞‡§ø‡§´‡•ç‡§∞‡•á‡§∂ ‡§ï‡§∞‡•á‡§Ç‡•§',
                notification_connection_error: '‚ùå ‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: {message}',
                ticket_number: 'üé´ ‡§ü‡§ø‡§ï‡§ü #{number}',
                refresh: 'üîÑ ‡§∞‡•Ä‡§´‡•ç‡§∞‡•á‡§∂',
                delete: 'üóëÔ∏è ‡§π‡§ü‡§æ‡§è‡§Ç',
                bingo: 'üéØ ‡§¨‡§ø‡§Ç‡§ó‡•ã',
                confirm_exit: '‡§Ü‡§™‡§ï‡•á ‡§ü‡§ø‡§ï‡§ü ‡§π‡§ü ‡§ú‡§æ‡§è‡§Ç‡§ó‡•á ‡§î‡§∞ ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ ‡§µ‡§æ‡§™‡§∏ ‡§π‡•ã‡§ó‡§æ‡•§ ‡§ú‡§æ‡§∞‡•Ä ‡§∞‡§ñ‡•á‡§Ç?',
                invalid_card: '‡§ï‡§æ‡§∞‡•ç‡§° ‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§Ü'
            },
            ru: {
                loading: '–ó–ê–ì–†–£–ó–ö–ê',
                preparing: '–ü–û–î–ì–û–¢–û–í–ö–ê –ò–ì–†–´',
                exit: '‚Üê –í—ã—Ö–æ–¥',
                coin: '–ú–æ–Ω–µ—Ç–∞',
                buy_ticket: '+ –ö—É–ø–∏—Ç—å –±–∏–ª–µ—Ç',
                winner_title: 'üèÜ –ü–û–ë–ï–î–ò–¢–ï–õ–¨ üèÜ',
                winner_ticket: 'üé´ –ë–∏–ª–µ—Ç –ø–æ–±–µ–¥–∏—Ç–µ–ª—è',
                return_to_lobby: '–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –ª–æ–±–±–∏',
                win_rule_entire_card: '–í—Å—è –∫–∞—Ä—Ç–∞',
                win_rule_full_card: '–ü–æ–ª–Ω–∞—è –∫–∞—Ä—Ç–∞',
                win_rule_single_line: '–û–¥–Ω–∞ –ª–∏–Ω–∏—è',
                notification_ticket_purchased: '‚úÖ –ë–∏–ª–µ—Ç {current}/{max} –∫—É–ø–ª–µ–Ω',
                notification_ticket_refreshed: '‚úÖ –ë–∏–ª–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω!',
                notification_ticket_deleted: '‚úÖ –ë–∏–ª–µ—Ç —É–¥–∞–ª–µ–Ω, –±–∞–ª–∞–Ω—Å –≤–æ–∑–≤—Ä–∞—â–µ–Ω!',
                notification_game_started: 'üéÆ –ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å!',
                notification_connection_lost: '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ, –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞...',
                notification_connection_restored: '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!',
                notification_token_problem: '–ü—Ä–æ–±–ª–µ–º–∞ —Å —Ç–æ–∫–µ–Ω–æ–º! –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.',
                notification_missing_login: '–î–∞–Ω–Ω—ã–µ –≤—Ö–æ–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.',
                notification_connection_error: '‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: {message}',
                ticket_number: 'üé´ –ë–∏–ª–µ—Ç #{number}',
                refresh: 'üîÑ –û–±–Ω–æ–≤–∏—Ç—å',
                delete: 'üóëÔ∏è –£–¥–∞–ª–∏—Ç—å',
                bingo: 'üéØ –ë–ò–ù–ì–û',
                confirm_exit: '–í–∞—à–∏ –±–∏–ª–µ—Ç—ã –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã, –±–∞–ª–∞–Ω—Å –≤–µ—Ä–Ω–µ—Ç—Å—è. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?',
                invalid_card: '–î–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã'
            },
            ar: {
                loading: 'ÿ¨ÿßÿ±Ÿç ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ',
                preparing: 'ÿ¨ÿßÿ±Ÿç ÿ™ÿ¨ŸáŸäÿ≤ ŸÑÿπÿ®ÿ™ŸÉ',
                exit: '‚Üê ÿÆÿ±Ÿàÿ¨',
                coin: 'ÿπŸÖŸÑÿ©',
                buy_ticket: '+ ÿ¥ÿ±ÿßÿ° ÿ™ÿ∞ŸÉÿ±ÿ©',
                winner_title: 'üèÜ ÿßŸÑŸÅÿßÿ¶ÿ≤ üèÜ',
                winner_ticket: 'üé´ ÿ™ÿ∞ŸÉÿ±ÿ© ÿßŸÑŸÅÿßÿ¶ÿ≤',
                return_to_lobby: 'ÿßŸÑÿπŸàÿØÿ© ÿ•ŸÑŸâ ÿßŸÑÿ±ÿØŸáÿ©',
                win_rule_entire_card: 'ÿßŸÑÿ®ÿ∑ÿßŸÇÿ© ŸÉÿßŸÖŸÑÿ©',
                win_rule_full_card: 'ÿßŸÑÿ®ÿ∑ÿßŸÇÿ© ŸÉÿßŸÖŸÑÿ©',
                win_rule_single_line: 'ÿ≥ÿ∑ÿ± Ÿàÿßÿ≠ÿØ',
                notification_ticket_purchased: '‚úÖ ÿ™ŸÖ ÿ¥ÿ±ÿßÿ° ÿ™ÿ∞ŸÉÿ±ÿ© {current}/{max}',
                notification_ticket_refreshed: '‚úÖ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ™ÿ∞ŸÉÿ±ÿ©!',
                notification_ticket_deleted: '‚úÖ ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ™ÿ∞ŸÉÿ±ÿ© Ÿàÿ•ÿ±ÿ¨ÿßÿπ ÿßŸÑÿ±ÿµŸäÿØ!',
                notification_game_started: 'üéÆ ÿ®ÿØÿ£ÿ™ ÿßŸÑŸÑÿπÿ®ÿ©!',
                notification_connection_lost: 'ÿßŸÜŸÇÿ∑ÿπ ÿßŸÑÿßÿ™ÿµÿßŸÑÿå ÿ¨ÿßÿ±Ÿç ÿ•ÿπÿßÿØÿ© ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ©...',
                notification_connection_restored: 'ÿ™ŸÖ ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ!',
                notification_token_problem: 'ŸÖÿ¥ŸÉŸÑÿ© ŸÅŸä ÿßŸÑÿ±ŸÖÿ≤! ÿ≠ÿØŸëÿ´ ÿßŸÑÿµŸÅÿ≠ÿ©.',
                notification_missing_login: 'ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿØÿÆŸàŸÑ. ÿ≠ÿØŸëÿ´ ÿßŸÑÿµŸÅÿ≠ÿ©.',
                notification_connection_error: '‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ: {message}',
                ticket_number: 'üé´ ÿ™ÿ∞ŸÉÿ±ÿ© ÿ±ŸÇŸÖ {number}',
                refresh: 'üîÑ ÿ™ÿ≠ÿØŸäÿ´',
                delete: 'üóëÔ∏è ÿ≠ÿ∞ŸÅ',
                bingo: 'üéØ ÿ®ŸäŸÜÿ∫Ÿà',
                confirm_exit: 'ÿ≥Ÿäÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿ™ÿ∞ÿßŸÉÿ±ŸÉ Ÿàÿ•ÿ±ÿ¨ÿßÿπ ÿßŸÑÿ±ÿµŸäÿØ. ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ©ÿü',
                invalid_card: 'ŸÅÿ¥ŸÑ ÿ™ÿ≠ŸÖŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ®ÿ∑ÿßŸÇÿ©'
            },
            uz: {
                loading: 'YUKLANMOQDA',
                preparing: 'O‚ÄòYIN TAYYORLANMOQDA',
                exit: '‚Üê Chiqish',
                coin: 'Tanga',
                buy_ticket: '+ Bilet sotib olish',
                winner_title: 'üèÜ G‚ÄòOLIB üèÜ',
                winner_ticket: 'üé´ G‚Äòolib bileti',
                return_to_lobby: 'Lobbiga qaytish',
                win_rule_entire_card: 'Butun karta',
                win_rule_full_card: 'To‚Äòliq karta',
                win_rule_single_line: 'Bitta qator',
                notification_ticket_purchased: '‚úÖ Bilet {current}/{max} sotib olindi',
                notification_ticket_refreshed: '‚úÖ Bilet yangilandi!',
                notification_ticket_deleted: '‚úÖ Bilet o‚Äòchirildi va balans qaytarildi!',
                notification_game_started: 'üéÆ O‚Äòyin boshlandi!',
                notification_connection_lost: 'Ulanish uzildi, qayta urinilmoqda...',
                notification_connection_restored: 'Ulanish tiklandi!',
                notification_token_problem: 'Token muammosi! Sahifani yangilang.',
                notification_missing_login: 'Kirish ma‚Äôlumotlari topilmadi. Sahifani yangilang.',
                notification_connection_error: '‚ùå Ulanish xatosi: {message}',
                ticket_number: 'üé´ Bilet #{number}',
                refresh: 'üîÑ Yangilash',
                delete: 'üóëÔ∏è O‚Äòchirish',
                bingo: 'üéØ BINGO',
                confirm_exit: 'Biletlar o‚Äòchirilib, balans qaytariladi. Davom etilsinmi?',
                invalid_card: 'Karta ma‚Äôlumoti yuklanmadi'
            }
        };

        function normalizeLanguage(lang) {
            if (!lang || typeof lang !== 'string') return 'en';
            const key = lang.trim().toLowerCase();
            if (['en', 'eng', 'english'].includes(key)) return 'en';
            if (['tr', 'tur', 'turkish', 'tr-tr'].includes(key)) return 'tr';
            if (['hi', 'hin', 'hindi', 'indian', 'india'].includes(key)) return 'hi';
            if (['ru', 'rus', 'russian', 'ru-ru'].includes(key)) return 'ru';
            if (['ar', 'ara', 'arabic', 'ar-sa', 'ar-ae'].includes(key)) return 'ar';
            if (['uz', 'uzb', 'uzbek', 'uz-uz'].includes(key)) return 'uz';
            return 'en';
        }

        function t(key, vars = {}) {
            const dict = translations[currentLanguage] || translations.en;
            let text = dict[key] || translations.en[key] || key;
            Object.keys(vars).forEach(k => {
                text = text.replace(`{${k}}`, vars[k]);
            });
            return text;
        }

        function applyLanguage(lang) {
            currentLanguage = normalizeLanguage(lang);
            document.documentElement.lang = currentLanguage;
            document.documentElement.dir = currentLanguage === 'ar' ? 'rtl' : 'ltr';

            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                el.textContent = t(key);
            });

            // const winRuleEl = document.getElementById("winRuleBadge");
            // if (winRuleEl) {
            //     winRuleEl.textContent = translateWinRule(winRule);
            // }

            // renderTickets();
        }

        function translateWinRule(rule) {
            if (!rule) return t('win_rule_entire_card');
            const r = rule.toString().toUpperCase();
            if (r.includes('TAM KART') || r.includes('FULL CARD') || r.includes('ENTIRE CARD')) {
                return t('win_rule_full_card');
            }
            if (r.includes('Bƒ∞R X∆èTT') || r.includes('SINGLE LINE')) {
                return t('win_rule_single_line');
            }
            return rule;
        }

        applyLanguage(currentLanguage);

        console.log('üéÆ [LOTO GAME] Script y√ºkl…ôndi');

        window.addEventListener('message', (event) => {
            console.log('üì® [LOTO GAME] Message alƒ±ndƒ±:', event.data);

            if (event.data && event.data.payload.language) {
                applyLanguage(event.data.payload.language);
            }

            if (event.data && event.data.type === 'INIT_USER') {
                console.log('‚úÖ [LOTO GAME] INIT_USER q…ôbul edildi');

                currentUserData = event.data.payload;
                currentUserToken = currentUserData.token;
                currentRoomId = currentUserData.roomId;

                console.log('üë§ [LOTO GAME] User:', currentUserData.username);
                console.log('üé´ [LOTO GAME] Token:', currentUserToken ? 'VAR' : 'YOX');
                console.log('üéØ [LOTO GAME] RoomId:', currentRoomId);

                const balanceEl = document.getElementById("userBalance");
                if (balanceEl) {
                    balanceEl.textContent = currentUserData.balance.toFixed(2);
                }

                console.log('üöÄ [LOTO GAME] init() √ßaƒüƒ±rƒ±lƒ±r...');
                // Yalnƒ±z bir d…ôf…ô init et
                if (!isInitialized) {
                    isInitialized = true;
                    console.log('üöÄ [LOTO GAME] init() √ßaƒüƒ±rƒ±lƒ±r...');
                    init();
                } else {
                    console.log('‚ö†Ô∏è [LOTO GAME] Artƒ±q initialize olunub');
                }
            }
        });

        function sendToReact(type, payload) {
            console.log('üì§ [LOTO GAME] React-a mesaj:', { type, payload });
            window.parent.postMessage({ type, payload }, '*');
        }

        function getToken() {
            const token = currentUserToken || "";
            console.log('üîë [LOTO GAME] getToken √ßaƒürƒ±ldƒ±:', token ? 'VAR (' + token.substring(0, 20) + '...)' : 'YOX');
            return token;
        }

        // ============================================
        // Oyun d…ôyi≈ü…ônl…ôri
        // ============================================
        let connection = null;
        let myTickets = [];
        let drawnNumbers = [];
        let isGameStarted = false;
        let winRule = "TAM KART";
        let timerInterval = null;
        let lastTimerValue = -1;
        let countdownInterval = null;

        function showNotification(message) {
            const notif = document.createElement('div');
            notif.className = 'notification';
            notif.textContent = message;
            document.body.appendChild(notif);
            setTimeout(() => notif.remove(), 3000);
        }

        // function createConnection() {
        //     connection = new signalR.HubConnectionBuilder()
        //         .withUrl("https://nehemiah-paginal-alan.ngrok-free.dev/lotoHub", {
        //             accessTokenFactory: () => getToken()
        //         })
        //         .withAutomaticReconnect()
        //         .configureLogging(signalR.LogLevel.Information)
        //         .build();

        //     setupHandlers();
        //     return connection;
        // }


        function createConnection() {
            const token = getToken();
            console.log('üîë [LOTO] Creating connection with token:', token ? '‚úÖ VAR (' + token.substring(0, 30) + '...)' : '‚ùå YOX');

            if (!token) {
                console.error('‚ùå [LOTO] Token yoxdur! SignalR yaradƒ±lmƒ±r');
                throw new Error('Token tapƒ±lmadƒ±');
            }

            connection = new signalR.HubConnectionBuilder()
                .withUrl("https://nehemiah-paginal-alan.ngrok-free.dev/lotoHub", {
                    accessTokenFactory: () => {
                        const t = getToken();
                        console.log('üé´ [LOTO] accessTokenFactory √ßaƒüƒ±rƒ±ldƒ±:', t ? 'Token g√∂nd…ôrilir' : 'Token YOX!');
                        if (!t) {
                            console.error('‚ùå [LOTO] CRITICAL: Token null/empty!');
                        }
                        return t;
                    },
                    skipNegotiation: false,
                    transport: signalR.HttpTransportType.WebSockets | signalR.HttpTransportType.LongPolling,
                    withCredentials: false
                })
                .withAutomaticReconnect({
                    nextRetryDelayInMilliseconds: (retryContext) => {
                        if (retryContext.elapsedMilliseconds < 60000) {
                            return Math.random() * 10000;
                        } else {
                            return null;
                        }
                    }
                })
                .configureLogging(signalR.LogLevel.Debug)
                .build();

            connection.onclose((error) => {
                console.error('‚ùå [LOTO] Connection closed:', error);
                if (!getToken()) {
                    showNotification(t('notification_token_problem'));
                }
            });

            connection.onreconnecting((error) => {
                console.log('üîÑ [LOTO] Reconnecting...', error);
                showNotification(t('notification_connection_lost'));
            });

            connection.onreconnected((connectionId) => {
                console.log('‚úÖ [LOTO] Reconnected:', connectionId);
                showNotification(t('notification_connection_restored'));
            });

            setupHandlers();
            return connection;
        }

        function setupHandlers() {
            console.log("üì° Setting up SignalR handlers...");

            connection.on("UserData", (data) => {
                const balanceEl = document.getElementById("userBalance");
                if (balanceEl) {
                    balanceEl.textContent = data.balance.toFixed(2);
                }
                // sendToReact('BALANCE_UPDATED', { balance: data.balance });
            });

            connection.on("RoomJoined", (data) => {
                myTickets = data.myTickets;
                isGameStarted = data.isGameStarted;
                drawnNumbers = data.drawnNumbers || [];
                winRule = data.winRule || "TAM KART";

                const jackpotEl = document.getElementById("jackpotAmount");
                if (jackpotEl) {
                    jackpotEl.textContent = data.jackpot.toFixed(2);
                }

                const winRuleEl = document.getElementById("winRuleBadge");
                if (winRuleEl) {
                    winRuleEl.textContent = translateWinRule(winRule);
                }

                renderTickets();
                updateHistory();

                if (!isGameStarted && data.timeRemaining > 0) {
                    lastTimerValue = data.timeRemaining;
                    startTimer(data.timeRemaining);
                }

                // sendToReact('ROOM_JOINED', {
                //     roomId: currentRoomId,
                //     ticketCount: myTickets.length,
                //     jackpot: data.jackpot
                // });
            });

            connection.on("TicketPurchased", (data) => {
                myTickets.push({ ticketId: data.ticketId, card: data.card });

                const balanceEl = document.getElementById("userBalance");
                if (balanceEl) {
                    balanceEl.textContent = data.balance.toFixed(2);
                }

                showNotification(t('notification_ticket_purchased', { current: data.ticketNumber, max: data.maxTickets }));
                playSound('ticketPurchased');
                renderTickets();
                checkTicketAvailability();

                // sendToReact('BALANCE_UPDATED', { balance: data.balance });
            });

            connection.on("TicketRefreshed", (data) => {
                const ticketIndex = myTickets.findIndex(t => t.ticketId === data.ticketId);
                if (ticketIndex !== -1) {
                    myTickets[ticketIndex].card = data.card;
                    renderTickets();
                    showNotification(t('notification_ticket_refreshed'));
                }
            });

            connection.on("TicketDeleted", (ticketId) => {
                myTickets = myTickets.filter(t => t.ticketId !== ticketId);
                console.log("üéüÔ∏è Bilet silindi:", myTickets.length);
                // sendToReact('BALANCE_UPDATED', { balance: data.balance });
                renderTickets();
                checkTicketAvailability();
                showNotification(t('notification_ticket_deleted'));
            });

            connection.on("RoomUpdated", (data) => {
                const jackpotEl = document.getElementById("jackpotAmount");
                if (jackpotEl) {
                    jackpotEl.textContent = data.jackpot.toFixed(2);
                }

                if (!isGameStarted && data.timeRemaining > 0) {
                    if (Math.abs(data.timeRemaining - lastTimerValue) > 5 || lastTimerValue === -1) {
                        lastTimerValue = data.timeRemaining;
                        startTimer(data.timeRemaining);
                    }
                } else if (data.timeRemaining === 0 && !isGameStarted) {
                    stopTimer();
                }
            });

            connection.on("GameStarted", (data) => {
                isGameStarted = true;

                const buyBtn = document.getElementById("buyTicketBtn");
                const timerBadge = document.getElementById("timerBadge");
                const balanceDisplay = document.getElementById("balanceDisplay");

                // const topBarSection = document.querySelector('.top-bar-section');

                if (buyBtn) {
                    buyBtn.remove();
                    timerBadge.remove();
                    balanceDisplay.remove();

                    //     topBarSection.innerHTML =
                    //         `                
                    // <div class="top-bar-section">
                    //     <button id="backBtn" class="exit-button">‚Üê Exit</button>
                    //     <div class="middle-display">
                    //         <div class="jackpot-display">
                    //             üèÜ <span id="jackpotAmount">0.00</span> Coin
                    //         </div>
                    //     </div>
                    //     <div class="side-display" style="width: auto;">
                    //         <div class="win-rule-badge" id="winRuleBadge">Entire Card</div>
                    //     </div>
                    // </div>
                    // `;
                }

                showNotification(t('notification_game_started'));

                if (typeof confetti !== 'undefined') {
                    confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                }

                document.querySelectorAll('.btn-refresh, .btn-delete').forEach(btn => {
                    btn.remove();
                });

                stopTimer();
                // sendToReact('GAME_STARTED', { roomId: currentRoomId });
            });

            connection.on("NumberDrawn", (num) => {
                drawnNumbers.push(num);

                const bigBall = document.getElementById("bigBall");
                if (bigBall) {
                    bigBall.textContent = num;
                }

                updateHistory();
                playSound('numberDrawn');
                markNumber(num);
                // sendToReact('NUMBER_DRAWN', { number: num, total: drawnNumbers.length });
            });

            connection.on("BalanceUpdated", (balance) => {
                const balanceEl = document.getElementById("userBalance");
                if (balanceEl) {
                    balanceEl.textContent = balance.toFixed(2);
                }
                // sendToReact('BALANCE_UPDATED', { balance: balance });
            });

            connection.on("GameOver", (data) => {
                console.log("üèÜ ========== GAME OVER EVENT ALINDI ==========");
                console.log("üì¶ Full Data:", JSON.stringify(data, null, 2));

                let winnerText = data.winner || "Nam…ôlum";
                if (data.isBot) {
                    winnerText += ' ü§ñ';
                }

                // const winnerNameEl = document.getElementById("winnerName");
                // if (winnerNameEl) {
                //     winnerNameEl.textContent = winnerText;
                // }

                const winTypeBadge = document.getElementById("winTypeBadge");
                if (winTypeBadge) {
                    winTypeBadge.textContent = data.winType || "Bƒ∞R X∆èTT";
                }

                const prize = data.netPrize || data.prize || 0;
                const prizeEl = document.getElementById("prizeAmount");
                if (prizeEl) {
                    prizeEl.textContent = `${prize.toFixed(2)} ‚Çº`;
                }

                if (data.winningCard) {
                    displayWinningCard(data.winningCard);
                    playSound('win');
                } else {
                    console.error("‚ùå winningCard m…ôlumatƒ± yoxdur!");
                }

                const modal = document.getElementById("gameOverModal");
                if (modal) {
                    modal.classList.add("show");
                    console.log("‚úÖ Modal a√ßƒ±ldƒ±!");
                }

                if (typeof confetti !== 'undefined') {
                    confetti({
                        particleCount: 200,
                        spread: 120,
                        origin: { y: 0.5 },
                        colors: ['#ffd166', '#ff9a3c', '#2dd4bf', '#fff']
                    });

                    setTimeout(() => {
                        confetti({
                            particleCount: 150,
                            angle: 60,
                            spread: 80,
                            origin: { x: 0 }
                        });
                        confetti({
                            particleCount: 150,
                            angle: 120,
                            spread: 80,
                            origin: { x: 1 }
                        });
                    }, 300);
                }

                startCountdown();
                // sendToReact('GAME_ENDED', {
                //     winner: winnerText,
                //     prize: prize,
                //     winType: data.winType
                // });
            });

            connection.on("RoomListUpdated", () => {
                console.log("üìã Otaq siyahƒ±sƒ± yenil…ôndi");
            });

            connection.on("BotTicketAdded", (data) => {
                console.log("ü§ñ Bot bileti …ôlav…ô olundu:", data.playerName);
            });

            connection.on("RoomReset", () => {
                console.log("üîÑ OTAQ RESET EDƒ∞LDƒ∞");
            });
        }

        function startCountdown() {
            let remaining = 10000;
            const countdownEl = document.getElementById("countdownTimer");

            if (countdownEl) {
                countdownEl.textContent = remaining;
            }

            countdownInterval = setInterval(() => {
                remaining--;

                if (countdownEl) {
                    countdownEl.textContent = remaining;
                }

                if (remaining <= 0) {
                    clearInterval(countdownInterval);
                    console.log("‚è∞ 10 saniy…ô bitdi, lobbiy…ô y√∂nl…ôndirilir...");
                    sendToReact('BACK_TO_LOBBY', {});
                }
            }, 1000);
        }

        function displayWinningCard(card) {
            const grid = document.getElementById("winnerCardGrid");
            if (!grid) {
                console.error("‚ùå winnerCardGrid elementi tapƒ±lmadƒ±!");
                return;
            }

            grid.innerHTML = "";

            console.log("üé¥ Rendering winner card:", card);

            if (!card || !Array.isArray(card) || card.length !== 3) {
                console.error("‚ùå Invalid card format:", card);
                grid.innerHTML = `<p style='color: red; grid-column: 1/-1;'>${t('invalid_card')}</p>`;
                return;
            }

            const drawnSet = new Set(drawnNumbers);

            for (let r = 0; r < 3; r++) {
                if (!Array.isArray(card[r]) || card[r].length !== 9) {
                    console.error(`‚ùå Invalid row ${r}:`, card[r]);
                    continue;
                }

                for (let c = 0; c < 9; c++) {
                    const cell = document.createElement("div");
                    const val = card[r][c];

                    if (val === null || val === undefined) {
                        cell.className = "winner-cell blank";
                    } else {
                        const isDrawn = drawnSet.has(val);
                        cell.className = `winner-cell ${isDrawn ? 'winning' : 'not-drawn'}`;
                        cell.textContent = val;
                    }

                    grid.appendChild(cell);
                }
            }

            console.log("‚úÖ Winner card rendered successfully");
        }

        function startTimer(seconds) {
            stopTimer();
            let remaining = seconds;
            const timerBadge = document.getElementById("timerBadge");

            if (!timerBadge) return;

            timerInterval = setInterval(() => {
                remaining--;

                if (remaining <= 0) {
                    stopTimer();
                    // timerBadge.textContent = winRule;
                    return;
                }

                const mins = Math.floor(remaining / 60);
                const secs = remaining % 60;
                timerBadge.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        function renderTickets() {
            const container = document.getElementById("ticketsContainer");
            if (!container) return;

            container.innerHTML = "";

            myTickets.forEach((ticket, index) => {
                const ticketDiv = document.createElement("div");
                ticketDiv.className = "ticket";

                let gridHTML = '';
                for (let r = 0; r < 3; r++) {
                    for (let c = 0; c < 9; c++) {
                        const val = ticket.card[r][c];
                        const isMarked = val !== null && drawnNumbers.includes(val);
                        const cellClass = val === null ? 'cell blank' : `cell ${isMarked ? 'marked' : ''}`;
                        gridHTML += `<div class="${cellClass}">${val ?? ''}</div>`;
                    }
                }

                ticketDiv.innerHTML = `
                <div class="ticket-header">
                    <div class="ticket-number">${t('ticket_number', { number: index + 1 })}</div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn-refresh" onclick="refreshTicket('${ticket.ticketId}')"
                                ${isGameStarted ? 'disabled' : ''}>
                            ${t('refresh')}
                        </button>
                        <button class="btn-delete" onclick="deleteTicket('${ticket.ticketId}')"
                                ${isGameStarted ? 'disabled' : ''}>
                            ${t('delete')}
                        </button>
                        <button class="btn" style="display: none;" onclick="callBingo('${ticket.ticketId}')"
                                ${!isGameStarted ? 'disabled' : ''}>
                            ${t('bingo')}
                        </button>
                    </div>
                </div>
                <div class="card-grid">${gridHTML}</div>
            `;

                removeButtons();

                container.appendChild(ticketDiv);
            });
        }

        function removeButtons() {
            if (isGameStarted) {
                document.querySelectorAll('.btn-refresh, .btn-delete').forEach(btn => {
                    btn.remove();
                });
            }
        }

        function checkTicketAvailability() {
            console.log("üéüÔ∏è Bilet almaq ist…ônir, m√∂vcud biletl…ôr sayƒ±:", myTickets.length);

            const buyTicketBtn = document.getElementById("buyTicketBtn");
            if (!buyTicketBtn) return;

            buyTicketBtn.disabled = myTickets.length >= 6;
        }
        function updateHistory() {
            const history = document.getElementById("history");
            if (!history) return;

            history.innerHTML = "";

            const last20 = drawnNumbers.slice(-20).reverse();
            last20.forEach(num => {
                const ball = document.createElement("div");
                ball.className = "history-ball";
                ball.textContent = num;
                history.appendChild(ball);
            });
        }

        function markNumber(num) {
            renderTickets();
        }

        function goToLobby() {
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            sendToReact('BACK_TO_LOBBY', {});
        }

        async function refreshTicket(ticketId) {
            if (!connection || connection.state !== signalR.HubConnectionState.Connected) {
                console.log("‚ùå Baƒülantƒ± yoxdur");
                return;
            }
            try {
                await connection.invoke("RefreshTicket", ticketId);
            } catch (err) {
                console.error("Refresh error:", err);
                console.log("‚ùå Yenil…ôm…ô x…ôtasƒ±");
            }
        }

        async function deleteTicket(ticketId) {
            if (!connection || connection.state !== signalR.HubConnectionState.Connected) {
                console.log("‚ùå Baƒülantƒ± yoxdur");
                return;
            }
            try {
                await connection.invoke("DeleteTicket", ticketId);

            } catch (err) {
                console.error("Delete error:", err);
                console.log("‚ùå Silm…ô x…ôtasƒ±");
            }
        }

        async function callBingo(ticketId) {
            if (!connection || connection.state !== signalR.HubConnectionState.Connected) {
                console.log("‚ùå Baƒülantƒ± yoxdur");
                return;
            }
            try {
                await connection.invoke("Bingo", ticketId);
            } catch (err) {
                console.error("Bingo error:", err);
                console.log("‚ùå Bingo uƒüursuz oldu");
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const buyBtn = document.getElementById("buyTicketBtn");
            const backBtn = document.getElementById("backBtn");

            if (buyBtn) {
                buyBtn.addEventListener("click", async () => {
                    if (!connection || connection.state !== signalR.HubConnectionState.Connected) {
                        console.log("‚ùå Baƒülantƒ± yoxdur");
                        return;
                    }

                    try {
                        const result = await connection.invoke("BuyTicket", currentRoomId);
                        if (!result.success) {
                            console.log("‚ùå " + result.message);
                        }
                    } catch (err) {
                        console.error("Buy ticket error:", err);
                        console.log("‚ùå Bilet almaq alƒ±nmadƒ±");
                    }
                });
            }

            if (backBtn) {
                backBtn.addEventListener("click", async () => {
                    if (myTickets.length > 0 && !isGameStarted) {
                        if (confirm(t('confirm_exit'))) {
                            if (connection && connection.state === signalR.HubConnectionState.Connected) {
                                try {
                                    for (const ticket of myTickets) {
                                        await connection.invoke("DeleteTicket", ticket.ticketId);
                                    }
                                } catch (err) {
                                    console.error("Exit error:", err);
                                }
                            }
                        }
                    }

                    sendToReact('BACK_TO_LOBBY', {});
                });
            }
        });
        function manageLoading() {
            const loadingContainer = document.getElementById('loadingContainer');
            const gameContainer = document.querySelector('.loto-game-container');

            if (loadingContainer && gameContainer) {
                loadingContainer.style.display = 'none';
                gameContainer.style.display = 'block';
            }
        }


        // async function init() {
        //     console.log('üöÄ [LOTO GAME] init() ba≈üladƒ±');

        //     if (!currentUserToken) {
        //         console.error('‚ùå [LOTO GAME] Token yoxdur!');
        //         return;
        //     }

        //     if (!currentRoomId) {
        //         console.error('‚ùå [LOTO GAME] RoomId yoxdur!');
        //         sendToReact('BACK_TO_LOBBY', {});
        //         return;
        //     }

        //     try {
        //         if (connection) {
        //             console.log("üîÑ [LOTO GAME] K√∂hn…ô connection baƒülanƒ±r...");
        //             try {
        //                 await connection.stop();
        //             } catch (e) {
        //                 console.log('Stop error (ignored):', e);
        //             }
        //             connection = null;
        //         }

        //         await new Promise(resolve => setTimeout(resolve, 100));

        //         connection = createConnection();

        //         console.log("üì° [LOTO GAME] SignalR connection ba≈ülayƒ±r...");
        //         await connection.start(); // ‚Üê AWAIT var, amma yet…ôrli deyil

        //         // ‚Üê BU Hƒ∞SS∆èNƒ∞ ∆èLAV∆è ET - state yoxla:
        //         if (connection.state !== signalR.HubConnectionState.Connected) {
        //             throw new Error('Connection Connected state-d…ô deyil: ' + connection.state);
        //         }

        //         console.log("‚úÖ [LOTO GAME] SignalR connected! State:", connection.state);

        //         console.log("üö™ [LOTO GAME] Joining room:", currentRoomId);
        //         await connection.invoke("JoinRoomView", currentRoomId);
        //         console.log("‚úÖ [LOTO GAME] Room joined!");

        //         sendToReact('CONNECTION_SUCCESS', { roomId: currentRoomId });
        //         manageLoading();

        //     } catch (err) {
        //         console.error("‚ùå [LOTO GAME] Connection error:", err);
        //         console.error("‚ùå Error details:", err.message, err.stack);
        //         console.log("‚ùå Baƒülantƒ± x…ôtasƒ±: " + err.message);
        //         sendToReact('CONNECTION_ERROR', { error: err.message });

        //         // ‚Üê RETRY mexanizmi …ôlav…ô et (optional):
        //         setTimeout(() => {
        //             console.log('üîÑ Retry edilir...');
        //             init();
        //         }, 2000);
        //     }
        // }

        async function init() {
            console.log('üöÄ [LOTO GAME] init() ba≈üladƒ±');

            // Token yoxlamasƒ±
            const token = getToken();
            if (!token) {
                console.error('‚ùå [LOTO GAME] Token yoxdur!');
                showNotification(t('notification_missing_login'));
                return;
            }

            if (!currentRoomId) {
                console.error('‚ùå [LOTO GAME] RoomId yoxdur!');
                sendToReact('BACK_TO_LOBBY', {});
                return;
            }

            try {
                // K√∂hn…ô connection-u baƒüla
                if (connection) {
                    console.log("üîÑ [LOTO GAME] K√∂hn…ô connection baƒülanƒ±r...");
                    try {
                        await connection.stop();
                    } catch (e) {
                        console.log('Stop error (ignored):', e);
                    }
                    connection = null;
                }

                // Ki√ßik pause
                await new Promise(resolve => setTimeout(resolve, 200));

                console.log('‚úÖ [LOTO] Token m√∂vcuddur, connection yaradƒ±lƒ±r...');
                connection = createConnection();

                console.log("üîÑ [LOTO GAME] SignalR.start() √ßaƒüƒ±rƒ±lƒ±r...");
                await connection.start();

                // State yoxlama
                if (connection.state !== signalR.HubConnectionState.Connected) {
                    throw new Error('Connection Connected state-d…ô deyil: ' + connection.state);
                }

                console.log("‚úÖ [LOTO GAME] SignalR connected! State:", connection.state);

                console.log("üö™ [LOTO GAME] Joining room:", currentRoomId);
                await connection.invoke("JoinRoomView", currentRoomId);
                console.log("‚úÖ [LOTO GAME] Room joined!");

                sendToReact('CONNECTION_SUCCESS', { roomId: currentRoomId });
                manageLoading();

            } catch (err) {
                console.error("‚ùå [LOTO GAME] Connection error:", err);
                console.error("‚ùå Error details:", err.message);
                console.error("‚ùå Stack:", err.stack);
                showNotification(t('notification_connection_error', { message: err.message }));
                sendToReact('CONNECTION_ERROR', { error: err.message });

                // Retry (optional - ≈ü…ôrtli)
                if (!err.message.includes('Token')) {
                    setTimeout(() => {
                        console.log('üîÑ Retry edilir...');
                        init();
                    }, 3000);
                }
            }
        }

        console.log('‚úÖ [LOTO GAME] Script tam y√ºkl…ôndi, postMessage g√∂zl…ônilir...');
    </script>
</body>

</html>
