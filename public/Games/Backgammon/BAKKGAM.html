<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T√ºrk Tavlasƒ± - D√ºz…ôldilmi≈ü</title>
    <script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr@7.0.0/dist/browser/signalr.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 15px 25px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }

            .header-title h1 {
                font-size: 24px;
                color: #333;
            }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }

        .balance {
            color: #f59e0b;
            font-weight: bold;
            font-size: 16px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .chat-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 350px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            display: none;
            flex-direction: column;
            max-height: 500px;
            z-index: 1000;
        }

            .chat-panel.open {
                display: flex;
            }

        .chat-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

            .chat-header h3 {
                margin: 0;
                font-size: 16px;
            }

        .chat-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

            .chat-close:hover {
                background: rgba(255,255,255,0.3);
                transform: rotate(90deg);
            }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            max-height: 300px;
            background: #f8f9fa;
        }

        .chat-message {
            margin-bottom: 10px;
            animation: slideInMessage 0.3s;
            clear: both;
        }

        @keyframes slideInMessage {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-content {
            background: white;
            padding: 8px 12px;
            border-radius: 10px;
            display: inline-block;
            max-width: 80%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .chat-message.own .message-content {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            float: right;
        }

        .message-sender {
            font-size: 11px;
            color: #666;
            margin-bottom: 3px;
            font-weight: 600;
        }

        .chat-message.own .message-sender {
            color: rgba(255,255,255,0.8);
            text-align: right;
        }

        .message-text {
            font-size: 14px;
            word-wrap: break-word;
        }

        .message-time {
            font-size: 10px;
            color: #999;
            margin-top: 3px;
        }

        .chat-message.own .message-time {
            color: rgba(255,255,255,0.7);
            text-align: right;
        }

        .quick-actions {
            border-top: 1px solid #e9ecef;
            padding: 10px;
            background: white;
            display: none;
            max-height: 200px;
            overflow-y: auto;
        }

            .quick-actions.show {
                display: block;
            }

        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 5px;
            margin-bottom: 10px;
        }

        .emoji-btn {
            background: #f8f9fa;
            border: none;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.2s;
        }

            .emoji-btn:hover {
                background: #e9ecef;
                transform: scale(1.1);
            }

        .quick-messages {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 5px;
        }

        .quick-msg-btn {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
            text-align: center;
        }

            .quick-msg-btn:hover {
                background: #667eea;
                color: white;
                border-color: #667eea;
            }

        .chat-input-area {
            padding: 10px;
            background: white;
            border-radius: 0 0 15px 15px;
            border-top: 1px solid #e9ecef;
        }

        .chat-input-tools {
            display: flex;
            gap: 5px;
            margin-bottom: 8px;
        }

        .tool-btn {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            flex: 1;
        }

            .tool-btn:hover {
                background: #e9ecef;
            }

            .tool-btn.active {
                background: #667eea;
                color: white;
                border-color: #667eea;
            }

        .chat-input-box {
            display: flex;
            gap: 8px;
        }

            .chat-input-box input {
                flex: 1;
                padding: 10px;
                border: 1px solid #e9ecef;
                border-radius: 8px;
                font-size: 14px;
                outline: none;
            }

                .chat-input-box input:focus {
                    border-color: #667eea;
                }

        .send-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

            .send-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
            }

            .send-btn:disabled {
                opacity: 0.5;
                cursor: not-allowed;
                transform: none;
            }

        .chat-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 24px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            transition: all 0.3s;
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
        }

            .chat-toggle:hover {
                transform: scale(1.1);
                box-shadow: 0 8px 30px rgba(102, 126, 234, 0.5);
            }

        .chat-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            border: 3px solid white;
            animation: pulseBadge 2s infinite;
        }

        @keyframes pulseBadge {
            0%, 100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        .chat-badge.show {
            display: flex;
        }

        .lobby {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }

        .rooms-section, .create-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }

        .section-title {
            font-size: 20px;
            margin-bottom: 15px;
            color: #333;
            font-weight: bold;
        }

        .rooms-grid {
            display: grid;
            gap: 12px;
        }

        .room-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

            .room-card:hover {
                border-color: #667eea;
                transform: translateX(5px);
            }

        .game-view {
            display: none;
        }

            .game-view.active {
                display: block;
            }

        .game-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }

        .players-info {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 20px;
        }

        .player-card {
            flex: 1;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 12px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            border: 3px solid transparent;
            transition: all 0.3s;
        }

            .player-card.active {
                background: linear-gradient(135deg, #10b981, #059669);
                color: white;
                border-color: #047857;
                box-shadow: 0 5px 20px rgba(16, 185, 129, 0.4);
            }

        .player-avatar-large {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 24px;
            border: 3px solid white;
            position: relative;
        }

        .player-details {
            flex: 1;
        }

            .player-details h3 {
                font-size: 18px;
                margin-bottom: 5px;
            }

        .player-color {
            font-size: 14px;
            opacity: 0.8;
        }

        .player-emoji-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.9);
            border: 2px solid #667eea;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s;
            position: relative;
        }

            .player-emoji-btn:hover {
                transform: scale(1.1);
                background: white;
                box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
            }

        .emoji-popup {
            position: absolute;
            bottom: 50px;
            right: 0;
            background: white;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: none;
            z-index: 1000;
            min-width: 280px;
            animation: popupSlide 0.3s;
        }

        @keyframes popupSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .emoji-popup.show {
            display: block;
        }

        .emoji-popup-header {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 8px;
        }

        .emoji-tab {
            flex: 1;
            padding: 8px;
            background: #f8f9fa;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
            color: #666;
        }

            .emoji-tab:hover {
                background: #e9ecef;
            }

            .emoji-tab.active {
                background: linear-gradient(135deg, #667eea, #764ba2);
                color: white;
            }

        .emoji-popup-content {
            max-height: 200px;
            overflow-y: auto;
        }

        .emoji-popup-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
        }

        .emoji-popup-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

            .emoji-popup-btn:hover {
                background: #667eea;
                transform: scale(1.15);
            }

        .quick-msg-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .quick-msg-item {
            padding: 10px 12px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            text-align: left;
        }

            .quick-msg-item:hover {
                background: #667eea;
                color: white;
                border-color: #667eea;
                transform: translateX(5px);
            }

        .player-emoji-display {
            position: absolute;
            top: -45px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 32px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            animation: emojiPop 2s forwards;
            z-index: 100;
        }

        @keyframes emojiPop {
            0% {
                opacity: 0;
                transform: translateX(-50%) translateY(20px) scale(0.5);
            }

            10% {
                opacity: 1;
                transform: translateX(-50%) translateY(0) scale(1.2);
            }

            20% {
                transform: translateX(-50%) translateY(0) scale(1);
            }

            80% {
                opacity: 1;
                transform: translateX(-50%) translateY(0) scale(1);
            }

            100% {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px) scale(0.8);
            }
        }

        .board-wrapper {
            background: linear-gradient(135deg, #654321, #3d1f0a);
            border: 12px solid #3d1f0a;
            border-radius: 20px;
            padding: 15px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.6);
            position: relative;
        }

        .board-container {
            background: linear-gradient(135deg, #c19a6b, #8b6f47);
            border-radius: 12px;
            padding: 20px 15px;
            display: flex;
            justify-content: space-between;
            gap: 15px;
            position: relative;
            height: 550px;
        }

        .board-half {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .board-section {
            display: flex;
            gap: 3px;
            height: 50%;
        }

        .point {
            flex: 1;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 50px;
        }

            .point:hover {
                opacity: 0.95;
            }

            .point.selected {
                box-shadow: inset 0 0 0 4px #ffd700;
                z-index: 100;
                animation: pulse 1s infinite;
            }

        @keyframes pulse {
            0%, 100% {
                box-shadow: inset 0 0 0 4px #ffd700;
            }

            50% {
                box-shadow: inset 0 0 0 4px #ffed4e;
            }
        }

        .triangle {
            width: 0;
            height: 0;
            border-left: 25px solid transparent;
            border-right: 25px solid transparent;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }

        .point.top .triangle {
            top: 0;
            border-top: 200px solid;
        }

        .point.bottom .triangle {
            bottom: 0;
            border-bottom: 200px solid;
        }

        .point:nth-child(odd) .triangle {
            border-top-color: #c1440e;
            border-bottom-color: #c1440e;
        }

        .point:nth-child(even) .triangle {
            border-top-color: #e8d4b8;
            border-bottom-color: #e8d4b8;
        }

        .bar {
            width: 70px;
            background: linear-gradient(180deg, #5a3310, #2a1810);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-around;
            box-shadow: inset 0 4px 15px rgba(0,0,0,0.7);
            position: relative;
            border-radius: 8px;
            flex-shrink: 0;
            padding: 30px 0;
            border: 2px solid #1a0f08;
        }

        .bar-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            min-height: 100px;
            cursor: pointer;
            transition: all 0.3s;
            padding: 15px 5px;
            border-radius: 6px;
            width: 100%;
        }

            .bar-section:hover {
                background: rgba(255,255,255,0.15);
            }

            .bar-section.selected {
                background: rgba(255, 215, 0, 0.3);
                box-shadow: inset 0 0 0 3px #ffd700;
            }

        .bar-text {
            color: #d4af37;
            font-weight: bold;
            font-size: 20px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.9);
            letter-spacing: 1px;
            margin-bottom: 8px;
            filter: drop-shadow(0 0 10px rgba(212, 175, 55, 0.5));
        }

        .bar-checker {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: 3px solid;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            position: relative;
            margin: -10px 0;
            cursor: pointer;
            transition: all 0.2s;
        }

            .bar-checker:hover {
                transform: scale(1.1);
                box-shadow: 0 6px 16px rgba(0,0,0,0.7);
            }

            .bar-checker:first-of-type {
                margin-top: 0;
            }

            .bar-checker.white {
                background: radial-gradient(circle at 40% 40%, #ffffff, #f0f0f0, #d8d8d8);
                border-color: #2a2a2a;
            }

            .bar-checker.black {
                background: radial-gradient(circle at 40% 40%, #4a4a4a, #2a2a2a, #0a0a0a);
                border-color: #000;
            }

            .bar-checker.white::after {
                content: '';
                position: absolute;
                top: 12px;
                left: 12px;
                width: 18px;
                height: 18px;
                background: rgba(255,255,255,0.7);
                border-radius: 50%;
                box-shadow: 0 0 10px rgba(255,255,255,0.5);
            }

            .bar-checker.black::after {
                content: '';
                position: absolute;
                top: 12px;
                left: 12px;
                width: 18px;
                height: 18px;
                background: rgba(255,255,255,0.2);
                border-radius: 50%;
            }

        .bar-count {
            position: absolute;
            top: -10px;
            right: -10px;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border-radius: 50%;
            width: 26px;
            height: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: bold;
            border: 3px solid white;
            z-index: 5;
            box-shadow: 0 2px 8px rgba(0,0,0,0.5);
        }

        .point-number {
            position: absolute;
            font-size: 13px;
            font-weight: bold;
            color: white;
            text-shadow: 0 1px 3px rgba(0,0,0,0.9);
            z-index: 1;
            background: rgba(0,0,0,0.3);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .point.top .point-number {
            top: 10px;
        }

        .point.bottom .point-number {
            bottom: 10px;
        }

        .checkers {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 2;
        }

        .point.top .checkers {
            top: 35px;
        }

        .point.bottom .checkers {
            bottom: 35px;
        }

        .checker {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: 3px solid;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            margin-top: -12px;
            flex-shrink: 0;
        }

            .checker:first-child {
                margin-top: 0;
            }

            .checker:hover {
                transform: scale(1.15);
                z-index: 15;
                box-shadow: 0 6px 20px rgba(0,0,0,0.7);
            }

            .checker.white {
                background: radial-gradient(circle at 40% 40%, #ffffff, #f0f0f0, #d8d8d8);
                border-color: #2a2a2a;
            }

            .checker.black {
                background: radial-gradient(circle at 40% 40%, #4a4a4a, #2a2a2a, #0a0a0a);
                border-color: #000;
            }

            .checker.white::after {
                content: '';
                position: absolute;
                top: 12px;
                left: 12px;
                width: 18px;
                height: 18px;
                background: rgba(255,255,255,0.7);
                border-radius: 50%;
                box-shadow: 0 0 10px rgba(255,255,255,0.5);
            }

            .checker.black::after {
                content: '';
                position: absolute;
                top: 12px;
                left: 12px;
                width: 18px;
                height: 18px;
                background: rgba(255,255,255,0.2);
                border-radius: 50%;
            }

        .checker-count {
            position: absolute;
            top: -10px;
            right: -10px;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: bold;
            border: 3px solid white;
            z-index: 25;
            box-shadow: 0 3px 10px rgba(0,0,0,0.5);
        }

        .dice-area {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
            gap: 15px;
            z-index: 100;
        }

            .dice-area.show {
                display: flex;
            }

        .die {
            width: 60px;
            height: 60px;
            background: white;
            border: 3px solid #333;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            animation: rollDice 0.5s;
        }

        @keyframes rollDice {
            0%, 100% {
                transform: rotate(0deg) scale(1);
            }

            25% {
                transform: rotate(90deg) scale(1.1);
            }

            50% {
                transform: rotate(180deg) scale(0.9);
            }

            75% {
                transform: rotate(270deg) scale(1.1);
            }
        }

        .game-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .score-display {
            text-align: center;
            margin-bottom: 15px;
            padding: 10px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 10px;
        }

            .score-display h3 {
                color: #333;
                font-size: 16px;
            }

        .score-value {
            color: #f59e0b;
            font-size: 24px;
            font-weight: bold;
            margin-top: 5px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            display: none;
            z-index: 1000;
            min-width: 280px;
            max-width: 400px;
        }

            .notification.show {
                display: block;
                animation: slideIn 0.3s;
            }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification.success {
            border-left: 4px solid #10b981;
        }

        .notification.error {
            border-left: 4px solid #ef4444;
        }

        .notification.info {
            border-left: 4px solid #3b82f6;
        }
    </style>
</head>
<body>
    <div id="notification" class="notification">
        <div id="notificationMessage"></div>
    </div>

    <div class="container">
        <div class="header">
            <div class="header-title">
                <span style="font-size: 32px;">üé≤</span>
                <div>
                    <h1>T√ºrk Tavlasƒ±</h1>
                    <p style="color: #666; font-size: 12px;">Emoji Sistemli Versiya</p>
                </div>
            </div>
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">?</div>
                <div>
                    <div id="userName" style="font-weight: bold; color: #333;">Y√ºkl…ônir...</div>
                    <div class="balance">üí∞ <span id="userBalance">0</span></div>
                </div>
            </div>
        </div>

        <!-- Chat Toggle Button -->
        <button class="chat-toggle" id="chatToggle" onclick="toggleChat()">
            üí¨
            <span class="chat-badge" id="chatBadge">0</span>
        </button>

        <!-- Chat Panel -->
        <div class="chat-panel" id="chatPanel">
            <div class="chat-header">
                <h3>üí¨ S√∂hb…ôt</h3>
                <button class="chat-close" onclick="toggleChat()">√ó</button>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div style="text-align: center; color: #999; padding: 20px; font-size: 13px;">
                    S√∂hb…ôt ba≈ülamayƒ±b
                </div>
            </div>

            <!-- Quick Emoji Panel -->
            <div class="quick-actions" id="quickEmojis">
                <div class="emoji-grid">
                    <button class="emoji-btn" onclick="insertText('üòä')">üòä</button>
                    <button class="emoji-btn" onclick="insertText('üòÇ')">üòÇ</button>
                    <button class="emoji-btn" onclick="insertText('‚ù§Ô∏è')">‚ù§Ô∏è</button>
                    <button class="emoji-btn" onclick="insertText('üëç')">üëç</button>
                    <button class="emoji-btn" onclick="insertText('üôè')">üôè</button>
                    <button class="emoji-btn" onclick="insertText('üî•')">üî•</button>
                    <button class="emoji-btn" onclick="insertText('‚ú®')">‚ú®</button>
                    <button class="emoji-btn" onclick="insertText('üéâ')">üéâ</button>
                    <button class="emoji-btn" onclick="insertText('üëè')">üëè</button>
                    <button class="emoji-btn" onclick="insertText('üíØ')">üíØ</button>
                    <button class="emoji-btn" onclick="insertText('ü§î')">ü§î</button>
                    <button class="emoji-btn" onclick="insertText('üòç')">üòç</button>
                </div>
            </div>

            <!-- Quick Messages Panel -->
            <div class="quick-actions" id="quickMessages">
                <div class="quick-messages">
                    <button class="quick-msg-btn" onclick="sendQuickMessageChat('Salam! üëã')">Salam! üëã</button>
                    <button class="quick-msg-btn" onclick="sendQuickMessageChat('Uƒüurlar! üçÄ')">Uƒüurlar! üçÄ</button>
                    <button class="quick-msg-btn" onclick="sendQuickMessageChat('Yax≈üƒ± oyun! üéØ')">Yax≈üƒ± oyun! üéØ</button>
                    <button class="quick-msg-btn" onclick="sendQuickMessageChat('T…ô≈ü…ôkk√ºrl…ôr üôè')">T…ô≈ü…ôkk√ºrl…ôr üôè</button>
                    <button class="quick-msg-btn" onclick="sendQuickMessageChat('G√∂z…ôl h…ôr…ôk…ôt! üëè')">G√∂z…ôl! üëè</button>
                    <button class="quick-msg-btn" onclick="sendQuickMessageChat('Ups... üòÖ')">Ups... üòÖ</button>
                    <button class="quick-msg-btn" onclick="sendQuickMessageChat('Daha diqq…ôtli! ü§î')">Diqq…ôtli! ü§î</button>
                    <button class="quick-msg-btn" onclick="sendQuickMessageChat('GG! üéä')">GG! üéä</button>
                </div>
            </div>

            <!-- Chat Input -->
            <div class="chat-input-area">
                <div class="chat-input-tools">
                    <button class="tool-btn" id="emojiTool" onclick="toggleQuickPanel('emoji')" title="Emoji">
                        üòä
                    </button>
                    <button class="tool-btn" id="messageTool" onclick="toggleQuickPanel('messages')" title="S√ºr…ôtli mesajlar">
                        üí¨
                    </button>
                </div>

                <div class="chat-input-box">
                    <input type="text"
                           id="chatInput"
                           placeholder="Mesajƒ±nƒ±zƒ± yazƒ±n..."
                           maxlength="200"
                           onkeypress="handleChatKeyPress(event)">
                    <button class="send-btn" onclick="sendChatMessage()">
                        ‚û§
                    </button>
                </div>
            </div>
        </div>

        <div id="lobbyView" class="lobby">
            <div class="rooms-section">
                <h2 class="section-title">üéØ S√ºr…ôtli Oyun</h2>

                <div style="background: linear-gradient(135deg, #667eea, #764ba2); padding: 25px; border-radius: 15px; color: white; margin-bottom: 20px; text-align: center;">
                    <h3 style="font-size: 20px; margin-bottom: 15px;">‚ö° Quick Match</h3>
                    <p style="opacity: 0.9; margin-bottom: 20px; font-size: 14px;">M…ôrc se√ß v…ô avtomatik r…ôqib tap!</p>

                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px;">
                        <button class="btn" style="background: rgba(255,255,255,0.2); border: 2px solid white;" onclick="quickMatch(50)">
                            50 üí∞
                        </button>
                        <button class="btn" style="background: rgba(255,255,255,0.2); border: 2px solid white;" onclick="quickMatch(100)">
                            100 üí∞
                        </button>
                        <button class="btn" style="background: rgba(255,255,255,0.2); border: 2px solid white;" onclick="quickMatch(200)">
                            200 üí∞
                        </button>
                        <button class="btn" style="background: rgba(255,255,255,0.2); border: 2px solid white;" onclick="quickMatch(500)">
                            500 üí∞
                        </button>
                    </div>

                    <button class="btn" style="background: rgba(255,255,255,0.3); border: 2px solid white; width: 100%;" onclick="quickMatch(1000)">
                        üî• 1000 üí∞ VIP
                    </button>
                </div>

                <h3 style="font-size: 16px; color: #666; margin-bottom: 10px;">üìã Aktiv Otaqlar</h3>
                <div id="roomsGrid" class="rooms-grid">
                    <p style="text-align: center; color: #999; padding: 20px; font-size: 13px;">Otaqlar y√ºkl…ônir...</p>
                </div>
            </div>

            <div class="create-section">
                <h2 class="section-title">‚ÑπÔ∏è Oyun Qaydalarƒ±</h2>

                <div style="padding: 15px; background: #f8f9fa; border-radius: 10px; margin-bottom: 15px;">
                    <h3 style="font-size: 14px; color: #333; margin-bottom: 10px;">üé≤ BAR Sistemi</h3>
                    <ul style="font-size: 12px; color: #666; line-height: 1.8; padding-left: 20px;">
                        <li>‚ö™ Aƒü: BAR-dan 19-24 arasƒ± daxil olur</li>
                        <li>‚ö´ Qara: BAR-dan 1-6 arasƒ± daxil olur</li>
                        <li>BAR-da da≈ü varsa √∂nce onu oynat</li>
                    </ul>
                </div>

                <div style="padding: 15px; background: #f8f9fa; border-radius: 10px; margin-bottom: 15px;">
                    <h3 style="font-size: 14px; color: #333; margin-bottom: 10px;">üè† HOME-a √áƒ±xarma</h3>
                    <ul style="font-size: 12px; color: #666; line-height: 1.8; padding-left: 20px;">
                        <li>‚ö™ Aƒü: 1-6 arasƒ± home quadrant</li>
                        <li>‚ö´ Qara: 19-24 arasƒ± home quadrant</li>
                        <li>B√ºt√ºn da≈ülar home-da olmalƒ±</li>
                        <li>15 da≈üƒ± √ßƒ±xaran qalib</li>
                    </ul>
                </div>

                <div style="padding: 15px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 10px; color: white; margin-bottom: 15px;">
                    <h3 style="font-size: 14px; margin-bottom: 10px;">üèÜ Q…ôl…ôb…ô</h3>
                    <p style="font-size: 12px; opacity: 0.95; line-height: 1.6;">
                        ƒ∞lk olaraq 15 da≈üƒ± HOME-a √ßƒ±xaran oyun√ßu qalib olur v…ô 2x m…ôrc qazanƒ±r!
                    </p>
                </div>

                <div style="padding: 15px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 10px; color: white;">
                    <h3 style="font-size: 14px; margin-bottom: 10px;">üí¨ Emoji Sistemi</h3>
                    <p style="font-size: 12px; opacity: 0.95; line-height: 1.6;">
                        Oyun√ßu avatar-ƒ±nƒ±n yanƒ±ndaki üí¨ d√ºym…ôni basaraq r…ôqibin…ô emoji v…ô s√ºr…ôtli mesajlar g√∂nd…ôr…ô bil…ôrsiniz!
                    </p>
                </div>
            </div>
        </div>

        <div id="gameView" class="game-view">
            <div class="game-container">
                <div class="score-display">
                    <h3>M…ôrc</h3>
                    <div class="score-value">üèÜ <span id="betValue">0</span> Coin</div>
                </div>

                <div class="players-info">
                    <div class="player-card" id="player1Card">
                        <div class="player-avatar-large" id="p1Avatar">?</div>
                        <div class="player-details">
                            <h3 id="p1Name">Oyun√ßu 1</h3>
                            <div class="player-color">‚ö™ Aƒü</div>
                            <div style="font-size: 12px; margin-top: 5px;">üè† HOME: <span id="whiteHome">0</span>/15</div>
                        </div>
                        <div style="position: relative;">
                            <button class="player-emoji-btn" onclick="toggleEmojiPopup('player1')">
                                üí¨
                            </button>
                            <div class="emoji-popup" id="emojiPopup1">
                                <div class="emoji-popup-header">
                                    <button class="emoji-tab active" onclick="switchEmojiTab('player1', 'emoji')">üòä Emoji</button>
                                    <button class="emoji-tab" onclick="switchEmojiTab('player1', 'message')">üí¨ Mesaj</button>
                                </div>
                                <div class="emoji-popup-content" id="emojiContent1">
                                    <div class="emoji-popup-grid">
                                        <button class="emoji-popup-btn" onclick="sendQuickEmoji('üëã')">üëã</button>
                                        <button class="emoji-popup-btn" onclick="sendQuickEmoji('üòä')">üòä</button>
                                        <button class="emoji-popup-btn" onclick="sendQuickEmoji('üòÇ')">üòÇ</button>
                                        <button class="emoji-popup-btn" onclick="sendQuickEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</button>
                                        <button class="emoji-popup-btn" onclick="sendQuickEmoji('üëç')">üëç</button>
                                        <button class="emoji-popup-btn" onclick="sendQuickEmoji('üëè')">üëè</button>
                                        <button class="emoji-popup-btn" onclick="sendQuickEmoji('üôè')">üôè</button>
                                        <button class="emoji-popup-btn" onclick="sendQuickEmoji('üî•')">üî•</button>
                                        <button class="emoji-popup-btn" onclick="sendQuickEmoji('‚ú®')">‚ú®</button>
                                        <button class="emoji-popup-btn" onclick="sendQuickEmoji('üéâ')">üéâ</button>
                                        <button class="emoji-popup-btn" onclick="sendQuickEmoji('üíØ')">üíØ</button>
                                        <button class="emoji-popup-btn" onclick="sendQuickEmoji('ü§î')">ü§î</button>
                                        <button class="emoji-popup-btn" onclick="sendQuickEmoji('üòç')">üòç</button>
                                        <button class="emoji-popup-btn" onclick="sendQuickEmoji('üòé')">üòé</button>
                                        <button class="emoji-popup-btn" onclick="sendQuickEmoji('üò¢')">üò¢</button>
                                        <button class="emoji-popup-btn" onclick="sendQuickEmoji('üò°')">üò°</button>
                                        <button class="emoji-popup-btn" onclick="sendQuickEmoji('ü§©')">ü§©</button>
                                        <button class="emoji-popup-btn" onclick="sendQuickEmoji('ü•≥')">ü•≥</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="player-card" id="player2Card">
                        <div class="player-avatar-large" id="p2Avatar">?</div>
                        <div class="player-details">
                            <h3 id="p2Name">Oyun√ßu 2</h3>
                            <div class="player-color">‚ö´ Qara</div>
                            <div style="font-size: 12px; margin-top: 5px;">üè† HOME: <span id="blackHome">0</span>/15</div>
                        </div>
                        <div style="position: relative;">
                            <button class="player-emoji-btn" onclick="toggleEmojiPopup('player2')">
                                üí¨
                            </button>
                            <div class="emoji-popup" id="emojiPopup2">
                                <div class="emoji-popup-header">
                                    <button class="emoji-tab active" onclick="switchEmojiTab('player2', 'emoji')">üòä Emoji</button>
                                    <button class="emoji-tab" onclick="switchEmojiTab('player2', 'message')">üí¨ Mesaj</button>
                                </div>
                                <div class="emoji-popup-content" id="emojiContent2">
                                    <div class="emoji-popup-grid">
                                        <button class="emoji-popup-btn" onclick="sendQuickEmoji('üëã')">üëã</button>
                                        <button class="emoji-popup-btn" onclick="sendQuickEmoji('üòä')">üòä</button>
                                        <button class="emoji-popup-btn" onclick="sendQuickEmoji('üòÇ')">üòÇ</button>
                                        <button class="emoji-popup-btn" onclick="sendQuickEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</button>
                                        <button class="emoji-popup-btn" onclick="sendQuickEmoji('üëç')">üëç</button>
                                        <button class="emoji-popup-btn" onclick="sendQuickEmoji('üëè')">üëè</button>
                                        <button class="emoji-popup-btn" onclick="sendQuickEmoji('üôè')">üôè</button>
                                        <button class="emoji-popup-btn" onclick="sendQuickEmoji('üî•')">üî•</button>
                                        <button class="emoji-popup-btn" onclick="sendQuickEmoji('‚ú®')">‚ú®</button>
                                        <button class="emoji-popup-btn" onclick="sendQuickEmoji('üéâ')">üéâ</button>
                                        <button class="emoji-popup-btn" onclick="sendQuickEmoji('üíØ')">üíØ</button>
                                        <button class="emoji-popup-btn" onclick="sendQuickEmoji('ü§î')">ü§î</button>
                                        <button class="emoji-popup-btn" onclick="sendQuickEmoji('üòç')">üòç</button>
                                        <button class="emoji-popup-btn" onclick="sendQuickEmoji('üòé')">üòé</button>
                                        <button class="emoji-popup-btn" onclick="sendQuickEmoji('üò¢')">üò¢</button>
                                        <button class="emoji-popup-btn" onclick="sendQuickEmoji('üò°')">üò°</button>
                                        <button class="emoji-popup-btn" onclick="sendQuickEmoji('ü§©')">ü§©</button>
                                        <button class="emoji-popup-btn" onclick="sendQuickEmoji('ü•≥')">ü•≥</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="board-wrapper">
                    <div class="board-container" id="boardContainer">
                        <!-- Board + BAR render edil…ôc…ôk -->
                    </div>

                    <div class="dice-area" id="diceArea">
                        <div class="die" id="die1">?</div>
                        <div class="die" id="die2">?</div>
                    </div>
                </div>

                <div class="game-controls">
                    <button class="btn btn-success" id="rollBtn" onclick="rollDice()" disabled>
                        üé≤ Z…ôr At
                    </button>
                    <button class="btn" id="bearOffBtn" onclick="bearOff()" disabled style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white;">
                        üè† HOME-a √áƒ±xart
                    </button>
                    <button class="btn btn-primary" id="endTurnBtn" onclick="endTurn()" disabled>
                        ‚è≠Ô∏è N√∂vb…ôni Bitir
                    </button>
                    <button class="btn btn-danger" onclick="leaveGame()">
                        üö™ √áƒ±x
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let connection = null;
        let currentRoom = null;
        let myColor = null;
        let myName = null;
        let isMyTurn = false;
        let selectedPoint = null;
        let gameBoard = { points: {}, bar: { white: 0, black: 0 }, home: { white: 0, black: 0 } };
        let isWaitingForOpponent = false;
        let activePopup = null;

        function getToken() {
            const raw = document.cookie
                .split("; ")
                .find(row => row.startsWith("AuthToken="))
                ?.split("=")[1];
            return raw ? decodeURIComponent(raw).trim() : "";
        }

        async function initSignalR() {
            connection = new signalR.HubConnectionBuilder()
                .withUrl("/backgammonhub", {
                    accessTokenFactory: () => getToken(),
                    transport: signalR.HttpTransportType.LongPolling  // <-- Burada Long Polling aktiv edildi
                })
                .withAutomaticReconnect()
                .build();

            setupEventHandlers();

            try {
                await connection.start();
                console.log("‚úÖ Backgammon connected via Long Polling");
                await refreshRooms();
            } catch (err) {
                console.error("‚ùå Connection error:", err);
                showNotification('Baƒülantƒ± x…ôtasƒ±!', 'error');
            }
        }


        function setupEventHandlers() {
            connection.on("UserData", (data) => {
                myName = data.fullName || data.username;
                document.getElementById('userName').textContent = myName;
                document.getElementById('userBalance').textContent = data.balance;
                document.getElementById('userAvatar').textContent = myName.charAt(0).toUpperCase();
                console.log("üë§ My name:", myName);
            });

            connection.on("ChatMessage", (data) => {
                console.log("üí¨ Chat message:", data);
                const isOwn = data.sender === myName;
                displayChatMessage(data.sender, data.message, isOwn);
            });

            connection.on("QuickEmoji", (data) => {
                console.log("üì© Quick emoji received:", data);
                // Yalnƒ±z avatar yanƒ±nda g√∂st…ôr, chat-a …ôlav…ô ETM∆è
                displayPlayerEmoji(data.sender, data.emoji);
            });

            connection.on("QuickMessage", (data) => {
                console.log("üì© Quick message received:", data);
                // Yalnƒ±z avatar yanƒ±nda g√∂st…ôr, chat-a …ôlav…ô ETM∆è
                displayPlayerQuickMessage(data.sender, data.message);
            });

            connection.on("BackgammonRoomCreated", () => {
                refreshRooms();
            });

            connection.on("JoinedRoom", (data) => {
                currentRoom = data.roomId;
                myColor = data.color;
                isWaitingForOpponent = data.waitingForOpponent || false;

                document.getElementById('betValue').textContent = data.betAmount;
                document.getElementById('lobbyView').style.display = 'none';
                document.getElementById('gameView').classList.add('active');

                // √ñz m…ôlumatlarƒ±mƒ± set ed…ôk
                if (myColor === 'white') {
                    document.getElementById('p1Name').textContent = myName;
                    document.getElementById('p1Avatar').textContent = myName.charAt(0).toUpperCase();
                } else {
                    document.getElementById('p2Name').textContent = myName;
                    document.getElementById('p2Avatar').textContent = myName.charAt(0).toUpperCase();
                }

                renderBoard(gameBoard);

                if (isWaitingForOpponent) {
                    showNotification(`‚è≥ R…ôqib g√∂zl…ônilir... (${data.color === 'white' ? '‚ö™ Aƒü' : '‚ö´ Qara'})`, 'info');
                } else {
                    showNotification(`Otaƒüa qo≈üuldunuz! Siz ${data.color === 'white' ? '‚ö™ Aƒü' : '‚ö´ Qara'}`, 'success');
                }
            });

            connection.on("PlayerJoined", (data) => {
                console.log("üë• Player joined:", data);
                isWaitingForOpponent = false;
                showNotification(`${data.name} qo≈üuldu! Oyun ba≈ülayƒ±r...`, 'info');

                // R…ôqib m…ôlumatƒ±nƒ± yenil…ô
                updatePlayerInfo(data.name, data.color);
            });

            connection.on("OpponentInfo", (data) => {
                console.log("üë• Opponent info received:", data);
                updatePlayerInfo(data.name, data.color);
            });

            connection.on("GameStarting", (data) => {
                console.log("üé≤ Game starting with dice roll:", data);
                const message = `${data.player1.name} atdƒ± ${data.player1.dice} üé≤\n${data.player2.name} atdƒ± ${data.player2.dice} üé≤\n\nüèÅ ${data.starter} ba≈ülayƒ±r!`;
                showNotification(message, 'success');
                showDice([data.player1.dice, data.player2.dice]);
            });

            connection.on("GameStarted", (data) => {
                console.log("üé≤ Game started:", data);
                console.log("üìä Initial board data:", data.board);

                isMyTurn = data.isMyTurn;
                gameBoard = data.board;

                if (!gameBoard.bar) {
                    console.warn("‚ö†Ô∏è BAR data missing in GameStarted, initializing...");
                    gameBoard.bar = { white: 0, black: 0 };
                }

                if (!gameBoard.home) {
                    console.warn("‚ö†Ô∏è HOME data missing in GameStarted, initializing...");
                    gameBoard.home = { white: 0, black: 0 };
                }

                // Oyun√ßu m…ôlumatlarƒ±nƒ± yenil…ô
                if (data.players && data.players.length === 2) {
                    data.players.forEach(p => {
                        updatePlayerInfo(p.name, p.color);
                    });
                }

                console.log("‚úÖ Game board prepared:", gameBoard);

                renderBoard(gameBoard);
                updateTurnIndicator();
                showNotification(data.message || 'Oyun ba≈üladƒ±!', 'success');

                if (isMyTurn) {
                    document.getElementById('rollBtn').disabled = false;
                }

                document.getElementById('bearOffBtn').disabled = true;
                document.getElementById('endTurnBtn').disabled = true;
            });

           connection.on("DiceRolled", (data) => {
                console.log("üé≤ DiceRolled event received:", data);
    
                showDice(data.dice);
                showNotification(`üé≤ Z…ôr: ${data.dice.join('-')}`, 'info');
    
                // Z…ôr atƒ±ldƒ±qdan sonra "Z…ôr At" d√ºym…ôsini disable et
                document.getElementById('rollBtn').disabled = true;
    
                // EndTurn d√ºym…ôsini aktiv et
                document.getElementById('endTurnBtn').disabled = false;

                // Bear off yoxla
                if (checkCanBearOff()) {
                    document.getElementById('bearOffBtn').disabled = false;
                    showNotification(`üé≤ Z…ôr: ${data.dice.join('-')} | üè† HOME-a √ßƒ±xara bil…ôrsiniz!`, 'info');
                } else {
                    document.getElementById('bearOffBtn').disabled = true;
                }
    
                console.log("‚úÖ DiceRolled processing completed");
            });
            connection.on("PieceMoved", (data) => {
                console.log("üîÑ PieceMoved received:", data);
                console.log("üì¶ Full board data:", JSON.stringify(data.board, null, 2));
                console.log("üé≤ Remaining moves:", data.remainingMoves);

                gameBoard = data.board;

                if (gameBoard.bar) {
                    console.log("‚úÖ BAR data exists:", JSON.stringify(gameBoard.bar));
                } else {
                    console.warn("‚ö†Ô∏è BAR data missing in response!");
                }

                renderBoard(gameBoard);

                let moveText = '';
                if (data.fromPoint === 0) {
                    moveText = `BAR ‚Üí ${data.toPoint}`;
                } else if (data.toPoint < 1 || data.toPoint > 24) {
                    moveText = `${data.fromPoint} ‚Üí HOME üè†`;
                } else {
                    moveText = `${data.fromPoint} ‚Üí ${data.toPoint}`;
                }

                if (data.remainingMoves && data.remainingMoves.length > 0) {
                    showNotification(`‚ôüÔ∏è ${moveText} | Qalan z…ôrl…ôr: ${data.remainingMoves.join(', ')}`, 'success');
                } else {
                    showNotification(`‚ôüÔ∏è ${moveText} | ‚úÖ B√ºt√ºn z…ôrl…ôr istifad…ô edildi`, 'success');
                }

                selectedPoint = null;

                // ‚úÖ D√úZ∆èLƒ∞≈û: Z…ôrl…ôr bitdikd…ô b√ºt√ºn d√ºym…ôl…ôri disable et
                if (!data.remainingMoves || data.remainingMoves.length === 0) {
                    document.getElementById('bearOffBtn').disabled = true;
                    document.getElementById('endTurnBtn').disabled = true;
                    document.getElementById('rollBtn').disabled = true;

                    console.log("‚úÖ All moves used, all buttons disabled, waiting for TurnChanged event...");
                } else {
                    // H…ôl…ô h…ôr…ôk…ôt varsa
                    if (checkCanBearOff() && isMyTurn) {
                        document.getElementById('bearOffBtn').disabled = false;
                    } else {
                        document.getElementById('bearOffBtn').disabled = true;
                    }

                    // EndTurn d√ºym…ôsi aktiv qalsƒ±n
                    document.getElementById('endTurnBtn').disabled = false;
                }
            });
            connection.on("TurnChanged", (data) => {
                console.log("üîÑ TurnChanged event received:", data);
                console.log("üìä Current player:", data.currentPlayer);
                console.log("üë§ My name:", myName);

                // N√∂vb…ôni yenil…ô
                isMyTurn = data.currentPlayer === myName;

                console.log("‚úÖ isMyTurn updated to:", isMyTurn);

                // Turn indicator-u yenil…ô
                updateTurnIndicator();

                // Z…ôr sah…ôsini gizl…ôt
                hideDice();

                // B√ºt√ºn d√ºym…ôl…ôri disable et
                document.getElementById('endTurnBtn').disabled = true;
                document.getElementById('bearOffBtn').disabled = true;

                // ‚úÖ KRƒ∞Tƒ∞K D√úZ∆èLƒ∞≈û: ∆èg…ôr m…ônim n√∂vb…ômdirs…ô, "Z…ôr At" d√ºym…ôsini AKTƒ∞V et
                if (isMyTurn) {
                    document.getElementById('rollBtn').disabled = false;
                    showNotification('üéØ Sizin n√∂vb…ônizdir! Z…ôr atƒ±n.', 'info');
                    console.log("‚úÖ Roll button ENABLED for my turn");
                } else {
                    document.getElementById('rollBtn').disabled = true;
                    showNotification(`‚è≥ ${data.currentPlayer} z…ôr atƒ±r...`, 'info');
                    console.log("‚è∏Ô∏è Roll button DISABLED, waiting for opponent");
                }

                // Se√ßili n√∂qt…ôni sƒ±fƒ±rla
                selectedPoint = null;

                console.log("‚úÖ TurnChanged processing completed");
            });

            connection.on("GameEnded", (data) => {
                showNotification(data.message, 'success');
                setTimeout(() => {
                    location.reload();
                }, 4000);
            });

            connection.on("Error", (msg) => {
                showNotification(msg, 'error');
            });

            connection.on("JoinError", (msg) => {
                showNotification(msg, 'error');
            });
        }

        function updatePlayerInfo(name, color) {
            console.log(`üîÑ Updating player info: ${name} (${color})`);

            if (color === 'white') {
                document.getElementById('p1Name').textContent = name;
                document.getElementById('p1Avatar').textContent = name.charAt(0).toUpperCase();
            } else if (color === 'black') {
                document.getElementById('p2Name').textContent = name;
                document.getElementById('p2Avatar').textContent = name.charAt(0).toUpperCase();
            }

            console.log(`‚úÖ Player info updated: P1=${document.getElementById('p1Name').textContent}, P2=${document.getElementById('p2Name').textContent}`);
        }

        async function refreshRooms() {
            try {
                const rooms = await connection.invoke("GetAvailableRooms");
                displayRooms(rooms);
            } catch (err) {
                console.error("‚ùå GetAvailableRooms error:", err);
            }
        }

        async function quickMatch(betAmount) {
            try {
                showNotification(`‚è≥ ${betAmount} coin m…ôrc √º√ß√ºn otaq axtarƒ±lƒ±r...`, 'info');
                const result = await connection.invoke("QuickMatch", betAmount);
                if (!result.success) {
                    showNotification(result.message, 'error');
                }
            } catch (err) {
                console.error("‚ùå QuickMatch error:", err);
                showNotification('X…ôta ba≈ü verdi!', 'error');
            }
        }

        setInterval(() => {
            if (document.getElementById('lobbyView').style.display !== 'none') {
                refreshRooms();
            }
        }, 3000);

        function displayRooms(rooms) {
            const grid = document.getElementById('roomsGrid');
            if (rooms.length === 0) {
                grid.innerHTML = '<p style="text-align: center; color: #999; padding: 20px; font-size: 13px;">Hazƒ±rda aktiv otaq yoxdur</p>';
                return;
            }
            grid.innerHTML = rooms.map(room => {
                const statusText = room.isAvailable
                    ? `<span style="color: #10b981;">‚óè A√ßƒ±q (${room.playerCount}/2)</span>`
                    : `<span style="color: #ef4444;">‚óè Oyunda</span>`;
                return `
                        <div class="room-card" style="padding: 12px;">
                            <div>
                                <div style="font-weight: bold; font-size: 14px; margin-bottom: 4px;">${room.roomName}</div>
                                <div style="color: #666; font-size: 12px;">
                                    üí∞ ${room.betAmount} Coin ‚Ä¢ ${statusText}
                                </div>
                            </div>
                        </div>
                    `;
            }).join('');
        }

        function renderBoard(board) {
            console.log("üé® Rendering board...", board);
            const container = document.getElementById('boardContainer');
            container.innerHTML = '';

            const points = board.points || {};
            const bar = {
                white: board.bar?.white ?? board.bar?.White ?? 0,
                black: board.bar?.black ?? board.bar?.Black ?? 0
            };
            const home = {
                white: board.home?.white ?? board.home?.White ?? 0,
                black: board.home?.black ?? board.home?.Black ?? 0
            };

            console.log("üìä BAR status:", bar);
            console.log("üè† HOME status:", home);

            document.getElementById('whiteHome').textContent = home.white;
            document.getElementById('blackHome').textContent = home.black;

            const leftHalf = document.createElement('div');
            leftHalf.className = 'board-half';

            const topLeft = document.createElement('div');
            topLeft.className = 'board-section';
            for (let i = 13; i <= 18; i++) {
                topLeft.appendChild(createPoint(i, 'top', points));
            }
            leftHalf.appendChild(topLeft);

            const bottomLeft = document.createElement('div');
            bottomLeft.className = 'board-section';
            for (let i = 12; i >= 7; i--) {
                bottomLeft.appendChild(createPoint(i, 'bottom', points));
            }
            leftHalf.appendChild(bottomLeft);

            container.appendChild(leftHalf);

            const barElement = document.createElement('div');
            barElement.className = 'bar';

            const whiteBarSection = document.createElement('div');
            whiteBarSection.className = 'bar-section';
            if (selectedPoint === 0 && myColor === 'white') {
                whiteBarSection.classList.add('selected');
            }
            whiteBarSection.onclick = () => handleBarClick('white');

            const whiteBarText = document.createElement('div');
            whiteBarText.className = 'bar-text';
            whiteBarText.textContent = '‚ö™';
            whiteBarSection.appendChild(whiteBarText);

            if (bar.white > 0) {
                const whiteChecker = document.createElement('div');
                whiteChecker.className = 'bar-checker white';
                if (bar.white > 1) {
                    const count = document.createElement('div');
                    count.className = 'bar-count';
                    count.textContent = bar.white;
                    whiteChecker.appendChild(count);
                }
                whiteBarSection.appendChild(whiteChecker);
            }

            barElement.appendChild(whiteBarSection);

            const blackBarSection = document.createElement('div');
            blackBarSection.className = 'bar-section';
            if (selectedPoint === 0 && myColor === 'black') {
                blackBarSection.classList.add('selected');
            }
            blackBarSection.onclick = () => handleBarClick('black');

            const blackBarText = document.createElement('div');
            blackBarText.className = 'bar-text';
            blackBarText.textContent = '‚ö´';
            blackBarSection.appendChild(blackBarText);

            if (bar.black > 0) {
                const blackChecker = document.createElement('div');
                blackChecker.className = 'bar-checker black';
                if (bar.black > 1) {
                    const count = document.createElement('div');
                    count.className = 'bar-count';
                    count.textContent = bar.black;
                    blackChecker.appendChild(count);
                }
                blackBarSection.appendChild(blackChecker);
            }

            barElement.appendChild(blackBarSection);
            container.appendChild(barElement);

            const rightHalf = document.createElement('div');
            rightHalf.className = 'board-half';

            const topRight = document.createElement('div');
            topRight.className = 'board-section';
            for (let i = 19; i <= 24; i++) {
                topRight.appendChild(createPoint(i, 'top', points));
            }
            rightHalf.appendChild(topRight);

            const bottomRight = document.createElement('div');
            bottomRight.className = 'board-section';
            for (let i = 6; i >= 1; i--) {
                bottomRight.appendChild(createPoint(i, 'bottom', points));
            }
            rightHalf.appendChild(bottomRight);

            container.appendChild(rightHalf);

            console.log("‚úÖ Board rendered successfully");
        }

        function createPoint(num, position, points) {
            const point = document.createElement('div');
            point.className = `point ${position}`;
            if (selectedPoint === num) {
                point.classList.add('selected');
            }
            point.dataset.point = num;
            point.onclick = () => handlePointClick(num);

            const triangle = document.createElement('div');
            triangle.className = 'triangle';
            point.appendChild(triangle);

            const number = document.createElement('div');
            number.className = 'point-number';
            number.textContent = num;
            point.appendChild(number);

            const pointKey = num.toString();
            if (points[pointKey] && Array.isArray(points[pointKey]) && points[pointKey].length > 0) {
                const checkers = document.createElement('div');
                checkers.className = 'checkers';

                const pieces = points[pointKey];
                const displayCount = Math.min(pieces.length, 5);

                for (let i = 0; i < displayCount; i++) {
                    const checker = document.createElement('div');
                    checker.className = `checker ${pieces[i]}`;
                    checker.onclick = (e) => {
                        e.stopPropagation();
                        handleCheckerClick(num);
                    };
                    checkers.appendChild(checker);
                }

                if (pieces.length > 5) {
                    const lastChecker = checkers.lastChild;
                    if (lastChecker) {
                        const count = document.createElement('div');
                        count.className = 'checker-count';
                        count.textContent = pieces.length;
                        lastChecker.appendChild(count);
                    }
                }

                point.appendChild(checkers);
            }

            return point;
        }

        function handleBarClick(color) {
            if (!isMyTurn) {
                showNotification('Sizin n√∂vb…ôniz deyil!', 'error');
                return;
            }

            if (color !== myColor) {
                showNotification('Bu sizin da≈üƒ±nƒ±z deyil!', 'error');
                return;
            }

            const bar = gameBoard.bar || {};
            if (!bar[color] || bar[color] === 0) {
                showNotification('BAR-da da≈üƒ±nƒ±z yoxdur!', 'error');
                return;
            }

            selectedPoint = 0;
            renderBoard(gameBoard);
            showNotification(`‚úÖ BAR se√ßildi (${color === 'white' ? '19-24-…ô' : '1-6-ya'} daxil olmalƒ±)`, 'info');
        }

        function handlePointClick(pointNum) {
            if (!isMyTurn) {
                showNotification('Sizin n√∂vb…ôniz deyil!', 'error');
                return;
            }

            const points = gameBoard.points || {};
            const pointKey = pointNum.toString();

            if (selectedPoint === null || selectedPoint === pointNum) {
                const bar = gameBoard.bar || {};
                if (bar[myColor] && bar[myColor] > 0) {
                    showNotification('‚ùå ∆èvv…ôlc…ô BAR-dan h…ôr…ôk…ôt etm…ôlisiniz!', 'error');
                    return;
                }

                if (points[pointKey] && points[pointKey].includes(myColor)) {
                    selectedPoint = pointNum;
                    renderBoard(gameBoard);

                    const canBearOff = checkCanBearOff();
                    if (canBearOff) {
                        showNotification(`‚úÖ Se√ßildi: N√∂qt…ô ${pointNum} (HOME-a √ßƒ±xara bil…ôrsiniz)`, 'info');
                    } else {
                        showNotification(`‚úÖ Se√ßildi: N√∂qt…ô ${pointNum}`, 'info');
                    }
                } else {
                    showNotification('Bu n√∂qt…ôd…ô sizin da≈üƒ±nƒ±z yoxdur!', 'error');
                }
            } else {
                movePiece(selectedPoint, pointNum);
            }
        }

        function checkCanBearOff() {
            const points = gameBoard.points || {};
            const homeStart = myColor === 'white' ? 1 : 19;
            const homeEnd = myColor === 'white' ? 6 : 24;

            if (gameBoard.bar && gameBoard.bar[myColor] > 0) return false;

            for (let i = 1; i <= 24; i++) {
                if (i >= homeStart && i <= homeEnd) continue;
                if (points[i.toString()] && points[i.toString()].some(p => p === myColor)) {
                    return false;
                }
            }
            return true;
        }

        function handleCheckerClick(pointNum) {
            if (!isMyTurn) {
                showNotification('Sizin n√∂vb…ôniz deyil!', 'error');
                return;
            }

            const points = gameBoard.points || {};
            const pointKey = pointNum.toString();

            const bar = gameBoard.bar || {};
            if (bar[myColor] && bar[myColor] > 0) {
                showNotification('‚ùå ∆èvv…ôlc…ô BAR-dan h…ôr…ôk…ôt etm…ôlisiniz!', 'error');
                return;
            }

            if (points[pointKey] && points[pointKey].includes(myColor)) {
                selectedPoint = pointNum;
                renderBoard(gameBoard);

                if (checkCanBearOff()) {
                    document.getElementById('bearOffBtn').disabled = false;
                    showNotification(`‚úÖ Da≈ü se√ßildi: N√∂qt…ô ${pointNum} (HOME-a √ßƒ±xara bil…ôrsiniz)`, 'info');
                } else {
                    document.getElementById('bearOffBtn').disabled = true;
                    showNotification(`‚úÖ Da≈ü se√ßildi: N√∂qt…ô ${pointNum}`, 'info');
                }
            }
        }

        async function rollDice() {
            if (!isMyTurn) {
                showNotification('Sizin n√∂vb…ôniz deyil!', 'error');
                return;
            }

            try {
                await connection.invoke("RollDice");
                document.getElementById('rollBtn').disabled = true;
            } catch (err) {
                console.error("‚ùå RollDice error:", err);
                showNotification('X…ôta ba≈ü verdi!', 'error');
            }
        }

        async function movePiece(from, to) {
            try {
                await connection.invoke("MovePiece", from, to);
            } catch (err) {
                console.error("‚ùå MovePiece error:", err);
                showNotification('H…ôr…ôk…ôt edil…ô bilm…ôdi!', 'error');
                selectedPoint = null;
                renderBoard(gameBoard);
            }
        }

        async function bearOff() {
            if (!isMyTurn) {
                showNotification('Sizin n√∂vb…ôniz deyil!', 'error');
                return;
            }

            if (selectedPoint === null) {
                showNotification('‚ùå ∆èvv…ôlc…ô da≈ü se√ßin!', 'error');
                return;
            }

            if (!checkCanBearOff()) {
                showNotification('‚ùå H…ôl…ô HOME-a √ßƒ±xara bilm…ôzsiniz! B√ºt√ºn da≈ülar home quadrant-da olmalƒ±dƒ±r.', 'error');
                return;
            }

            const homeTo = myColor === 'white' ? 0 : 25;

            console.log(`üè† Attempting bear off: from=${selectedPoint}, to=${homeTo}, color=${myColor}`);

            try {
                await connection.invoke("MovePiece", selectedPoint, homeTo);
                document.getElementById('bearOffBtn').disabled = true;
                selectedPoint = null;
            } catch (err) {
                console.error("‚ùå Bear off error:", err);
                showNotification('HOME-a √ßƒ±xarƒ±la bilm…ôdi! Uyƒüun z…ôr atmalƒ±sƒ±nƒ±z.', 'error');
                selectedPoint = null;
                renderBoard(gameBoard);
            }
        }

        async function endTurn() {
            try {
                await connection.invoke("EndTurn");
                document.getElementById('rollBtn').disabled = false;
                document.getElementById('endTurnBtn').disabled = true;
            } catch (err) {
                console.error("‚ùå EndTurn error:", err);
            }
        }

        async function leaveGame() {
            if (!confirm('Oyundan √ßƒ±xmaq ist…ôdiyiniz…ô …ôminsiniz?')) return;

            try {
                await connection.invoke("LeaveRoom");
                location.reload();
            } catch (err) {
                console.error("‚ùå LeaveRoom error:", err);
                location.reload();
            }
        }

        function showDice(dice) {
            const area = document.getElementById('diceArea');
            area.classList.add('show');
            document.getElementById('die1').textContent = dice[0] || '?';
            document.getElementById('die2').textContent = dice[1] || '?';
        }

        function hideDice() {
            document.getElementById('diceArea').classList.remove('show');
        }

        function updateTurnIndicator() {
            const p1Card = document.getElementById('player1Card');
            const p2Card = document.getElementById('player2Card');

            console.log("üé® Updating turn indicator...");
            console.log("   My color:", myColor);
            console.log("   Is my turn:", isMyTurn);

            if (myColor === 'white') {
                // M…ôn aƒüam (Player 1)
                p1Card.classList.toggle('active', isMyTurn);
                p2Card.classList.toggle('active', !isMyTurn);
            } else {
                // M…ôn qarayam (Player 2)
                p1Card.classList.toggle('active', !isMyTurn);
                p2Card.classList.toggle('active', isMyTurn);
            }

            console.log("‚úÖ Turn indicator updated");
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const messageEl = document.getElementById('notificationMessage');

            notification.className = `notification ${type} show`;
            messageEl.innerHTML = message.replace(/\n/g, '<br>');

            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }

        // ========== EMOJI Sƒ∞STEMƒ∞ ==========
        function toggleEmojiPopup(player) {
            const popupId = player === 'player1' ? 'emojiPopup1' : 'emojiPopup2';
            const popup = document.getElementById(popupId);

            if (activePopup && activePopup !== popup) {
                activePopup.classList.remove('show');
            }

            popup.classList.toggle('show');
            activePopup = popup.classList.contains('show') ? popup : null;
        }

        function switchEmojiTab(player, tab) {
            const popupNum = player === 'player1' ? '1' : '2';
            const popup = document.getElementById(`emojiPopup${popupNum}`);
            const content = document.getElementById(`emojiContent${popupNum}`);

            popup.querySelectorAll('.emoji-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            if (tab === 'emoji') {
                content.innerHTML = `
                        <div class="emoji-popup-grid">
                            <button class="emoji-popup-btn" onclick="sendQuickEmoji('üëã')">üëã</button>
                            <button class="emoji-popup-btn" onclick="sendQuickEmoji('üòä')">üòä</button>
                            <button class="emoji-popup-btn" onclick="sendQuickEmoji('üòÇ')">üòÇ</button>
                            <button class="emoji-popup-btn" onclick="sendQuickEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</button>
                            <button class="emoji-popup-btn" onclick="sendQuickEmoji('üëç')">üëç</button>
                            <button class="emoji-popup-btn" onclick="sendQuickEmoji('üëè')">üëè</button>
                            <button class="emoji-popup-btn" onclick="sendQuickEmoji('üôè')">üôè</button>
                            <button class="emoji-popup-btn" onclick="sendQuickEmoji('üî•')">üî•</button>
                            <button class="emoji-popup-btn" onclick="sendQuickEmoji('‚ú®')">‚ú®</button>
                            <button class="emoji-popup-btn" onclick="sendQuickEmoji('üéâ')">üéâ</button>
                            <button class="emoji-popup-btn" onclick="sendQuickEmoji('üíØ')">üíØ</button>
                            <button class="emoji-popup-btn" onclick="sendQuickEmoji('ü§î')">ü§î</button>
                            <button class="emoji-popup-btn" onclick="sendQuickEmoji('üòç')">üòç</button>
                            <button class="emoji-popup-btn" onclick="sendQuickEmoji('üòé')">üòé</button>
                            <button class="emoji-popup-btn" onclick="sendQuickEmoji('üò¢')">üò¢</button>
                            <button class="emoji-popup-btn" onclick="sendQuickEmoji('üò°')">üò°</button>
                            <button class="emoji-popup-btn" onclick="sendQuickEmoji('ü§©')">ü§©</button>
                            <button class="emoji-popup-btn" onclick="sendQuickEmoji('ü•≥')">ü•≥</button>
                        </div>
                    `;
            } else {
                content.innerHTML = `
                        <div class="quick-msg-list">
                            <button class="quick-msg-item" onclick="sendQuickMessage('Salam! üëã')">Salam! üëã</button>
                            <button class="quick-msg-item" onclick="sendQuickMessage('Uƒüurlar! üçÄ')">Uƒüurlar! üçÄ</button>
                            <button class="quick-msg-item" onclick="sendQuickMessage('Yax≈üƒ± oyun! üéØ')">Yax≈üƒ± oyun! üéØ</button>
                            <button class="quick-msg-item" onclick="sendQuickMessage('T…ô≈ü…ôkk√ºrl…ôr üôè')">T…ô≈ü…ôkk√ºrl…ôr üôè</button>
                            <button class="quick-msg-item" onclick="sendQuickMessage('G√∂z…ôl h…ôr…ôk…ôt! üëè')">G√∂z…ôl! üëè</button>
                            <button class="quick-msg-item" onclick="sendQuickMessage('Ups... üòÖ')">Ups... üòÖ</button>
                            <button class="quick-msg-item" onclick="sendQuickMessage('GG! üéä')">GG! üéä</button>
                        </div>
                    `;
            }
        }

        async function sendQuickEmoji(emoji) {
            if (!currentRoom) {
                showNotification('Oyunda deyilsiniz!', 'error');
                return;
            }

            try {
                console.log(`üì§ Sending emoji: ${emoji} to room: ${currentRoom}`);
                await connection.invoke("SendQuickEmoji", currentRoom, emoji);

                if (activePopup) {
                    activePopup.classList.remove('show');
                    activePopup = null;
                }
            } catch (err) {
                console.error("‚ùå SendQuickEmoji error:", err);
                showNotification('G√∂nd…ôril…ô bilm…ôdi!', 'error');
            }
        }

        async function sendQuickMessage(message) {
            if (!currentRoom) {
                showNotification('Oyunda deyilsiniz!', 'error');
                return;
            }

            try {
                console.log(`üì§ Sending quick message from popup: "${message}" to room: ${currentRoom}`);
                await connection.invoke("SendQuickMessage", currentRoom, message);

                // Popup-u baƒüla
                if (activePopup) {
                    activePopup.classList.remove('show');
                    activePopup = null;
                }

                console.log(`‚úÖ Quick message sent successfully`);
            } catch (err) {
                console.error("‚ùå SendQuickMessage error:", err);
                showNotification('Mesaj g√∂nd…ôril…ô bilm…ôdi!', 'error');
            }
        }
        function displayPlayerEmoji(senderName, emoji) {
            console.log(`üé≠ Displaying emoji from ${senderName}: ${emoji}`);

            const p1Name = document.getElementById('p1Name').textContent;
            const p2Name = document.getElementById('p2Name').textContent;

            let targetAvatar;
            if (senderName === p1Name) {
                targetAvatar = document.getElementById('p1Avatar');
            } else if (senderName === p2Name) {
                targetAvatar = document.getElementById('p2Avatar');
            } else {
                console.warn(`‚ö†Ô∏è Unknown sender: ${senderName}`);
                return;
            }

            const emojiDisplay = document.createElement('div');
            emojiDisplay.className = 'player-emoji-display';
            emojiDisplay.textContent = emoji;

            targetAvatar.appendChild(emojiDisplay);

            setTimeout(() => {
                emojiDisplay.remove();
            }, 2000);
        }

        function displayPlayerQuickMessage(senderName, message) {
            console.log(`üí¨ Displaying quick message from ${senderName}: ${message}`);

            const p1Name = document.getElementById('p1Name').textContent;
            const p2Name = document.getElementById('p2Name').textContent;

            let targetAvatar;
            if (senderName === p1Name) {
                targetAvatar = document.getElementById('p1Avatar');
            } else if (senderName === p2Name) {
                targetAvatar = document.getElementById('p2Avatar');
            } else {
                console.warn(`‚ö†Ô∏è Unknown sender: ${senderName}`);
                return;
            }

            // ∆èg…ôr artƒ±q mesaj varsa, onu sil
            const existingMessage = targetAvatar.querySelector('.player-emoji-display');
            if (existingMessage) {
                existingMessage.remove();
            }

            const messageDisplay = document.createElement('div');
            messageDisplay.className = 'player-emoji-display';
            messageDisplay.style.fontSize = '14px';
            messageDisplay.style.padding = '10px 15px';
            messageDisplay.style.maxWidth = '220px';
            messageDisplay.style.whiteSpace = 'normal';
            messageDisplay.style.wordWrap = 'break-word';
            messageDisplay.style.textAlign = 'center';
            messageDisplay.style.lineHeight = '1.4';
            messageDisplay.style.color = '#333';  // ‚úÖ R…ông …ôlav…ô et
            messageDisplay.style.fontWeight = '600';  // ‚úÖ Qalƒ±n m…ôtn
            messageDisplay.innerHTML = message;  // ‚úÖ innerHTML istifad…ô et

            targetAvatar.appendChild(messageDisplay);

            setTimeout(() => {
                if (messageDisplay.parentElement) {
                    messageDisplay.remove();
                }
            }, 3000);
        }
        document.addEventListener('click', (e) => {
            if (activePopup && !e.target.closest('.emoji-popup') && !e.target.closest('.player-emoji-btn')) {
                activePopup.classList.remove('show');
                activePopup = null;
            }
        });

        // ========== CHAT TOGGLE ==========
        function toggleChat() {
            const panel = document.getElementById('chatPanel');
            const toggle = document.getElementById('chatToggle');

            panel.classList.toggle('open');

            if (panel.classList.contains('open')) {
                toggle.style.display = 'none';
                document.getElementById('chatBadge').classList.remove('show');
                document.getElementById('chatBadge').textContent = '0';
            } else {
                toggle.style.display = 'flex';
            }
        }

        function displayChatMessage(sender, message, isOwn) {
            const messagesDiv = document.getElementById('chatMessages');

            const placeholder = messagesDiv.querySelector('div[style*="text-align: center"]');
            if (placeholder) {
                placeholder.remove();
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${isOwn ? 'own' : ''}`;

            const now = new Date();
            const timeStr = now.toLocaleTimeString('az-AZ', { hour: '2-digit', minute: '2-digit' });

            messageDiv.innerHTML = `
                    <div class="message-sender">${sender}</div>
                    <div class="message-content">
                        <div class="message-text">${message}</div>
                        <div class="message-time">${timeStr}</div>
                    </div>
                `;

            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            const panel = document.getElementById('chatPanel');
            if (!panel.classList.contains('open')) {
                const badge = document.getElementById('chatBadge');
                const currentCount = parseInt(badge.textContent) || 0;
                badge.textContent = currentCount + 1;
                badge.classList.add('show');
            }
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (!message) {
                return;
            }

            if (!currentRoom) {
                showNotification('Oyunda deyilsiniz!', 'error');
                return;
            }

            try {
                console.log(`üì§ Sending chat message: "${message}" to room: ${currentRoom}`);
                await connection.invoke("SendChatMessage", currentRoom, message);
                input.value = '';
            } catch (err) {
                console.error("‚ùå SendChatMessage error:", err);
                showNotification('Mesaj g√∂nd…ôril…ô bilm…ôdi!', 'error');
            }
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }

        async function sendQuickMessageChat(message) {
            if (!currentRoom) {
                showNotification('Oyunda deyilsiniz!', 'error');
                return;
            }

            if (!message || message.trim() === '') {
                showNotification('Mesaj bo≈üdur!', 'error');
                return;
            }

            try {
                console.log(`üì§ Sending quick chat message from chat panel: "${message}" to room: ${currentRoom}`);
                await connection.invoke("SendChatMessage", currentRoom, message);
                console.log(`‚úÖ Quick chat message sent successfully`);
            } catch (err) {
                console.error("‚ùå SendQuickMessageChat error:", err);
                showNotification('Mesaj g√∂nd…ôril…ô bilm…ôdi!', 'error');
            }
        }

        function toggleQuickPanel(type) {
            const emojiPanel = document.getElementById('quickEmojis');
            const messagePanel = document.getElementById('quickMessages');
            const emojiTool = document.getElementById('emojiTool');
            const messageTool = document.getElementById('messageTool');

            if (type === 'emoji') {
                const isActive = emojiPanel.classList.contains('show');
                emojiPanel.classList.toggle('show');
                messagePanel.classList.remove('show');
                emojiTool.classList.toggle('active', !isActive);
                messageTool.classList.remove('active');
            } else {
                const isActive = messagePanel.classList.contains('show');
                messagePanel.classList.toggle('show');
                emojiPanel.classList.remove('show');
                messageTool.classList.toggle('active', !isActive);
                emojiTool.classList.remove('active');
            }
        }

        function insertText(text) {
            const input = document.getElementById('chatInput');
            input.value += text;
            input.focus();
        }

        window.onload = () => {
            initSignalR();
        };

        window.onbeforeunload = () => {
            if (connection) {
                connection.stop();
            }
        };
    </script>
</body>
</html>