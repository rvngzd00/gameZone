<!DOCTYPE html>
<html lang="az">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Durak - Kart Oyunu</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.min.js"></script>
    <link rel="stylesheet" href="./Durak.css">
</head>

<body>
    <div class="messages" id="messages"></div>

    <div class="container">
        <div class="header">
            <h1>ğŸƒ DURAK</h1>
            <div class="user-info" id="userInfo">
                <span id="userName">QoÅŸulur...</span>
            </div>
        </div>

        <!-- Lobby Screen -->
        <div class="lobby-screen" id="lobbyScreen">
            <div class="player-select-section">
                <h2>âš¡ Oyun NÃ¶vÃ¼ SeÃ§in</h2>
                <div class="player-options">
                    <div class="player-option" onclick="selectPlayerCount(2)">
                        <div class="player-count">2</div>
                        <div class="player-label">OyunÃ§u</div>
                    </div>
                    <div class="player-option" onclick="selectPlayerCount(3)">
                        <div class="player-count">3</div>
                        <div class="player-label">OyunÃ§u</div>
                    </div>
                    <div class="player-option" onclick="selectPlayerCount(4)">
                        <div class="player-count">4</div>
                        <div class="player-label">OyunÃ§u</div>
                    </div>
                    <div class="player-option" onclick="selectPlayerCount(6)">
                        <div class="player-count">6</div>
                        <div class="player-label">OyunÃ§u</div>
                    </div>
                </div>
            </div>

            <div class="quick-rooms-section" id="roomsSection" style="display:none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">ğŸ® HazÄ±r Otaqlar</h2>
                    <button class="btn btn-sm" onclick="goBackToPlayerSelect()"
                        style="width: auto; padding: 10px 20px;">
                        â† Geri
                    </button>
                </div>
                <p style="opacity: 0.8; margin-bottom: 20px;">AÅŸaÄŸÄ±dakÄ± otaqlardan birinÉ™ qoÅŸulun</p>
                <div class="rooms-grid" id="quickRoomsList">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Otaqlar yÃ¼klÉ™nir...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Game Screen -->
        <div class="game-screen" id="gameScreen">
            <div class="game-container">
                <div class="game-header">
                    <div class="game-info">
                        <div class="info-item">
                            <div class="label">MÃ¼kafat Fondu</div>
                            <div class="value" id="totalPrize">0 AZN</div>
                        </div>
                        <div class="info-item">
                            <div class="label">Otaq</div>
                            <div class="value" id="currentRoomName">-</div>
                        </div>
                        <div class="info-item">
                            <div class="label">GÃ¶yÉ™rtÉ™dÉ™</div>
                            <div class="value" id="deckCount">36</div>
                        </div>
                    </div>
                    <div class="game-actions">
                        <button class="btn btn-sm btn-success hidden" id="beatenBtn">âœ… Beaten</button>
                        <button class="btn btn-sm btn-danger hidden" id="takeCardsBtn">ğŸ“¥ KartlarÄ± GÃ¶tÃ¼r</button>
                        <button class="btn btn-sm btn-danger" id="leaveRoomBtn">Otaqdan Ã‡Ä±x</button>
                    </div>
                </div>

                <div class="players-section" id="playersSection"></div>

                <div class="game-table" id="gameTable">
                    <div class="trump-card-display" id="trumpDisplay">
                        <div class="deck-stack" id="deckStack">
                            <div class="deck-card"></div>
                            <div class="deck-card"></div>
                            <div class="deck-card"></div>
                            <div class="deck-count" id="deckCountDisplay">24</div>
                        </div>

                        <div class="trump-label">Koz:</div>
                        <div id="trumpCardContainer"></div>
                    </div>
                    <div class="table-cards" id="tableCards">
                        <div class="empty-hand">Masa boÅŸdur</div>
                    </div>
                </div>

                <div class="quick-messages-section">
                    <div style="text-align: center; margin-bottom: 15px; font-weight: 600;">Tez Mesajlar:</div>
                    <div class="quick-messages-grid">
                        <button class="quick-msg-btn" onclick="sendQuickMsg('ğŸ‘', 'YaxÅŸÄ±!')">ğŸ‘ YaxÅŸÄ±</button>
                        <button class="quick-msg-btn" onclick="sendQuickMsg('ğŸ˜‚', 'GÃ¼lmÉ™li!')">ğŸ˜‚ GÃ¼lmÉ™li</button>
                        <button class="quick-msg-btn" onclick="sendQuickMsg('ğŸ”¥', 'Super!')">ğŸ”¥ Super</button>
                        <button class="quick-msg-btn" onclick="sendQuickMsg('ğŸ˜', 'Cool!')">ğŸ˜ Cool</button>
                        <button class="quick-msg-btn" onclick="sendQuickMsg('ğŸ’ª', 'GÃ¼clÃ¼!')">ğŸ’ª GÃ¼clÃ¼</button>
                        <button class="quick-msg-btn" onclick="sendQuickMsg('ğŸ˜¢', 'Pis!')">ğŸ˜¢ Pis</button>
                        <button class="quick-msg-btn" onclick="sendQuickMsg('ğŸ¯', 'DÉ™qiq!')">ğŸ¯ DÉ™qiq</button>
                        <button class="quick-msg-btn" onclick="sendQuickMsg('âš¡', 'SÃ¼rÉ™tli!')">âš¡ SÃ¼rÉ™tli</button>
                    </div>
                </div>

                <div class="player-hand">
                    <div class="player-hand-title">Sizin KartlarÄ±nÄ±z</div>
                    <div class="cards-container" id="playerCards">
                        <div class="empty-hand">KartlarÄ±nÄ±z yÃ¼klÉ™nir...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>

        let currentUserToken = null;
        let currentUserData = null;

        console.log('ğŸƒ [DURAK] Script yÃ¼klÉ™ndi');

        window.addEventListener('message', (event) => {
            console.log('ğŸ“¨ [DURAK] Message alÄ±ndÄ±:', event.data);

            if (event.data && event.data.type === 'INIT_USER') {
                console.log('âœ… [DURAK] INIT_USER qÉ™bul edildi');

                currentUserData = event.data.payload;
                currentUserToken = currentUserData.token;

                console.log('ğŸ‘¤ [DURAK] User:', currentUserData.username);
                console.log('ğŸ« [DURAK] Token:', currentUserToken ? 'VAR' : 'YOX');

                // UI-Ä± yenilÉ™
                document.getElementById('userName').textContent = currentUserData.username;

                console.log('ğŸš€ [DURAK] init() Ã§aÄŸÄ±rÄ±lÄ±r...');
                // SignalR baÅŸlat
                init();
            }
        });

        // ============================================
        // getToken funksiyasÄ±nÄ± dÉ™yiÅŸdir
        // ============================================
        function getToken() {
            return currentUserToken || "";
        }

        // ============================================
        // Qalan kod eyni qalÄ±r
        // ============================================

        // MÃ¶vcud connection, currentUser vÉ™ s. dÉ™yiÅŸÉ™nlÉ™r...
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("https://nehemiah-paginal-alan.ngrok-free.dev/durakHub", { accessTokenFactory: () => getToken() })
            .withAutomaticReconnect()
            .build();

        let currentUser = null;
        let currentRoom = null;
        let myCards = [];
        let gameState = null;
        let selectedPlayerCount = 0;
        let draggedCard = null;

        // ... suitIcons, rankNames vÉ™ s. ...

        // âœ… init() funksiyasÄ±nÄ± sadÉ™lÉ™ÅŸdir
        async function init() {
            console.log('ğŸš€ [DURAK] init() baÅŸladÄ±');

            if (!currentUserToken) {
                console.error('âŒ [DURAK] Token yoxdur!');
                return;
            }

            try {
                await connection.start();
                console.log("âœ… [DURAK] SignalR qoÅŸuldu");
            } catch (err) {
                console.error("âŒ [DURAK] SignalR xÉ™tasÄ±:", err);
                showMessage("ServerÉ™ qoÅŸulmaq alÄ±nmadÄ±", "error");
            }
        }

        // ... qalan bÃ¼tÃ¼n kod eyni qalÄ±r (setupEventHandlers vÉ™ s.) ...

        // âŒ SÄ°L - connection.on("UserData") event handler-ini dÉ™yiÅŸdir:
        connection.on("UserData", (data) => {
            currentUser = data;
            console.log('ğŸ‘¤ [DURAK] UserData event:', data);

            // âœ… ArtÄ±q React-dÉ™n aldÄ±q, yenidÉ™n yazmÄ±rÄ±q
            // document.getElementById("userName").textContent = data.fullName;

            document.getElementById("lobbyScreen").style.display = "block";

            // URL parametrindÉ™n player count yoxla
            const urlParams = new URLSearchParams(window.location.search);
            const playersParam = urlParams.get('players');
            if (playersParam && ['2', '3', '4', '6'].includes(playersParam)) {
                selectPlayerCount(parseInt(playersParam));
            }
        });

        // ... qalan bÃ¼tÃ¼n funksiyalar vÉ™ event handler-lÉ™r eyni qalÄ±r ...

        console.log('âœ… [DURAK] Script tam yÃ¼klÉ™ndi, postMessage gÃ¶zlÉ™nilir...');


        // function getToken() {
        //     const raw = document.cookie
        //         .split("; ")
        //         .find(row => row.startsWith("AuthToken="))
        //         ?.split("=")[1];
        //     return raw ? decodeURIComponent(raw).trim() : "";
        // }

        // const connection = new signalR.HubConnectionBuilder()
        //     .withUrl("/durakHub", { accessTokenFactory: () => getToken() })
        //     .withAutomaticReconnect()
        //     .build();

        // let currentUser = null;
        // let currentRoom = null;
        // let myCards = [];
        // let gameState = null;
        // let selectedPlayerCount = 0;
        // let draggedCard = null;

        const suitIcons = {
            'Hearts': 'â™¥',
            'Diamonds': 'â™¦',
            'Clubs': 'â™£',
            'Spades': 'â™ '
        };

        const rankNames = {
            '6': '6', '7': '7', '8': '8', '9': '9', '10': '10',
            'Jack': 'J', 'Queen': 'Q', 'King': 'K', 'Ace': 'A'
        };

        // Initialize
        // async function init() {
        //     try {
        //         await connection.start();
        //         console.log("âœ… SignalR qoÅŸuldu");
        //     } catch (err) {
        //         console.error("âŒ SignalR xÉ™tasÄ±:", err);
        //         showMessage("ServerÉ™ qoÅŸulmaq alÄ±nmadÄ±", "error");
        //     }
        // }

        // SignalR Events
        // connection.on("UserData", (data) => {
        //     currentUser = data;
        //     document.getElementById("userName").textContent = data.fullName;
        //     document.getElementById("lobbyScreen").style.display = "block";

        //     // URL parametrindÉ™n player count yoxla
        //     const urlParams = new URLSearchParams(window.location.search);
        //     const playersParam = urlParams.get('players');
        //     if (playersParam && ['2', '3', '4', '6'].includes(playersParam)) {
        //         selectPlayerCount(parseInt(playersParam));
        //     }
        // });

        connection.on("RefundProcessed", (data) => {
            showMessage(data.message, "success");
            console.log('ğŸ’¸ Refund:', data.amount, 'AZN');
        });

        connection.on("JoinedRoom", (data) => {
            currentRoom = data;
            document.getElementById("currentRoomName").textContent = data.roomName;
            document.getElementById("lobbyScreen").style.display = "none";
            document.getElementById("gameScreen").style.display = "block";

            let message = `${data.roomName} otaÄŸÄ±na qoÅŸuldunuz`;
            if (data.entryFee > 0) {
                message += ` (GiriÅŸ haqqÄ±: ${data.entryFee} AZN)`;
            }
            showMessage(message, "success");
        });

        connection.on("PlayerJoined", (playerName) => {
            showMessage(`${playerName} oyuna qoÅŸuldu`, "info");
        });

        connection.on("PlayerLeft", (playerName) => {
            showMessage(`${playerName} oyunu tÉ™rk etdi`, "info");
        });

        connection.on("GameStarted", (data) => {
            showMessage("Oyun baÅŸladÄ±! ğŸ®", "success");
            renderTrumpCard(data.trumpCard);
        });

        connection.on("YourCards", (cards) => {
            myCards = cards;
            renderPlayerCards();
        });

        connection.on("GameState", (state) => {
            gameState = state;

            console.log('ğŸ® GAME STATE UPDATED:', state);

            renderPlayers(state.players);
            renderTableCards(state);

            // âœ… Deck count update
            document.getElementById("deckCount").textContent = state.deckCount;
            document.getElementById("deckCountDisplay").textContent = state.deckCount;

            // âœ… Deck gÃ¶rÃ¼nÃ¼ÅŸÃ¼
            const deckStack = document.getElementById("deckStack");
            if (state.deckCount === 0) {
                deckStack.style.display = 'none';
            } else {
                deckStack.style.display = 'block';
            }

            if (state.totalPrize > 0) {
                document.getElementById("totalPrize").textContent = `${state.totalPrize} AZN`;
            }

            if (myCards.length > 0) {
                renderPlayerCards();
                console.log('ğŸ”„ Player cards re-rendered after state update');
            }

            updateBeatenButton(state);
        });

        connection.on("CardsAttacked", (data) => {
            showMessage(`${data.playerName} hÃ¼cum etdi`, "info");
        });

        connection.on("CardsDefended", (data) => {
            showMessage(`${data.playerName} mÃ¼dafiÉ™ etdi`, "success");
        });

        connection.on("CardsTaken", (data) => {
            showMessage(`${data.playerName} kartlarÄ± gÃ¶tÃ¼rdÃ¼`, "warning");
        });

        connection.on("CardsDiscarded", () => {
            showMessage("Kartlar yandÄ±rÄ±ldÄ± ğŸ”¥", "success");
        });

        connection.on("GameOver", (data) => {
            showMessage(data.message, "info");

            let alertMessage = data.message;
            if (data.winnerPrize) {
                alertMessage += `\n\nğŸ’° MÃ¼kafat: ${data.winnerPrize} AZN`;
                alertMessage += `\nğŸ“Š Komissiya: ${data.commission} AZN`;
            }

            if (data.canRematch) {
                alertMessage += `\n\nğŸ”„ YenidÉ™n oynamaq istÉ™yirsiniz?`;
                if (data.entryFee > 0) {
                    alertMessage += `\n(GiriÅŸ haqqÄ±: ${data.entryFee} AZN)`;
                }
            }

            alert(alertMessage);

            // âœ… Rematch button gÃ¶stÉ™r
            if (data.canRematch) {
                showRematchUI(data.entryFee);
            }
        });


        // âœ… Rematch vote notification
        connection.on("RematchVote", (data) => {
            showMessage(`${data.playerName} yenidÉ™n oynamaq istÉ™yir (${data.votes}/${data.required})`, "info");
        });

        // âœ… Rematch failed
        connection.on("RematchFailed", (data) => {
            showMessage(data.message, "error");
            hideRematchUI();
        });

        // âœ… Rematch UI
        function showRematchUI(entryFee) {
            const existingUI = document.getElementById("rematchUI");
            if (existingUI) {
                existingUI.remove();
            }

            const rematchDiv = document.createElement("div");
            rematchDiv.id = "rematchUI";
            rematchDiv.style.cssText = `
        position: fixed;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.95);
        padding: 30px;
        border-radius: 20px;
        text-align: center;
        z-index: 2000;
        border: 3px solid #fbbf24;
        box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    `;

            rematchDiv.innerHTML = `
        <h2 style="margin-bottom: 20px; color: #fbbf24;">ğŸ”„ YenidÉ™n Oyna</h2>
        ${entryFee > 0 ? `<p style="margin-bottom: 20px; font-size: 1.2em;">GiriÅŸ haqqÄ±: ${entryFee} AZN</p>` : ''}
        <button class="btn btn-success" onclick="voteRematch()" style="width: 200px; margin: 0 auto;">
            âœ… RazÄ±yam
        </button>
    `;

            document.body.appendChild(rematchDiv);
        }

        function hideRematchUI() {
            const rematchUI = document.getElementById("rematchUI");
            if (rematchUI) {
                rematchUI.remove();
            }
        }

        async function voteRematch() {
            try {
                await connection.invoke("VoteRematch");
                showMessage("SÉ™siniz qeydÉ™ alÄ±ndÄ±! â³", "success");
            } catch (err) {
                showMessage("XÉ™ta: " + err.toString(), "error");
            }
        }


        connection.on("Error", (msg) => showMessage(msg, "error"));
        connection.on("JoinError", (msg) => showMessage(msg, "error"));
        connection.on("GameError", (msg) => showMessage(msg, "error"));
        connection.on("ActionError", (msg) => showMessage(msg, "error"));

        connection.on("LeftRoom", () => {
            currentRoom = null;
            myCards = [];
            gameState = null;
            document.getElementById("gameScreen").style.display = "none";
            document.getElementById("lobbyScreen").style.display = "block";
            document.getElementById("roomsSection").style.display = "none";
        });

        connection.on("QuickMessage", (data) => {
            showMessage(`${data.playerName}: ${data.emoji} ${data.message}`, "info");
            const display = document.createElement("div");
            display.className = "quick-message-display";
            display.innerHTML = `
                    <div style="margin-bottom: 10px; font-size: 0.5em; opacity: 0.8;">${data.playerName}</div>
                    <div>${data.emoji} ${data.message}</div>
                `;
            document.body.appendChild(display);
            setTimeout(() => display.remove(), 2000);
        });

        // Player Selection
        async function selectPlayerCount(count) {
            selectedPlayerCount = count;
            await loadQuickRooms(count);
            document.getElementById("roomsSection").style.display = "block";
        }

        function goBackToPlayerSelect() {
            document.getElementById("roomsSection").style.display = "none";
            selectedPlayerCount = 0;
        }

        async function loadQuickRooms(playerCount) {
            try {
                const quickRooms = await connection.invoke("GetQuickRooms");
                const filtered = quickRooms.filter(r => r.maxPlayers === playerCount);
                const container = document.getElementById("quickRoomsList");

                if (filtered.length === 0) {
                    container.innerHTML = '<div class="empty-hand">HazÄ±rda uyÄŸun otaq yoxdur</div>';
                    return;
                }

                container.innerHTML = filtered.map(room => `
                        <div class="room-card" onclick="joinRoom('${room.roomId}')">
                            <h3>âš¡ ${room.roomName}</h3>
                            <div class="room-info">
                                <span>ğŸ‘¥ ${room.playerCount}/${room.maxPlayers}</span>
                                ${room.entryFee > 0 ? `<span>ğŸ’° ${room.entryFee} AZN</span>` : ''}
                            </div>
                            ${room.totalPrize > 0 ? `<p style="color: #fbbf24; font-weight: 600;">ğŸ† ${room.totalPrize} AZN</p>` : ''}
                            <span class="room-status waiting">â³ GÃ¶zlÉ™yir</span>
                        </div>
                    `).join('');
            } catch (err) {
                console.error(err);
                container.innerHTML = '<div class="empty-hand">YÃ¼klÉ™mÉ™ xÉ™tasÄ±</div>';
            }
        }

        async function joinRoom(roomId) {
            try {
                await connection.invoke("JoinRoom", roomId);
            } catch (err) {
                showMessage("OtaÄŸa qoÅŸulmaq alÄ±nmadÄ±", "error");
            }
        }

        async function sendQuickMsg(emoji, message) {
            try {
                await connection.invoke("SendQuickMessage", emoji, message);
            } catch (err) {
                console.error("Quick message error:", err);
            }
        }

        // Rendering Functions
        function renderTrumpCard(card) {
            if (!card) return;
            const container = document.getElementById("trumpCardContainer");
            const cardDiv = createCardElement(card, false, false);
            container.innerHTML = '';
            container.appendChild(cardDiv);
        }

        function renderPlayers(players) {
            const container = document.getElementById("playersSection");
            container.innerHTML = players.map(player => {
                let roleClass = '';
                let roleText = '';

                if (player.isAttacker) {
                    roleClass = 'attacker';
                    roleText = '<span class="player-role attacker">âš”ï¸ SaldÄ±ran</span>';
                } else if (player.isDefender) {
                    roleClass = 'defender';
                    roleText = '<span class="player-role defender">ğŸ›¡ï¸ MÃ¼dafiÉ™Ã§i</span>';
                }

                return `
                        <div class="player-card ${roleClass}">
                            <div class="player-name">${player.name}</div>
                            <div class="player-cards-count">ğŸƒ ${player.cardCount} kart</div>
                            ${roleText}
                        </div>
                    `;
            }).join('');
        }

        function renderTableCards(state) {
            const container = document.getElementById("tableCards");

            // âœ… Backend artÄ±q DefendedPairs gÃ¶ndÉ™rir (array)
            const hasDefended = state.defendedCards && state.defendedCards.length > 0;
            const hasUndefended = state.tableCards && state.tableCards.length > 0;

            if (!hasDefended && !hasUndefended) {
                container.innerHTML = '<div class="empty-hand">Masa boÅŸdur</div>';
                return;
            }

            container.innerHTML = '';

            // âœ… currentUser.userId int-É™ Ã§evir (string olmasÄ±n)
            let isDefender = false;
            if (currentUser && state.players) {
                const myUserId = parseInt(currentUser.userId); // âœ… int-É™ Ã§evir
                for (let p of state.players) {
                    if (p.userId === myUserId) { // âœ… int === int
                        isDefender = p.isDefender;
                        break;
                    }
                }
            }

            console.log('ğŸ›¡ï¸ AM I DEFENDER?', isDefender);
            console.log('ğŸ‘¤ My User ID:', currentUser?.userId, '(parsed:', parseInt(currentUser?.userId), ')');
            console.log('ğŸ‘¥ All Players:', state.players);

            // 1. âœ… Defended pairs (array)
            if (hasDefended) {
                state.defendedCards.forEach(pair => {
                    const pairDiv = document.createElement('div');
                    pairDiv.className = 'card-pair';
                    pairDiv.style.border = '2px solid rgba(16, 185, 129, 0.5)';
                    pairDiv.style.background = 'rgba(16, 185, 129, 0.1)';
                    pairDiv.style.padding = '10px';
                    pairDiv.style.borderRadius = '10px';

                    const attackCardEl = createCardElement(pair.attackCard, false, false);
                    const defendCardEl = createCardElement(pair.defendCard, false, false);

                    pairDiv.appendChild(attackCardEl);
                    pairDiv.appendChild(defendCardEl);
                    container.appendChild(pairDiv);
                });
            }

            function showVoteNotification(data) {
                // MÃ¶vcud notification-larÄ± sil
                document.querySelectorAll('.vote-notification').forEach(n => n.remove());

                const notification = document.createElement("div");
                notification.className = "vote-notification";

                const action = data.action === "Beaten" ? "ğŸ”¥ Beaten" : "ğŸ“¥ GÃ¶tÃ¼rmÉ™k";

                notification.innerHTML = `
        <div style="margin-bottom: 5px;">${data.playerName}</div>
        <div style="font-size: 1.2em;">${action} (${data.votes}/${data.required})</div>
    `;

                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(400px)';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);

                console.log(`ğŸ—³ï¸ Vote: ${data.playerName} - ${data.action} (${data.votes}/${data.required})`);
            }

            // 2. âœ… Undefended cards - DROP ZONE (yalnÄ±z mÃ¼dafiÉ™Ã§i Ã¼Ã§Ã¼n)
            if (hasUndefended) {
                state.tableCards.forEach(card => {
                    const cardWrapper = document.createElement('div');
                    const cardEl = createCardElement(card, false, false);

                    console.log('ğŸƒ Creating wrapper for:', card.rank, 'of', card.suit, '| isDefender:', isDefender);

                    if (isDefender === true) {
                        // âœ… MÃœDAFÄ°ÆÃ‡Ä° - DROP ZONE
                        cardWrapper.className = 'card-pair card-drop-zone';
                        cardWrapper.style.border = '3px dashed rgba(59, 130, 246, 0.8)'; // Mavi
                        cardWrapper.style.padding = '20px';
                        cardWrapper.style.borderRadius = '15px';
                        cardWrapper.style.minHeight = '170px';
                        cardWrapper.style.minWidth = '130px';
                        cardWrapper.style.display = 'flex';
                        cardWrapper.style.alignItems = 'center';
                        cardWrapper.style.justifyContent = 'center';
                        cardWrapper.style.background = 'rgba(59, 130, 246, 0.1)';

                        cardWrapper.setAttribute('data-attack-rank', card.rank);
                        cardWrapper.setAttribute('data-attack-suit', card.suit);

                        // âœ… Drag & Drop event handlers
                        cardWrapper.ondragover = function (e) {
                            e.preventDefault();
                            e.stopPropagation();
                            console.log('ğŸ“ DRAGOVER on drop zone!');
                            this.style.background = 'rgba(16, 185, 129, 0.3)'; // YaÅŸÄ±l
                            this.style.borderColor = '#10b981';
                            return false;
                        };

                        connection.on("PlayerVoted", (data) => {
                            showVoteNotification(data);
                        });


                        cardWrapper.ondragleave = function (e) {
                            e.preventDefault();
                            this.style.background = 'rgba(59, 130, 246, 0.1)'; // Mavi
                            this.style.borderColor = 'rgba(59, 130, 246, 0.8)';
                        };

                        cardWrapper.ondrop = function (e) {
                            e.preventDefault();
                            e.stopPropagation();
                            console.log('ğŸ¯ DROP EVENT TRIGGERED!!!');
                            this.style.background = 'rgba(59, 130, 246, 0.1)';
                            this.style.borderColor = 'rgba(59, 130, 246, 0.8)';
                            handleDropOnZone(this);
                            return false;
                        };

                        console.log('âœ… DROP ZONE CREATED for card:', card.rank, card.suit);
                    } else {
                        // SaldÄ±ran vÉ™ ya tamaÅŸaÃ§Ä±
                        cardWrapper.className = 'card-pair';
                        cardWrapper.style.border = '2px solid rgba(239, 68, 68, 0.3)';
                        cardWrapper.style.padding = '10px';
                        cardWrapper.style.borderRadius = '10px';

                        console.log('âš”ï¸ Attack card (no drop zone)');
                    }

                    cardWrapper.appendChild(cardEl);
                    container.appendChild(cardWrapper);
                });
            }

            console.log('ğŸ“Š Table rendered - Defended:', hasDefended ? state.defendedCards.length : 0,
                '| Undefended:', hasUndefended ? state.tableCards.length : 0);
        }

        function renderPlayerCards() {
            const container = document.getElementById("playerCards");

            if (myCards.length === 0) {
                container.innerHTML = '<div class="empty-hand">KartlarÄ±nÄ±z yoxdur</div>';
                return;
            }

            container.innerHTML = '';

            let canAttack = false;
            let isDefender = false;

            if (gameState && gameState.isGameActive && currentUser) {
                const players = gameState.players || [];
                const myPlayer = players.find(p => p.userId === currentUser.userId);

                if (myPlayer) {
                    isDefender = myPlayer.isDefender;

                    // âœ… YENÄ° MÆNTIQ:
                    // 1. MÃ¼dafiÉ™Ã§i hÃ¼cum edÉ™ bilmÉ™z
                    // 2. Æsas attacker hÉ™miÅŸÉ™ hÃ¼cum edÉ™ bilÉ™r
                    // 3. DigÉ™r oyunÃ§ular masada kart varsa É™lavÉ™ edÉ™ bilÉ™r

                    const isMainAttacker = myPlayer.isAttacker;
                    const hasCardsOnTable = (gameState.tableCards && gameState.tableCards.length > 0) ||
                        (gameState.defendedCards && gameState.defendedCards.length > 0);

                    if (!isDefender) {
                        if (isMainAttacker) {
                            // Æsas attacker hÉ™miÅŸÉ™ hÃ¼cum edÉ™ bilÉ™r
                            canAttack = true;
                        } else if (hasCardsOnTable) {
                            // DigÉ™r oyunÃ§ular masada kart varsa É™lavÉ™ edÉ™ bilÉ™r
                            canAttack = true;
                        }
                    }

                    console.log('ğŸ‘¤ Player Status:', {
                        isDefender,
                        isMainAttacker,
                        hasCardsOnTable,
                        canAttack
                    });
                }
            }

            myCards.forEach(card => {
                const cardElement = createCardElement(card, false, true);

                cardElement.draggable = true;
                cardElement.classList.add('draggable');
                cardElement.addEventListener('dragstart', (e) => handleDragStart(e, card));
                cardElement.addEventListener('dragend', handleDragEnd);

                // âœ… HÃ¼cum edÉ™ bilÉ™n oyunÃ§ular Ã¼Ã§Ã¼n style
                if (canAttack) {
                    // Masada eyni rank varsa - highlight et
                    const tableRanks = new Set();

                    if (gameState.tableCards) {
                        gameState.tableCards.forEach(c => tableRanks.add(c.rank));
                    }

                    if (gameState.defendedCards) {
                        gameState.defendedCards.forEach(pair => {
                            tableRanks.add(pair.attackCard.rank);
                            tableRanks.add(pair.defendCard.rank);
                        });
                    }

                    // Ä°lk hÃ¼cum vÉ™ ya masada eyni rank varsa
                    const canPlayThisCard = tableRanks.size === 0 || tableRanks.has(card.rank);

                    if (canPlayThisCard) {
                        cardElement.style.cursor = 'pointer';
                        cardElement.style.border = '3px solid rgba(239, 68, 68, 0.8)';
                        cardElement.style.boxShadow = '0 0 15px rgba(239, 68, 68, 0.5)';

                        cardElement.onclick = function () {
                            attackWithCard(card);
                        };
                    } else {
                        // Bu kartla hÃ¼cum edilÉ™ bilmÉ™z
                        cardElement.style.opacity = '0.5';
                        cardElement.style.cursor = 'not-allowed';
                    }
                }

                container.appendChild(cardElement);
            });
        }
        function createCardElement(card, isSelected = false, isClickable = false) {
            const suit = card.suit.toLowerCase();
            const rank = rankNames[card.rank] || card.rank;
            const suitIcon = suitIcons[card.suit];

            const cardDiv = document.createElement('div');
            cardDiv.className = `card ${suit} ${isSelected ? 'selected' : ''}`;
            cardDiv.innerHTML = `
                    <div class="card-rank">${rank}</div>
                    <div class="card-suit">${suitIcon}</div>
                    <div class="card-rank">${rank}</div>
                `;

            return cardDiv;
        }

        // Drag & Drop Handlers
        function handleDragStart(e, card) {
            // âœ… Yoxla: mÉ™nim kartÄ±mdÄ±r?
            const isMyCard = myCards.some(c => c.rank === card.rank && c.suit === card.suit);

            if (!isMyCard) {
                console.log('âŒ Bu sizin kartÄ±nÄ±z deyil!');
                e.preventDefault();
                return;
            }

            draggedCard = card;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', JSON.stringify(card)); // âœ… Data É™lavÉ™ et

            console.log('ğŸ¯ Drag started:', card.rank, 'of', card.suit);
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');

            // Remove drag-over from all drop zones
            document.querySelectorAll('.card-drop-zone').forEach(zone => {
                zone.classList.remove('drag-over');
            });

            console.log('ğŸ Drag ended');
        }

        function handleDragOver(e) {
            e.preventDefault(); // âœ… BU Ã‡OX VACÄ°BDÄ°R!
            e.stopPropagation();

            e.dataTransfer.dropEffect = 'move';

            const dropZone = e.currentTarget;
            if (dropZone && !dropZone.classList.contains('drag-over')) {
                dropZone.classList.add('drag-over');
                console.log('ğŸ“ Drag over drop zone');
            }

            return false;
        }

        function handleDragLeave(e) {
            e.preventDefault();

            const dropZone = e.currentTarget;
            const rect = dropZone.getBoundingClientRect();

            // Check if mouse is actually outside the drop zone
            if (
                e.clientX < rect.left ||
                e.clientX >= rect.right ||
                e.clientY < rect.top ||
                e.clientY >= rect.bottom
            ) {
                dropZone.classList.remove('drag-over');
                console.log('ğŸšª Drag leave');
            }
        }

        async function handleDropOnZone(dropZone) {
            console.log('ğŸ¯ğŸ¯ğŸ¯ DROP EVENT TRIGGERED! ğŸ¯ğŸ¯ğŸ¯');

            if (!draggedCard) {
                console.log('âŒ No dragged card');
                showMessage("XÉ™ta: Kart seÃ§ilmÉ™yib", "error");
                return;
            }

            const attackRank = dropZone.getAttribute('data-attack-rank');
            const attackSuit = dropZone.getAttribute('data-attack-suit');

            console.log('ğŸ“ Attack:', attackRank, attackSuit);
            console.log('ğŸ“ Defend:', draggedCard.rank, draggedCard.suit);

            if (!attackRank || !attackSuit) {
                showMessage("XÉ™ta: HÃ¼cum kartÄ± tapÄ±lmadÄ±", "error");
                return;
            }

            try {
                await connection.invoke("Defend", [{
                    AttackCard: { rank: attackRank, suit: attackSuit },
                    DefendCard: draggedCard
                }]);
                console.log('âœ… Defense sent!');
                showMessage("MÃ¼dafiÉ™ gÃ¶ndÉ™rildi! âœ…", "success");
            } catch (err) {
                console.error('âŒ Error:', err);
                showMessage("MÃ¼dafiÉ™ alÄ±nmadÄ± âŒ", "error");
            }

            draggedCard = null;
        }        //async function handleDrop(e) {
        //    e.preventDefault();
        //    e.stopPropagation();

        //    console.log('ğŸ¯ DROP EVENT TRIGGERED!');

        //    const dropZone = e.currentTarget;
        //    dropZone.classList.remove('drag-over');

        //    if (!draggedCard) {
        //        console.log('âŒ No dragged card');
        //        return false;
        //    }

        //    // âœ… getAttribute istifadÉ™ et
        //    const attackRank = dropZone.getAttribute('data-attack-rank');
        //    const attackSuit = dropZone.getAttribute('data-attack-suit');

        //    console.log('ğŸ“ Attack card from drop zone:', attackRank, attackSuit);
        //    console.log('ğŸ“ Defend card (dragged):', draggedCard.rank, draggedCard.suit);

        //    if (!attackRank || !attackSuit) {
        //        console.log('âŒ No attack card data in drop zone');
        //        showMessage("XÉ™ta: HÃ¼cum kartÄ± tapÄ±lmadÄ±", "error");
        //        return false;
        //    }

        //    const attackCard = {
        //        rank: attackRank,
        //        suit: attackSuit
        //    };

        //    console.log('âœ… Sending defense to server...');

        //    try {
        //        await connection.invoke("Defend", [{
        //            AttackCard: attackCard,
        //            DefendCard: draggedCard
        //        }]);
        //        console.log('âœ… Defense successful!');
        //        showMessage("MÃ¼dafiÉ™ uÄŸurlu! âœ…", "success");
        //    } catch (err) {
        //        showMessage("MÃ¼dafiÉ™ alÄ±nmadÄ± âŒ", "error");
        //        console.error('âŒ Defense failed:', err);
        //    }

        //    draggedCard = null;
        //    return false;
        //}        // Attack with card (click)

        async function attackWithCard(card) {
            console.log('âš”ï¸âš”ï¸âš”ï¸ ATTACK FUNCTION CALLED âš”ï¸âš”ï¸âš”ï¸');
            console.log('Card:', card);
            console.log('GameState:', gameState);
            console.log('CurrentUser:', currentUser);

            if (!gameState || !currentUser) {
                console.log('âŒ No gameState or currentUser');
                showMessage("XÉ™ta: Oyun state tapÄ±lmadÄ±", "error");
                return;
            }

            const myPlayer = gameState.players.find(p => p.userId === currentUser.userId);

            if (!myPlayer) {
                showMessage("OyunÃ§u tapÄ±lmadÄ±", "error");
                return;
            }

            // âœ… MÃ¼dafiÉ™Ã§i hÃ¼cum edÉ™ bilmÉ™z
            if (myPlayer.isDefender) {
                showMessage("MÃ¼dafiÉ™Ã§i hÃ¼cum edÉ™ bilmÉ™z", "warning");
                return;
            }

            // âœ… Ä°lk hÃ¼cum - yalnÄ±z É™sas attacker
            const hasCardsOnTable = (gameState.tableCards && gameState.tableCards.length > 0) ||
                (gameState.defendedCards && gameState.defendedCards.length > 0);

            if (!hasCardsOnTable && !myPlayer.isAttacker) {
                showMessage("Ä°lk hÃ¼cumu yalnÄ±z saldÄ±ran edÉ™ bilÉ™r", "warning");
                return;
            }

            try {
                console.log('ğŸ“¤ Sending attack to server:', [card]);
                await connection.invoke("Attack", [card]);
                console.log('âœ… Attack sent successfully!');

                if (myPlayer.isAttacker) {
                    showMessage("HÃ¼cum gÃ¶ndÉ™rildi! âš”ï¸", "success");
                } else {
                    showMessage("ÆlavÉ™ hÃ¼cum! â•", "success");
                }
            } catch (err) {
                console.error('âŒ Attack error:', err);
                showMessage("HÃ¼cum alÄ±nmadÄ±: " + err.toString(), "error");
            }
        }

        // Beaten Button
        function updateBeatenButton(state) {
            const beatenBtn = document.getElementById("beatenBtn");
            const takeBtn = document.getElementById("takeCardsBtn");

            if (!state.isGameActive || !currentUser) {
                beatenBtn.classList.add("hidden");
                takeBtn.classList.add("hidden");
                return;
            }

            const hasUndefendedCards = state.tableCards && state.tableCards.length > 0;
            const hasDefendedCards = state.defendedCards && state.defendedCards.length > 0;
            const hasAnyCards = hasUndefendedCards || hasDefendedCards;

            // âœ… Beaten button - hamÄ± Ã¼Ã§Ã¼n (bÃ¼tÃ¼n kartlar mÃ¼dafiÉ™ olunarsa)
            if (!hasUndefendedCards && hasDefendedCards) {
                beatenBtn.classList.remove("hidden");
                beatenBtn.textContent = "âœ… Beaten (RazÄ±yam)";
            } else {
                beatenBtn.classList.add("hidden");
            }

            // âœ… Take Cards button - hamÄ± Ã¼Ã§Ã¼n (masada kart varsa)
            if (hasAnyCards) {
                takeBtn.classList.remove("hidden");
                takeBtn.textContent = "ğŸ“¥ GÃ¶tÃ¼rmÉ™k (RazÄ±yam)";
            } else {
                takeBtn.classList.add("hidden");
            }
        }
        document.getElementById("beatenBtn").addEventListener("click", async () => {
            try {
                await connection.invoke("Beaten");
                // Confirm mesajÄ±nÄ± sil - sÉ™svermÉ™ sistemi olduÄŸu Ã¼Ã§Ã¼n lazÄ±m deyil
            } catch (err) {
                showMessage("SÉ™s vermÉ™k alÄ±nmadÄ±", "error");
                console.error(err);
            }
        });

        document.getElementById("takeCardsBtn").addEventListener("click", async () => {
            try {
                await connection.invoke("TakeCards");
                // Confirm mesajÄ±nÄ± sil - sÉ™svermÉ™ sistemi olduÄŸu Ã¼Ã§Ã¼n lazÄ±m deyil
            } catch (err) {
                showMessage("SÉ™s vermÉ™k alÄ±nmadÄ±", "error");
                console.error(err);
            }
        });

        document.getElementById("leaveRoomBtn").addEventListener("click", async () => {
            if (!confirm("Otaqdan Ã§Ä±xmaq istÉ™diyinizÉ™ É™minsiniz?")) return;
            try {
                await connection.invoke("LeaveRoom");
            } catch (err) {
                showMessage("Otaqdan Ã§Ä±xmaq alÄ±nmadÄ±", "error");
            }
        });

        function showMessage(text, type = "info") {
            const container = document.getElementById("messages");
            const msg = document.createElement("div");
            msg.className = `message ${type}`;
            msg.textContent = text;
            container.appendChild(msg);

            setTimeout(() => {
                msg.style.animation = "slideIn 0.3s ease-out reverse";
                setTimeout(() => msg.remove(), 300);
            }, 4000);
        }

        init();
        console.log('âœ… Durak Game Ready! Drag & Drop + Beaten Active.');
    </script>
</body>

</html>