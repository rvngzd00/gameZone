<!DOCTYPE html>
<html lang="az">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ° Poker Casino</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.0/signalr.min.js"></script>
    <link rel="stylesheet" href="./Poker.css">
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>â™  POKER â™¥</h1>
        </div>

        <div class="user-info">
            <div>
                <strong id="userName">YÃ¼klÉ™nir...</strong>
            </div>
            <div class="balance">
                ğŸ’° <span id="userBalance">0</span> AZN
            </div>
        </div>

        <div id="roomListSection">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2>ğŸ® Poker OtaqlarÄ±</h2>
            </div>
            <div class="room-grid" id="roomGrid">
                <div style="text-align: center; padding: 40px;">YÃ¼klÉ™nir...</div>
            </div>
        </div>

        <div id="gameSection" class="game-section">
            <div style="margin-bottom: 20px; text-align: center;">
                <h2 style="color: #ffd700;">Otaq: <span id="currentRoomName">-</span></h2>
                <p style="margin-top: 10px;">Balans: <span id="gameBalance">0</span> AZN | Ã‡iplÉ™r: <span
                        id="playerChips" style="color: #4ade80;">0</span></p>
            </div>

            <div class="poker-table" id="pokerTable">
                <div class="table-center">
                    <div class="pot-amount">POT: <span id="potAmount">0</span></div>
                    <div style="margin: 5px 0; color: #fff;">MÉ™rc: <span id="currentBet">0</span></div>
                    <div class="community-cards-area" id="communityCards"></div>
                </div>
            </div>

            <div class="hand-cards" id="handCards"></div>

            <div class="actions">
                <button class="btn btn-start" id="startGameBtn" onclick="startGame()" style="display: none;">ğŸ®
                    BaÅŸlat</button>
                <button class="btn btn-fold" id="foldBtn" onclick="playerAction('fold')" disabled>FOLD</button>
                <button class="btn btn-check" id="checkBtn" onclick="playerAction('check')" disabled>CHECK</button>
                <button class="btn btn-call" id="callBtn" onclick="playerAction('call')" disabled>CALL</button>
                <div style="display: flex; gap: 10px;">
                    <input type="number" id="raiseInput" class="bet-input" placeholder="MÉ™blÉ™ÄŸ" disabled>
                    <button class="btn btn-raise" id="raiseBtn" onclick="playerAction('raise')" disabled>RAISE</button>
                </div>
                <button class="btn" id="reBuyBtn" onclick="reBuy()"
                    style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: #fff; display: none;">
                    ğŸ’° RE-BUY
                </button>
                <button class="btn btn-allin" id="allinBtn" onclick="playerAction('allin')" disabled>ALL-IN</button>
                <button class="btn" style="background: #6b7280; color: #fff;" onclick="leaveRoom()">âŒ Ã‡Ä±x</button>
            </div>
        </div>
    </div>

    <script>

         let currentUserToken = null;
    let currentUserData = null;

    console.log('â™  [POKER] Script yÃ¼klÉ™ndi');

    window.addEventListener('message', (event) => {
        console.log('ğŸ“¨ [POKER] Message alÄ±ndÄ±:', event.data);

        if (event.data && event.data.type === 'INIT_USER') {
            console.log('âœ… [POKER] INIT_USER qÉ™bul edildi');
            
            currentUserData = event.data.payload;
            currentUserToken = currentUserData.token;

            console.log('ğŸ‘¤ [POKER] User:', currentUserData.username);
            console.log('ğŸ« [POKER] Token:', currentUserToken ? 'VAR' : 'YOX');

            // UI-Ä± yenilÉ™
            document.getElementById('userName').textContent = currentUserData.username;
            document.getElementById('userBalance').textContent = currentUserData.balance.toFixed(2);

            console.log('ğŸš€ [POKER] initializeSignalR() Ã§aÄŸÄ±rÄ±lÄ±r...');
            // SignalR baÅŸlat
            initializeSignalR();
        }
    });

    // ============================================
    // getToken funksiyasÄ±nÄ± dÉ™yiÅŸdir
    // ============================================
    function getToken() {
        return currentUserToken || "";
    }

    // ============================================
    // Qalan kod eyni qalÄ±r
    // ============================================
    
    let connection = null;
    let currentUserId = 0;
    let currentRoomId = null;
    let myHoleCards = [];
    let currentPlayerName = '';

    // âŒ document.addEventListener('DOMContentLoaded') SÄ°L vÉ™ ya dÉ™yiÅŸdir
    // document.addEventListener('DOMContentLoaded', async () => {
    //     await initializeSignalR();
    // });

    // âœ… SadÉ™cÉ™ DOMContentLoaded-Ä± qoy
    document.addEventListener('DOMContentLoaded', () => {
        console.log('ğŸ“„ [POKER] DOM loaded, waiting for user data...');
    });

    // ... qalan bÃ¼tÃ¼n kod eyni qalÄ±r (initializeSignalR vÉ™ s.) ...

    async function initializeSignalR() {
        console.log('ğŸš€ [POKER] initializeSignalR baÅŸladÄ±');
        
        if (!currentUserToken) {
            console.error('âŒ [POKER] Token yoxdur!');
            return;
        }

        try {
            console.log("ğŸ”Œ Initializing SignalR...");

            connection = new signalR.HubConnectionBuilder()
                .withUrl("/pokerhub", { accessTokenFactory: () => getToken() })
                .withAutomaticReconnect()
                .build();

            // âœ… ÆVVÆL event handler-lÉ™ri qeyd et
            setupSignalRHandlers();

            // âœ… SONRA connection baÅŸlat
            await connection.start();
            console.log("âœ… [POKER] Poker SignalR connected");

            await loadRoomList();
        } catch (error) {
            console.error("âŒ [POKER] SignalR connection error:", error);
            showMessage("BaÄŸlantÄ± xÉ™tasÄ±: " + error.message, "error");
        }
    }

    function setupSignalRHandlers() {
        console.log("ğŸ“‹ [POKER] Registering event handlers...");

        // âœ… UserData event-i SÄ°L vÉ™ ya sadÉ™lÉ™ÅŸdir
        // connection.on("UserData", (data) => {
        //     // ArtÄ±q React-dÉ™n aldÄ±q, sadÉ™cÉ™ ID-ni yenilÉ™
        //     currentUserId = data.userId;
        //     currentPlayerName = data.fullName;
        //     console.log("âœ… User data received:", data);
        // });

        connection.on("UserData", (data) => {
            // YalnÄ±z ID vÉ™ name-i yenilÉ™
            currentUserId = data.userId;
            currentPlayerName = data.fullName || currentUserData.username;
            console.log("âœ… [POKER] UserData event:", data);
        });

        // ... qalan bÃ¼tÃ¼n event handler-lÉ™r eyni qalÄ±r ...

        connection.on("BalanceUpdated", (balance) => {
            console.log("ğŸ’° Balance updated:", balance);
            document.getElementById('userBalance').textContent = balance.toFixed(2);
            document.getElementById('gameBalance').textContent = balance.toFixed(2);
        });

        // ... qalan event handler-lÉ™r eyni ...

        console.log("âœ… [POKER] All event handlers registered successfully!");
    }

    // ... qalan bÃ¼tÃ¼n funksiyalar eyni qalÄ±r (loadRoomList, joinRoom vÉ™ s.) ...

    console.log('âœ… [POKER] Script tam yÃ¼klÉ™ndi, postMessage gÃ¶zlÉ™nilir...');





        // let connection = null;
        // let currentUserId = 0;
        // let currentRoomId = null;
        // let myHoleCards = [];
        // let currentPlayerName = '';

        // document.addEventListener('DOMContentLoaded', async () => {
        //     await initializeSignalR();
        // });

        // function getToken() {
        //     const raw = document.cookie
        //         .split("; ")
        //         .find(row => row.startsWith("AuthToken="))
        //         ?.split("=")[1];
        //     return raw ? decodeURIComponent(raw).trim() : "";
        // }

        async function initializeSignalR() {
            try {
                console.log("ğŸ”Œ Initializing SignalR...");

                connection = new signalR.HubConnectionBuilder()
                    .withUrl("https://nehemiah-paginal-alan.ngrok-free.dev/pokerhub", { accessTokenFactory: () => getToken() })
                    .withAutomaticReconnect()
                    .build();

                // âœ… ÆVVÆL event handler-lÉ™ri qeyd et
                setupSignalRHandlers();

                // âœ… SONRA connection baÅŸlat
                await connection.start();
                console.log("âœ… Poker SignalR connected");

                await loadRoomList();
            } catch (error) {
                console.error("âŒ SignalR connection error:", error);
                showMessage("BaÄŸlantÄ± xÉ™tasÄ±: " + error.message, "error");
            }
        }

        function setupSignalRHandlers() {
            console.log("ğŸ“‹ Registering event handlers...");

            connection.on("UserData", (data) => {
                currentUserId = data.userId;
                currentPlayerName = data.fullName;
                document.getElementById('userName').textContent = data.fullName;
                document.getElementById('userBalance').textContent = data.balance.toFixed(2);
                console.log("âœ… User data received:", data);
            });

            connection.on("BalanceUpdated", (balance) => {
                console.log("ğŸ’° Balance updated:", balance);
                document.getElementById('userBalance').textContent = balance.toFixed(2);
                document.getElementById('gameBalance').textContent = balance.toFixed(2);
            });

            connection.on("JoinedRoom", (data) => {
                currentRoomId = data.roomId;
                document.getElementById('currentRoomName').textContent = data.roomName;
                document.getElementById('gameBalance').textContent = data.balance.toFixed(2);
                document.getElementById('playerChips').textContent = data.chips.toFixed(2);

                document.getElementById('roomListSection').style.display = 'none';
                document.getElementById('gameSection').classList.add('active');
                showMessage("OtaÄŸa qoÅŸuldunuz!", "success");
            });

            connection.on("JoinError", (message) => {
                showMessage(message, "error");
            });

            connection.on("PlayerJoined", (playerName) => {
                showMessage(playerName + " otaÄŸa qoÅŸuldu", "info");
            });

            connection.on("PlayerLeft", (playerName) => {
                showMessage(playerName + " otaqdan Ã§Ä±xdÄ±", "info");
            });

            connection.on("GameStarted", () => {
                console.log("ğŸ® Game started!");
                showMessage("ğŸ® Oyun baÅŸladÄ±!", "success");
                document.getElementById('startGameBtn').style.display = 'none';
            });
            connection.on("ShowReBuyOption", () => {
                console.log("ğŸ’° ShowReBuyOption event received");
                const reBuyBtn = document.getElementById('reBuyBtn');
                if (reBuyBtn) {
                    reBuyBtn.style.display = 'inline-block';
                    showMessage("ğŸ’° Ã‡iplÉ™riniz bitdi! Re-Buy edÉ™ bilÉ™rsiniz", "info");
                }
            });

            connection.on("ReBuySuccess", (data) => {
                console.log("âœ… Re-buy successful:", data);
                document.getElementById('userBalance').textContent = data.newBalance.toFixed(2);
                document.getElementById('gameBalance').textContent = data.newBalance.toFixed(2);
                document.getElementById('playerChips').textContent = data.newChips.toFixed(2);
                showMessage(`âœ… Re-buy uÄŸurlu! +${data.buyInAmount} AZN Ã§ip É™lavÉ™ edildi`, "success");

                // âœ… Re-buy dÃ¼ymÉ™sini GÄ°ZLÆT
                const reBuyBtn = document.getElementById('reBuyBtn');
                if (reBuyBtn) {
                    reBuyBtn.style.display = 'none';
                }
            });

            connection.on("ReBuyError", (message) => {
                showMessage(message, "error");
            });

            connection.on("PlayerReBought", (playerName) => {
                showMessage(`ğŸ’° ${playerName} re-buy etdi`, "info");
            });

            connection.on("WaitingForPlayers", (message) => {
                showMessage(message, "info");
            });



            // âœ… HOLE CARDS - ÆN VACÄ°B EVENT!
            connection.on("HoleCards", (cards) => {
                console.log("ğŸ´ğŸ´ğŸ´ =========================");
                console.log("ğŸ´ HoleCards event RECEIVED!");
                console.log("ğŸ´ Raw data:", cards);
                console.log("ğŸ´ Type:", typeof cards);
                console.log("ğŸ´ Is array?", Array.isArray(cards));
                console.log("ğŸ´ JSON:", JSON.stringify(cards));

                // Array-É™ Ã§evir
                let cardArray = [];

                if (Array.isArray(cards)) {
                    cardArray = cards;
                } else if (cards && typeof cards === 'object') {
                    cardArray = Object.values(cards);
                } else if (typeof cards === 'string') {
                    cardArray = [cards];
                }

                console.log("ğŸ´ Converted array:", cardArray);
                console.log("ğŸ´ Array length:", cardArray.length);

                if (cardArray && cardArray.length >= 2) {
                    myHoleCards = cardArray;
                    console.log("âœ… myHoleCards SET:", myHoleCards);

                    // DÆRHAL gÃ¶stÉ™r
                    displayHoleCards();

                    showMessage("ğŸ´ KartlarÄ±nÄ±z gÉ™ldi!", "success");
                } else {
                    console.error("âŒ Invalid cards array:", cardArray);
                }
                console.log("ğŸ´ =========================");
            });

            connection.on("GameState", (state) => {
                console.log("ğŸ® Game state updated:", state);
                updateGameState(state);
            });

            connection.on("StreetAdvanced", (data) => {
                showMessage(`ğŸ“¢ ${data.street.toUpperCase()}`, "info");
                displayCommunityCards(data.communityCards);
            });

            connection.on("PlayerActioned", (data) => {
                const actionText = data.action.toUpperCase();
                const amountText = data.amount ? ` (${data.amount})` : '';
                showMessage(`${data.playerName}: ${actionText}${amountText}`, "info");
            });

            connection.on("GameOver", (data) => {
                showMessage(`ğŸ† ${data.winner} qalib oldu!\n${data.handName}\n+${data.amount.toFixed(2)} AZN\nKomissiya: ${data.commission.toFixed(2)} AZN`, "success");
                setTimeout(() => createConfetti(), 500);
                disableActionButtons();
            });

            connection.on("HandReset", () => {
                resetGameUI();
                showMessage("Yeni É™l Ã¼Ã§Ã¼n hazÄ±rdÄ±r", "info");
            });

            connection.on("LeftRoom", () => {
                document.getElementById('gameSection').classList.remove('active');
                document.getElementById('roomListSection').style.display = 'block';
                currentRoomId = null;
                resetGameUI();
                loadRoomList();
            });

            connection.on("QuickMessage", (data) => {
                if (data.senderName !== currentPlayerName) {
                    showChatNotification(data);
                }
            });

            connection.on("Error", (msg) => showMessage(msg, "error"));
            connection.on("GameError", (msg) => showMessage(msg, "error"));
            connection.on("ActionError", (msg) => showMessage(msg, "error"));

            console.log("âœ… All event handlers registered successfully!");
        }

        async function loadRoomList() {
            try {
                const rooms = await connection.invoke("GetRoomList");
                displayRoomList(rooms);
            } catch (error) {
                console.error("Room list error:", error);
            }
        }

        function displayRoomList(rooms) {
            const grid = document.getElementById('roomGrid');

            if (!rooms || rooms.length === 0) {
                grid.innerHTML = '<div style="text-align: center; padding: 40px;">HazÄ±rda aktiv otaq yoxdur</div>';
                return;
            }

            grid.innerHTML = rooms.map(room => `
                            <div class="room-card" onclick="joinRoom('${room.roomId}')">
                                <h3>${room.roomName}</h3>
                                <div style="margin: 10px 0;">
                                    <div>ğŸ‘¥ OyunÃ§ular: ${room.playerCount}/${room.maxPlayers}</div>
                                    <div>ğŸ’° Buy-in: ${room.buyIn} AZN</div>
                                    <div>ğŸ² Blinds: ${room.smallBlind}/${room.bigBlind}</div>
                                    <div>ğŸ“ ${room.isGameActive ? 'ğŸ® Oyun davam edir' : 'âœ… GÃ¶zlÉ™yir'}</div>
                                </div>
                                <button class="join-btn" onclick="event.stopPropagation(); joinRoom('${room.roomId}')">ğŸ¯ QoÅŸul</button>
                            </div>
                        `).join('');
        }

        async function joinRoom(roomId) {
            try {
                console.log("ğŸšª Joining room:", roomId);
                await connection.invoke("JoinRoom", roomId);
            } catch (error) {
                showMessage("OtaÄŸa qoÅŸula bilmÉ™diniz: " + error.message, "error");
            }
        }

        async function leaveRoom() {
            if (!confirm("Otaqdan Ã§Ä±xmaq istÉ™diyinizÉ™ É™minsiniz?")) return;
            try {
                await connection.invoke("LeaveRoom");
            } catch (error) {
                showMessage("XÉ™ta baÅŸ verdi", "error");
            }
        }

        async function startGame() {
            try {
                await connection.invoke("StartGame");
            } catch (error) {
                showMessage("Oyunu baÅŸlatmaq alÄ±nmadÄ±: " + error.message, "error");
            }
        }

        async function playerAction(action) {
            let amount = null;

            if (action === 'raise') {
                amount = parseFloat(document.getElementById('raiseInput').value);
                if (!amount || amount <= 0) {
                    showMessage("MÉ™blÉ™ÄŸ daxil edin", "error");
                    return;
                }
            }

            try {
                await connection.invoke("PlayerAction", action, amount);
                if (action === 'raise') {
                    document.getElementById('raiseInput').value = '';
                }
            } catch (error) {
                showMessage("XÉ™ta: " + error.message, "error");
            }
        }

        function showQuickChatMenu(playerName, playerElement) {
            document.querySelectorAll('.quick-chat-menu').forEach(m => m.remove());

            const menu = document.createElement('div');
            menu.className = 'quick-chat-menu active';
            menu.innerHTML = `
                            <div class="quick-chat-section">
                                <h4>ğŸ˜Š Emoji</h4>
                                <button class="quick-chat-btn" onclick="sendQuickChat('ğŸ˜€', '${playerName}')">ğŸ˜€</button>
                                <button class="quick-chat-btn" onclick="sendQuickChat('ğŸ˜', '${playerName}')">ğŸ˜</button>
                                <button class="quick-chat-btn" onclick="sendQuickChat('ğŸ˜‚', '${playerName}')">ğŸ˜‚</button>
                                <button class="quick-chat-btn" onclick="sendQuickChat('ğŸ¤”', '${playerName}')">ğŸ¤”</button>
                                <button class="quick-chat-btn" onclick="sendQuickChat('ğŸ˜±', '${playerName}')">ğŸ˜±</button>
                                <button class="quick-chat-btn" onclick="sendQuickChat('ğŸ”¥', '${playerName}')">ğŸ”¥</button>
                                <button class="quick-chat-btn" onclick="sendQuickChat('ğŸ‘', '${playerName}')">ğŸ‘</button>
                                <button class="quick-chat-btn" onclick="sendQuickChat('ğŸ’ª', '${playerName}')">ğŸ’ª</button>
                            </div>
                            <div class="quick-chat-section">
                                <h4>ğŸ’¬ Mesajlar</h4>
                                <button class="quick-msg-btn" onclick="sendQuickChat('YaxÅŸÄ± oynayÄ±rsan!', '${playerName}')">YaxÅŸÄ± oynayÄ±rsan!</button>
                                <button class="quick-msg-btn" onclick="sendQuickChat('UÄŸurlar!', '${playerName}')">UÄŸurlar!</button>
                                <button class="quick-msg-btn" onclick="sendQuickChat('MaraqlÄ± É™l idi!', '${playerName}')">MaraqlÄ± É™l idi!</button>
                                <button class="quick-msg-btn" onclick="sendQuickChat('GÃ¼clÃ¼ oyun!', '${playerName}')">GÃ¼clÃ¼ oyun!</button>
                                <button class="quick-msg-btn" onclick="sendQuickChat('TÉ™briklÉ™r!', '${playerName}')">TÉ™briklÉ™r!</button>
                            </div>
                        `;

            playerElement.appendChild(menu);

            setTimeout(() => {
                document.addEventListener('click', function closeMenu(e) {
                    if (!menu.contains(e.target) && !playerElement.contains(e.target)) {
                        menu.remove();
                        document.removeEventListener('click', closeMenu);
                    }
                }, { once: false });
            }, 100);
        }

        async function sendQuickChat(message, targetPlayer = '') {
            try {
                await connection.invoke("SendQuickMessage", message, targetPlayer);
                showMessage(`Mesaj gÃ¶ndÉ™rildi: ${message}`, "success");
            } catch (error) {
                console.error("Quick chat error:", error);
            }
        }

        function showChatNotification(data) {
            const notification = document.createElement('div');
            notification.className = 'chat-notification';
            notification.innerHTML = `
                            <div class="sender">${data.senderName}</div>
                            <div class="content">${data.messageType}</div>
                        `;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideInRight 0.3s ease-out reverse';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function displayHoleCards() {
            const container = document.getElementById('handCards');

            console.log("ğŸ¨ displayHoleCards called");
            console.log("ğŸ¨ myHoleCards:", myHoleCards);
            console.log("ğŸ¨ myHoleCards length:", myHoleCards ? myHoleCards.length : 'null');

            if (!myHoleCards || myHoleCards.length === 0) {
                container.innerHTML = '<div style="color: #ffd700; text-align: center; width: 100%;">KartlarÄ±nÄ±zÄ± gÃ¶zlÉ™yin...</div>';
                console.log("âš ï¸ No hole cards to display");
                return;
            }

            console.log("âœ… Displaying", myHoleCards.length, "hole cards");

            const cardsHtml = myHoleCards.map((card, index) => {
                console.log(`  ğŸ´ Card ${index}:`, card);
                const isRed = card.includes('â™¥') || card.includes('â™¦');
                const rank = card.slice(0, -1);
                const suit = card.slice(-1);
                return `
                                <div class="card ${isRed ? 'red' : 'black'}">
                                    <div class="card-rank">${rank}</div>
                                    <div class="card-suit">${suit}</div>
                                </div>
                            `;
            }).join('');

            container.innerHTML = cardsHtml;
            console.log("âœ… Cards HTML updated in container");
        }

        function displayCommunityCards(cards) {
            const container = document.getElementById('communityCards');
            if (!cards || cards.length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = cards.map(card => {
                const isRed = card.includes('â™¥') || card.includes('â™¦');
                const rank = card.slice(0, -1);
                const suit = card.slice(-1);
                return `
                                <div class="mini-card ${isRed ? 'red' : 'black'}">
                                    <div style="font-size: 1.2rem;">${rank}</div>
                                    <div style="font-size: 1.5rem;">${suit}</div>
                                </div>
                            `;
            }).join('');
        }
        async function reBuy() {
            if (!confirm("Re-buy etmÉ™k istÉ™diyinizÉ™ É™minsiniz?")) return;

            try {
                await connection.invoke("ReBuy");
            } catch (error) {
                showMessage("Re-buy xÉ™tasÄ±: " + error.message, "error");
            }
        }

        function updateGameState(state) {
            if (!state) return;

            console.log("ğŸ”„ Updating game state:", state);

            document.getElementById('potAmount').textContent = (state.pot || 0).toFixed(0);
            document.getElementById('currentBet').textContent = (state.currentBet || 0).toFixed(0);

            if (state.communityCards) {
                displayCommunityCards(state.communityCards);
            }

            if (state.players) {
                updatePlayersOnTable(state.players, state.dealerIndex || 0);
            }

            const myPlayer = state.players ? state.players.find(p => p.name === currentPlayerName) : null;

            if (!myPlayer) {
                console.log("âš ï¸ My player not found in state");
                return;
            }

            document.getElementById('playerChips').textContent = myPlayer.chips.toFixed(0);

            const reBuyBtn = document.getElementById('reBuyBtn');
            if (myPlayer.chips <= 0) {
                reBuyBtn.style.display = 'inline-block';
            } else {
                reBuyBtn.style.display = 'none';
            }

            // âœ… NeÃ§É™ aktiv oyunÃ§u var?
            const activePlayers = state.players.filter(p => p.isInHand && !p.hasFolded);
            const isLastPlayer = activePlayers.length === 1 && activePlayers[0].name === currentPlayerName;

            const isMyTurn = myPlayer.isActive && myPlayer.isInHand && !myPlayer.hasFolded;
            const needToCall = state.currentBet > myPlayer.currentBet;

            // âœ… Fold dÃ¼ymÉ™sini blokla É™gÉ™r tÉ™k oyunÃ§udursa
            document.getElementById('foldBtn').disabled = !isMyTurn || isLastPlayer;
            document.getElementById('callBtn').disabled = !isMyTurn || !needToCall;
            document.getElementById('checkBtn').disabled = !isMyTurn || needToCall;
            document.getElementById('raiseBtn').disabled = !isMyTurn;
            document.getElementById('raiseInput').disabled = !isMyTurn;
            document.getElementById('allinBtn').disabled = !isMyTurn;

            // âœ… ÆgÉ™r tÉ™k oyunÃ§udursa mesaj gÃ¶stÉ™r
            if (isLastPlayer && isMyTurn) {
                showMessage("ğŸ† Siz tÉ™k oyunÃ§usunuz - artÄ±q qalibisiniz!", "success");
            }

            console.log("ğŸ® Action buttons updated:", {
                isMyTurn,
                needToCall,
                isLastPlayer,
                activePlayers: activePlayers.length
            });
        }

        function updatePlayersOnTable(players, dealerIndex) {
            const table = document.getElementById('pokerTable');
            const positions = ['bottom', 'left', 'top-left', 'top', 'top-right', 'right', 'bottom-right', 'bottom-left'];

            const existingSpots = table.querySelectorAll('.player-spot');
            existingSpots.forEach(spot => spot.remove());

            if (!players || players.length === 0) return;

            players.forEach((player, index) => {
                if (index >= positions.length) return;

                const spot = document.createElement('div');
                spot.className = `player-spot ${positions[index]}`;

                const isDealer = index === dealerIndex;
                const activeClass = player.isActive && !player.hasFolded ? 'active' : '';
                const foldedClass = player.hasFolded ? 'folded' : '';

                spot.innerHTML = `
                                <div class="player-avatar ${foldedClass} ${activeClass}"
                                     onclick="showQuickChatMenu('${player.name}', this.parentElement)">
                                    ${player.name ? player.name.charAt(0).toUpperCase() : '?'}
                                </div>
                                <div class="player-name">${isDealer ? 'ğŸ”µ ' : ''}${player.name || 'BoÅŸ'}</div>
                                <div class="player-chips">${(player.chips || 0).toFixed(0)} chips</div>
                                ${player.currentBet > 0 ? `<div style="color: #ffd700; font-size: 0.8rem;">MÉ™rc: ${player.currentBet.toFixed(0)}</div>` : ''}
                                ${player.hasFolded ? '<div style="color: #dc2626; font-size: 0.8rem; margin-top: 3px;">FOLD</div>' : ''}
                            `;

                table.appendChild(spot);
            });
        }

        function disableActionButtons() {
            document.getElementById('foldBtn').disabled = true;
            document.getElementById('callBtn').disabled = true;
            document.getElementById('checkBtn').disabled = true;
            document.getElementById('raiseBtn').disabled = true;
            document.getElementById('raiseInput').disabled = true;
            document.getElementById('allinBtn').disabled = true;
        }

        function resetGameUI() {
            console.log("ğŸ”„ resetGameUI called - clearing cards");
            myHoleCards = [];
            document.getElementById('handCards').innerHTML = '<div style="color: #ffd700; text-align: center; width: 100%;">KartlarÄ±nÄ±zÄ± gÃ¶zlÉ™yin...</div>';
            document.getElementById('communityCards').innerHTML = '';
            document.getElementById('potAmount').textContent = '0';
            document.getElementById('currentBet').textContent = '0';
            disableActionButtons();
            console.log("âœ… Game UI reset complete");
        }

        function createConfetti() {
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + '%';
                    confetti.style.background = ['#ffd700', '#4ade80', '#3b82f6', '#f59e0b'][Math.floor(Math.random() * 4)];
                    confetti.style.animationDelay = Math.random() * 0.5 + 's';
                    document.body.appendChild(confetti);
                    setTimeout(() => confetti.remove(), 3000);
                }, i * 30);
            }
        }

        function showMessage(text, type = 'info') {
            const existing = document.querySelectorAll('.message');
            existing.forEach(msg => msg.remove());

            const message = document.createElement('div');
            message.className = `message ${type}`;
            message.textContent = text;
            document.body.appendChild(message);

            setTimeout(() => {
                message.style.animation = 'slideInRight 0.3s ease-out reverse';
                setTimeout(() => message.remove(), 300);
            }, 4000);
        }

        window.addEventListener('beforeunload', async () => {
            if (currentRoomId && connection) {
                try {
                    await connection.invoke("LeaveRoom");
                } catch (error) {
                    console.error("Error leaving room on unload:", error);
                }
            }
        });

        setInterval(() => {
            if (!currentRoomId && document.getElementById('roomListSection').style.display !== 'none') {
                loadRoomList();
            }
        }, 10000);
    </script>
</body>

</html>